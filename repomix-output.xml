This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/workflows/ci.yml
.github/workflows/deploy-staging.yml
.github/workflows/deploy.yml
.gitignore
mysite/booking/__init__.py
mysite/booking/admin.py
mysite/booking/apps.py
mysite/booking/migrations/__init__.py
mysite/booking/models.py
mysite/booking/templates/booking/booking.html
mysite/booking/tests.py
mysite/booking/urls.py
mysite/booking/views.py
mysite/manage.py
mysite/masters/photo_2025-08-21_16-17-56.jpg
mysite/media/masters/photo_2025-08-21_16-17-56.jpg
mysite/mysite/__init__.py
mysite/mysite/asgi.py
mysite/mysite/settings/__init__.py
mysite/mysite/settings/base.py
mysite/mysite/settings/dev.py
mysite/mysite/settings/production.py
mysite/mysite/urls.py
mysite/mysite/wsgi.py
mysite/requirements.txt
mysite/services_app/__init__.py
mysite/services_app/admin.py
mysite/services_app/apps.py
mysite/services_app/forms.py
mysite/services_app/migrations/__init__.py
mysite/services_app/migrations/0001_initial.py
mysite/services_app/migrations/0002_bundle_faq_servicecategory_sitesettings_and_more.py
mysite/services_app/migrations/0003_alter_bundle_options_alter_faq_options_and_more.py
mysite/services_app/migrations/0004_alter_service_short.py
mysite/services_app/migrations/0005_alter_servicecategory_options_servicecategory_order.py
mysite/services_app/migrations/0006_alter_service_duration_alter_service_duration_min_and_more.py
mysite/services_app/migrations/0007_migrate_service_to_options.py
mysite/services_app/migrations/0008_alter_serviceoption_options_and_more.py
mysite/services_app/migrations/0009_alter_faq_options_alter_master_options_faq_category_and_more.py
mysite/services_app/migrations/0010_service_is_popular_and_more.py
mysite/services_app/migrations/0011_bundleitem_gap_after_min_bundleitem_parallel_group.py
mysite/services_app/migrations/0012_remove_bundle_services_remove_bundleitem_service_and_more.py
mysite/services_app/migrations/0013_promotion.py
mysite/services_app/migrations/0014_bundle_is_popular_servicepackage_is_popular_and_more.py
mysite/services_app/migrations/0015_sitesettings_yclients_company_id.py
mysite/services_app/migrations/0016_serviceoption_yclients_service_id.py
mysite/services_app/models.py
mysite/services_app/signals.py
mysite/services_app/templates/admin/services_app/service/change_list.html
mysite/services_app/templates/admin/services_app/service/import_form.html
mysite/services_app/templatetags/__init__.py
mysite/services_app/templatetags/service_extras.py
mysite/services_app/tests.py
mysite/services_app/views.py
mysite/tests/__init__.py
mysite/tests/test_admin.py
mysite/tests/test_db_user.py
mysite/tests/test_healthz.py
mysite/tests/test_migrations_clean.py
mysite/website/__init__.py
mysite/website/admin.py
mysite/website/apps.py
mysite/website/migrations/__init__.py
mysite/website/models.py
mysite/website/templates/website/_services.html
mysite/website/templates/website/base.html
mysite/website/templates/website/book_service_preview.html
mysite/website/templates/website/bundles.html
mysite/website/templates/website/contacts.html
mysite/website/templates/website/home.html
mysite/website/templates/website/masters.html
mysite/website/templates/website/promotions.html
mysite/website/templates/website/services.html
mysite/website/tests.py
mysite/website/urls.py
mysite/website/views.py
pytest.ini
README.md
requirements.txt
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="mysite/booking/admin.py">
from django.contrib import admin

# Register your models here.
</file>

<file path="mysite/booking/apps.py">
from django.apps import AppConfig


class BookingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'booking'
</file>

<file path="mysite/booking/models.py">
from django.db import models

# Create your models here.
</file>

<file path="mysite/booking/templates/booking/booking.html">
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Бронирование</title>
  </head>
  <body>
    <h1>Страница бронирования</h1>
    <a href="/">На главную</a>
  </body>
</html>
</file>

<file path="mysite/booking/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="mysite/booking/urls.py">
from django.urls import path
from . import views

app_name = 'booking'

urlpatterns = [
    path('', views.booking, name='booking'),  # Changed to handle empty path
]
</file>

<file path="mysite/booking/views.py">
from django.shortcuts import render

def booking(request):
    context = {}
    return render(request, 'booking/booking.html', context)
</file>

<file path="mysite/manage.py">
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mysite.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
</file>

<file path="mysite/mysite/asgi.py">
"""
ASGI config for mysite project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mysite.settings')

application = get_asgi_application()
</file>

<file path="mysite/mysite/settings/__init__.py">
# По умолчанию используем dev, если переменная не задана
import os as _os

_profile = _os.getenv("DJANGO_SETTINGS_MODULE_DEFAULT", "mysite.settings.dev")

if _profile.endswith(".dev"):
    from .dev import *     # noqa
elif _profile.endswith(".production"):
    from .production import *  # noqa
else:
    # fallback на dev
    from .dev import *     # noqa
</file>

<file path="mysite/mysite/settings/base.py">
from pathlib import Path
import os

BASE_DIR = Path(__file__).resolve().parent.parent.parent  # .../mysite

# === ENV helpers ===
def _csv(name, default=""):
    raw = os.getenv(name, default)
    return [p.strip() for p in raw.split(",") if p.strip()]

def _bool(name, default=False):
    return os.getenv(name, str(default)).lower() in {"1","true","yes","on"}

def _scheme(origin: str) -> str:
    return origin if origin.startswith(("http://","https://")) else f"https://{origin}"

# === core ===
SECRET_KEY = os.getenv("DJANGO_SECRET_KEY", "dev-secret")  # в проде обязателен в .env
DEBUG = _bool("DJANGO_DEBUG", True)

ALLOWED_HOSTS = _csv("DJANGO_ALLOWED_HOSTS", "*" if DEBUG else "")
if not ALLOWED_HOSTS or ALLOWED_HOSTS == ["*"]:
    ALLOWED_HOSTS = ["*"] if DEBUG else ["127.0.0.1", "localhost"]

CSRF_TRUSTED_ORIGINS = [_scheme(o) for o in _csv("DJANGO_CSRF_TRUSTED_ORIGINS", "")]

INSTALLED_APPS = [
    "django.contrib.admin","django.contrib.auth","django.contrib.contenttypes",
    "django.contrib.sessions","django.contrib.messages","django.contrib.staticfiles",
    # твои приложения:
    "booking","services_app.apps.ServicesAppConfig","website",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    "django.middleware.locale.LocaleMiddleware",
    # CSP — включаем, если используешь django-csp:
    "csp.middleware.CSPMiddleware",
]

# CSP — расширенный (безопасный) вариант
CSP_DEFAULT_SRC = ("'self'",)
CSP_SCRIPT_SRC  = ("'self'", "https://w951024.yclients.com")
CSP_STYLE_SRC   = ("'self'", "'unsafe-inline'", "https:")
CSP_IMG_SRC     = ("'self'", "data:", "https:")
CSP_FONT_SRC    = ("'self'", "data:", "https:")

ROOT_URLCONF = "mysite.urls"
WSGI_APPLICATION = "mysite.wsgi.application"
ASGI_APPLICATION = "mysite.asgi.application"

TEMPLATES = [{
    "BACKEND": "django.template.backends.django.DjangoTemplates",
    "DIRS": [BASE_DIR / "templates"],
    "APP_DIRS": True,
    "OPTIONS": {"context_processors": [
        "django.template.context_processors.request",
        "django.contrib.auth.context_processors.auth",
        "django.contrib.messages.context_processors.messages",
    ]},
}]

# --- БД через ENV: SQLite по умолчанию, легко переключить на Postgres ---
DB_ENGINE = os.getenv("DB_ENGINE", "django.db.backends.sqlite3")
if "sqlite" in DB_ENGINE:
    DB_NAME = os.getenv("DB_NAME", str(BASE_DIR / "data" / "db.sqlite3"))
    DATABASES = {"default": {"ENGINE": DB_ENGINE, "NAME": DB_NAME}}
else:
    DATABASES = {"default": {
        "ENGINE": DB_ENGINE,
        "NAME": os.getenv("DB_NAME", "mysite_db"),
        "USER": os.getenv("DB_USER", "mysite_user"),
        "PASSWORD": os.getenv("DB_PASSWORD", ""),
        "HOST": os.getenv("DB_HOST", "127.0.0.1"),
        "PORT": os.getenv("DB_PORT", "5432"),
    }}

LANGUAGE_CODE = os.getenv("DJANGO_LANGUAGE_CODE", "ru")
TIME_ZONE     = os.getenv("DJANGO_TIME_ZONE", "UTC")
USE_I18N = True
USE_TZ   = True

STATIC_URL  = "/static/"
STATIC_ROOT = os.getenv("STATIC_ROOT", str(BASE_DIR / "staticfiles"))
MEDIA_URL   = "/media/"
MEDIA_ROOT  = os.getenv("MEDIA_ROOT", str(BASE_DIR / "media"))

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

LOGGING = {
    "version": 1, "disable_existing_loggers": False,
    "formatters": {"simple": {"format": "[{levelname}] {asctime} {name}: {message}", "style": "{"}},
    "handlers": {"console": {"class": "logging.StreamHandler", "formatter": "simple"}},
    "root": {"handlers": ["console"], "level": "INFO" if not DEBUG else "DEBUG"},
}
</file>

<file path="mysite/mysite/settings/dev.py">
from .base import *
from .base import _bool

DEBUG = _bool("DJANGO_DEBUG", False)  # staging обычно False
SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE    = True
</file>

<file path="mysite/mysite/settings/production.py">
from .base import *

DEBUG = False
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE    = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")
# страховка:
assert not DEBUG, "DEBUG must be False in production"
</file>

<file path="mysite/mysite/wsgi.py">
"""
WSGI config for mysite project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mysite.settings')

application = get_wsgi_application()
</file>

<file path="mysite/services_app/admin.py">
from django.contrib import admin, messages
from django.urls import path
from django.utils.html import format_html
from django.db import transaction
from decimal import Decimal, InvalidOperation
import csv, io


from .models import Service, Master, ServicePackage, ServiceCategory, Bundle, BundleItem, FAQ, SiteSettings, ServiceOption, Promotion
from .forms import ServiceCSVImportForm

@admin.register(ServiceCategory)
class ServiceCategoryAdmin(admin.ModelAdmin):
    list_display = ("id","name","description", "order")
    list_editable = ("name", "description", "order")
    search_fields = ("name",)

class ServiceOptionInline(admin.TabularInline):
    model = ServiceOption
    extra = 0
    fields = ("order", "duration_min", "unit_type", "units", "price", "price_per_unit_readonly", "is_active", "yclients_service_id")
    readonly_fields = ("price_per_unit_readonly",)
    ordering = ("order", "duration_min", "unit_type", "units")  

    def price_per_unit_readonly(self, obj):
        if not obj or not obj.units:
            return "—"
        # показываем среднюю цену за единицу (процедуру/зону/визит)
        try:
            val = (obj.price or 0) / obj.units
        except Exception:
            return "—"
        return f"{val:.0f} ₽/ед."
    price_per_unit_readonly.short_description = "Цена за единицу"

@admin.register(ServiceOption)
class ServiceOptionAdmin(admin.ModelAdmin):
    search_fields = ("name", "service__title", "yclients_service_id", "service__name")  # ищем по названию варианта и названию услуги
    list_display = ("name", "service", "price", "duration_min", "is_active", "yclients_service_id")
    list_filter = ("is_active", "service")

@admin.register(Service)
class ServiceAdmin(admin.ModelAdmin):
    list_display = ("id", "name", "short", "category", "is_active", "is_popular")
    list_filter = ("category", "is_active", "is_popular")
    search_fields = ("name",)
    inlines = [ServiceOptionInline]

    change_list_template = "admin/services_app/service/change_list.html"

    readonly_fields = ("price", "price_from", "duration", "duration_min")
    
    def get_urls(self):
        urls = super().get_urls()
        custom = [
            path("import-csv/", self.admin_site.admin_view(self.import_csv_view), name="service_import_csv"),
        ]
        return custom + urls

    def import_csv_view(self, request):
        if request.method == "POST":
            form = ServiceCSVImportForm(request.POST, request.FILES)
            if form.is_valid():
                file = request.FILES["file"]
                delimiter = form.cleaned_data["delimiter"]
                update_existing = form.cleaned_data["update_existing"]

                try:
                    data = file.read().decode("utf-8-sig")
                except UnicodeDecodeError:
                    messages.error(request, "Не удалось прочитать файл как UTF-8. Проверьте кодировку.")
                    return self._render_import_form(request, form)

                reader = csv.DictReader(io.StringIO(data), delimiter=delimiter)
                required = {"category","name","price_from","duration_min","is_active"}
                missing = required - set([h.strip() for h in reader.fieldnames or []])
                if missing:
                    messages.error(request, f"В CSV отсутствуют колонки: {', '.join(sorted(missing))}")
                    return self._render_import_form(request, form)

                created = updated = skipped = 0
                errors = []

                @transaction.atomic
                def process():
                    nonlocal created, updated, skipped
                    for row_num, row in enumerate(reader, start=2):  # с учётом заголовка
                        try:
                            cat_name = (row.get("category") or "").strip()
                            name = (row.get("name") or "").strip()
                            short = (row.get("short") or "").strip()
                            description = (row.get("description") or "").strip()
                            price_raw = (row.get("price_from") or "").strip()
                            duration_raw = (row.get("duration_min") or "").strip()
                            is_active_raw = (row.get("is_active") or "").strip()

                            if not cat_name or not name:
                                skipped += 1
                                continue

                            try:
                                price = Decimal(price_raw.replace(",", "."))
                            except (InvalidOperation, AttributeError):
                                raise ValueError(f"Некорректная цена '{price_raw}'")

                            try:
                                duration = int(duration_raw)
                                if duration <= 0:
                                    raise ValueError
                            except Exception:
                                raise ValueError(f"Некорректная длительность '{duration_raw}' (нужно целое > 0)")

                            is_active = str(is_active_raw).strip().lower() in {"1","true","да","y","yes","on"}

                            category, _ = ServiceCategory.objects.get_or_create(name=cat_name)

                            qs = Service.objects.filter(category=category, name=name)
                            if qs.exists():
                                if update_existing:
                                    svc = qs.first()
                                    svc.short = short
                                    svc.description = description
                                    svc.price_from = price
                                    svc.price = price
                                    svc.duration_min = duration
                                    svc.is_active = is_active
                                    svc.save()
                                    updated += 1
                                else:
                                    skipped += 1
                            else:
                                Service.objects.create(
                                    category=category, name=name, short=short,
                                    description=description, price_from=price, price=price,
                                    duration_min=duration, is_active=is_active
                                )
                                created += 1

                        except Exception as e:
                            errors.append(f"Строка {row_num}: {e}")

                process()

                if created: messages.success(request, f"Создано: {created}")
                if updated: messages.success(request, f"Обновлено: {updated}")
                if skipped: messages.info(request, f"Пропущено: {skipped}")
                for e in errors[:10]:
                    messages.error(request, e)
                if len(errors) > 10:
                    messages.error(request, f"И ещё ошибок: {len(errors) - 10}")

                # вернуть на список услуг
                from django.shortcuts import redirect
                return redirect("admin:services_app_service_changelist")
        else:
            form = ServiceCSVImportForm()
        return self._render_import_form(request, form)

    def _render_import_form(self, request, form):
        from django.shortcuts import render
        return render(request, "admin/services_app/service/import_form.html", {"form": form})

@admin.register(Master)
class MasterAdmin(admin.ModelAdmin):
    list_display = ("id","name","bio", "is_active")
    list_filter = ("is_active",)
    search_fields = ("bio","name")

class BundleItemInline(admin.TabularInline):
    model = BundleItem
    autocomplete_fields = ('option',)   # удобно, если вариантов много
    fields = ('option', 'quantity', 'order', 'parallel_group', 'gap_after_min')
    extra = 1

    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('option', 'option__service')

@admin.register(Bundle)
class BundleAdmin(admin.ModelAdmin):
    exclude = ("services",)

    list_display = ("id","name","is_active", "is_popular")
    list_filter = ("is_active", "is_popular")
    inlines = [BundleItemInline]


@admin.register(BundleItem)
class BundleItemAdmin(admin.ModelAdmin):
    list_display = ('bundle', 'service_name', 'option_name', 'quantity', 'order', 'parallel_group', 'gap_after_min')
    autocomplete_fields = ('option',)

    def service_name(self, obj):
        return obj.option.service if obj.option_id else '-'
    service_name.short_description = 'Услуга'

    def option_name(self, obj):
        return obj.option.name if obj.option_id else '-'
    option_name.short_description = 'Вариант'


@admin.register(FAQ)
class FAQAdmin(admin.ModelAdmin):
    list_display = ("id", "order", "category", "question", "is_active")
    list_display_links = ("question",)
    list_editable = ("order", "is_active")
    list_filter = ("category", "is_active")
    search_fields = ("question", "answer")
    ordering = ("order", "id")

@admin.register(SiteSettings)
class SiteSettingsAdmin(admin.ModelAdmin):
    list_display = ("salon_name","contact_phone","address")


@admin.register(ServicePackage)
class PackageAdmin(admin.ModelAdmin):
    list_display = ("title", "total_price", "is_popular")
    list_filter = ("is_popular",)
    filter_horizontal = ("services",)


@admin.register(Promotion)
class PromotionAdmin(admin.ModelAdmin):
    list_display = ("id", "order", "title", "is_active", "starts_at", "ends_at")
    list_editable = ("order", "is_active")
    list_filter = ("is_active",)
    search_fields = ("title", "subtitle", "description")
    filter_horizontal = ("options",)
    ordering = ("order", "-starts_at", "title")
</file>

<file path="mysite/services_app/apps.py">
from django.apps import AppConfig


class ServicesAppConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'services_app'
    verbose_name = "Сайт салона"

    def ready(self):
        import services_app.signals
</file>

<file path="mysite/services_app/forms.py">
from django import forms

class ServiceCSVImportForm(forms.Form):
    file = forms.FileField(label="CSV файл")
    update_existing = forms.BooleanField(
        required=False, initial=True,
        label="Обновлять существующие услуги (по name внутри категории)"
    )
    delimiter = forms.ChoiceField(
        choices=[(",", "Запятая ,"), (";", "Точка с запятой ;"), ("\t", "Табуляция \\t")],
        initial=",", label="Разделитель"
    )
</file>

<file path="mysite/services_app/migrations/0001_initial.py">
# Generated by Django 5.2.5 on 2025-08-28 17:07

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Service',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, verbose_name='Название услуги')),
                ('description', models.TextField(blank=True, verbose_name='Описание')),
                ('duration', models.PositiveIntegerField(default=60, verbose_name='Длительность (мин)')),
                ('price', models.DecimalField(decimal_places=2, max_digits=8, verbose_name='Цена')),
            ],
        ),
        migrations.CreateModel(
            name='Master',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=150, verbose_name='ФИО')),
                ('bio', models.TextField(blank=True, verbose_name='Описание / опыт')),
                ('photo', models.ImageField(blank=True, null=True, upload_to='masters/', verbose_name='Фото')),
                ('services', models.ManyToManyField(related_name='masters', to='services_app.service', verbose_name='Оказывает услуги')),
            ],
        ),
        migrations.CreateModel(
            name='ServicePackage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200, verbose_name='Название комплекса')),
                ('description', models.TextField(blank=True, verbose_name='Описание')),
                ('total_price', models.DecimalField(decimal_places=2, max_digits=8, verbose_name='Цена за комплекс')),
                ('services', models.ManyToManyField(related_name='packages', to='services_app.service', verbose_name='Услуги в комплексе')),
            ],
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0002_bundle_faq_servicecategory_sitesettings_and_more.py">
# Generated by Django 5.2.5 on 2025-08-29 08:10

import django.db.models.deletion
from decimal import Decimal
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Bundle',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=120)),
                ('fixed_price', models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True)),
                ('discount', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=8)),
                ('is_active', models.BooleanField(default=True, verbose_name='Активен')),
            ],
        ),
        migrations.CreateModel(
            name='FAQ',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('question', models.CharField(max_length=255, verbose_name='Вопрос')),
                ('answer', models.TextField(verbose_name='Ответ')),
            ],
        ),
        migrations.CreateModel(
            name='ServiceCategory',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True, verbose_name='Название категории')),
                ('description', models.TextField(blank=True, verbose_name='Описание категории')),
            ],
        ),
        migrations.CreateModel(
            name='SiteSettings',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('site_name', models.CharField(max_length=100, verbose_name='Название сайта')),
                ('contact_email', models.EmailField(max_length=254, verbose_name='Контактный email')),
                ('contact_phone', models.CharField(blank=True, max_length=20, verbose_name='Контактный телефон')),
                ('address', models.CharField(blank=True, max_length=255, verbose_name='Адрес')),
                ('working_hours', models.CharField(blank=True, max_length=255, verbose_name='Часы работы')),
                ('salon_name', models.CharField(max_length=100, verbose_name='Название салона')),
            ],
        ),
        migrations.AddField(
            model_name='master',
            name='is_active',
            field=models.BooleanField(default=True, verbose_name='Активен'),
        ),
        migrations.AddField(
            model_name='service',
            name='duration_min',
            field=models.PositiveIntegerField(default=60, verbose_name='Длительность (мин)'),
        ),
        migrations.AddField(
            model_name='service',
            name='is_active',
            field=models.BooleanField(default=True, verbose_name='Активна'),
        ),
        migrations.AddField(
            model_name='service',
            name='price_from',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=8, verbose_name='Цена от'),
            preserve_default=False,
        ),
        migrations.CreateModel(
            name='BundleItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('order', models.PositiveIntegerField(default=1)),
                ('bundle', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='services_app.bundle')),
                ('service', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='services_app.service')),
            ],
            options={
                'ordering': ['order'],
            },
        ),
        migrations.AddField(
            model_name='bundle',
            name='services',
            field=models.ManyToManyField(related_name='bundles', through='services_app.BundleItem', to='services_app.service'),
        ),
        migrations.AddField(
            model_name='service',
            name='category',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='services', to='services_app.servicecategory', verbose_name='Категория'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0003_alter_bundle_options_alter_faq_options_and_more.py">
# Generated by Django 5.2.5 on 2025-08-30 09:38

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0002_bundle_faq_servicecategory_sitesettings_and_more'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='bundle',
            options={'verbose_name': 'Комплекс (набор услуг)', 'verbose_name_plural': 'Комплексы (наборы услуг)'},
        ),
        migrations.AlterModelOptions(
            name='faq',
            options={'verbose_name': 'Часто задаваемый вопрос', 'verbose_name_plural': 'Часто задаваемые вопросы'},
        ),
        migrations.AlterModelOptions(
            name='master',
            options={'verbose_name': 'Мастер', 'verbose_name_plural': 'Мастера'},
        ),
        migrations.AlterModelOptions(
            name='service',
            options={'verbose_name': 'Услуга', 'verbose_name_plural': 'Услуги'},
        ),
        migrations.AlterModelOptions(
            name='servicecategory',
            options={'verbose_name': 'Категория услуг', 'verbose_name_plural': 'Категории услуг'},
        ),
        migrations.AlterModelOptions(
            name='servicepackage',
            options={'verbose_name': 'Комплекс услуг', 'verbose_name_plural': 'Комплексы услуг'},
        ),
        migrations.AlterModelOptions(
            name='sitesettings',
            options={'verbose_name': 'Настройки сайта', 'verbose_name_plural': 'Настройки сайта'},
        ),
        migrations.AddField(
            model_name='service',
            name='short',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0004_alter_service_short.py">
# Generated by Django 5.2.5 on 2025-09-10 12:49

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0003_alter_bundle_options_alter_faq_options_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='service',
            name='short',
            field=models.CharField(blank=True, max_length=100, null=True, verbose_name='Краткое название'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0005_alter_servicecategory_options_servicecategory_order.py">
# Generated by Django 5.2.5 on 2025-09-10 13:20

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0004_alter_service_short'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='servicecategory',
            options={'ordering': ['order', 'name'], 'verbose_name': 'Категория услуг', 'verbose_name_plural': 'Категории услуг'},
        ),
        migrations.AddField(
            model_name='servicecategory',
            name='order',
            field=models.PositiveIntegerField(default=0, verbose_name='Порядок'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0006_alter_service_duration_alter_service_duration_min_and_more.py">
# Generated by Django 5.2.5 on 2025-09-11 08:28

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0005_alter_servicecategory_options_servicecategory_order'),
    ]

    operations = [
        migrations.AlterField(
            model_name='service',
            name='duration',
            field=models.PositiveIntegerField(blank=True, default=60, null=True, verbose_name='Длительность (мин)'),
        ),
        migrations.AlterField(
            model_name='service',
            name='duration_min',
            field=models.PositiveIntegerField(blank=True, default=60, null=True, verbose_name='Длительность (мин)'),
        ),
        migrations.AlterField(
            model_name='service',
            name='price',
            field=models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True, verbose_name='Цена'),
        ),
        migrations.AlterField(
            model_name='service',
            name='price_from',
            field=models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True, verbose_name='Цена от'),
        ),
        migrations.CreateModel(
            name='ServiceOption',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('duration_min', models.PositiveIntegerField(verbose_name='Длительность (мин)')),
                ('price', models.DecimalField(decimal_places=2, max_digits=8, verbose_name='Цена')),
                ('is_active', models.BooleanField(default=True, verbose_name='Активна')),
                ('order', models.PositiveIntegerField(default=0, verbose_name='Порядок показа')),
                ('service', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='options', to='services_app.service', verbose_name='Услуга')),
            ],
            options={
                'verbose_name': 'Вариант услуги',
                'verbose_name_plural': 'Варианты услуги',
                'ordering': ['order', 'duration_min'],
                'unique_together': {('service', 'duration_min')},
            },
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0007_migrate_service_to_options.py">
# Generated by Django 5.2.5 on 2025-09-11 08:28

from django.db import migrations

def forward(apps, schema_editor):
    Service = apps.get_model("services_app", "Service")
    ServiceOption = apps.get_model("services_app", "ServiceOption")

    for s in Service.objects.all().iterator():
        dur = s.duration_min or s.duration or 60
        price = s.price or s.price_from or 0
        if not ServiceOption.objects.filter(service_id=s.id, duration_min=dur).exists():
            ServiceOption.objects.create(
                service_id=s.id,
                duration_min=dur,
                price=price,
                is_active=s.is_active,
            )

def backward(apps, schema_editor):
    # можно оставить пустым
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0006_alter_service_duration_alter_service_duration_min_and_more'),
    ]

    operations = [
        migrations.RunPython(forward, backward),
    ]
</file>

<file path="mysite/services_app/migrations/0008_alter_serviceoption_options_and_more.py">
# Generated by Django 5.2.5 on 2025-09-12 17:26

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0007_migrate_service_to_options'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='serviceoption',
            options={'ordering': ['order', 'duration_min', 'unit_type', 'units'], 'verbose_name': 'Вариант услуги', 'verbose_name_plural': 'Варианты услуги'},
        ),
        migrations.AlterUniqueTogether(
            name='serviceoption',
            unique_together=set(),
        ),
        migrations.AddField(
            model_name='serviceoption',
            name='unit_type',
            field=models.CharField(choices=[('session', 'процедуры'), ('zone', 'зоны'), ('visit', 'визиты')], default='session', max_length=16, verbose_name='Единица'),
        ),
        migrations.AddField(
            model_name='serviceoption',
            name='units',
            field=models.PositiveSmallIntegerField(default=1, help_text='Напр.: 5 процедур, 3 зоны, 2 визита', verbose_name='Кол-во единиц'),
        ),
        migrations.AlterField(
            model_name='serviceoption',
            name='price',
            field=models.DecimalField(decimal_places=0, help_text='Полная стоимость пакета', max_digits=8, verbose_name='Цена'),
        ),
        migrations.AlterUniqueTogether(
            name='serviceoption',
            unique_together={('service', 'duration_min', 'unit_type', 'units')},
        ),
        migrations.AddIndex(
            model_name='serviceoption',
            index=models.Index(fields=['service', 'is_active', 'order'], name='services_ap_service_6ac5b1_idx'),
        ),
        migrations.AddConstraint(
            model_name='serviceoption',
            constraint=models.CheckConstraint(condition=models.Q(('duration_min__gte', 1)), name='svcopt_duration_gte_1'),
        ),
        migrations.AddConstraint(
            model_name='serviceoption',
            constraint=models.CheckConstraint(condition=models.Q(('units__gte', 1)), name='svcopt_units_gte_1'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0009_alter_faq_options_alter_master_options_faq_category_and_more.py">
# Generated by Django 5.2.5 on 2025-09-17 13:31

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0008_alter_serviceoption_options_and_more'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='faq',
            options={'ordering': ['order', 'id'], 'verbose_name': 'Часто задаваемый вопрос', 'verbose_name_plural': 'Часто задаваемые вопросы'},
        ),
        migrations.AlterModelOptions(
            name='master',
            options={'ordering': ['-created_at'], 'verbose_name': 'Мастер', 'verbose_name_plural': 'Мастера'},
        ),
        migrations.AddField(
            model_name='faq',
            name='category',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='faqs', to='services_app.servicecategory', verbose_name='Категория'),
        ),
        migrations.AddField(
            model_name='faq',
            name='created_at',
            field=models.DateTimeField(auto_now_add=True, default=django.utils.timezone.now, verbose_name='Дата создания'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='faq',
            name='is_active',
            field=models.BooleanField(default=True, verbose_name='Активен'),
        ),
        migrations.AddField(
            model_name='faq',
            name='order',
            field=models.PositiveIntegerField(default=0, verbose_name='Порядок'),
        ),
        migrations.AddField(
            model_name='faq',
            name='updated_at',
            field=models.DateTimeField(auto_now=True, verbose_name='Дата обновления'),
        ),
        migrations.AddField(
            model_name='master',
            name='created_at',
            field=models.DateTimeField(auto_now_add=True, default=django.utils.timezone.now, verbose_name='Дата создания'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='master',
            name='email',
            field=models.EmailField(blank=True, max_length=254, null=True, verbose_name='Email'),
        ),
        migrations.AddField(
            model_name='master',
            name='experience',
            field=models.CharField(blank=True, max_length=100, null=True, verbose_name='Опыт'),
        ),
        migrations.AddField(
            model_name='master',
            name='phone',
            field=models.CharField(blank=True, max_length=20, null=True, verbose_name='Телефон'),
        ),
        migrations.AddField(
            model_name='master',
            name='rating',
            field=models.DecimalField(blank=True, decimal_places=1, max_digits=3, null=True, verbose_name='Рейтинг'),
        ),
        migrations.AddField(
            model_name='master',
            name='specialization',
            field=models.CharField(blank=True, max_length=100, null=True, verbose_name='Специализация'),
        ),
        migrations.AddField(
            model_name='master',
            name='updated_at',
            field=models.DateTimeField(auto_now=True, verbose_name='Дата обновления'),
        ),
        migrations.AddField(
            model_name='master',
            name='working_hours',
            field=models.CharField(blank=True, max_length=255, null=True, verbose_name='Часы работы'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='cancellation_policy',
            field=models.TextField(blank=True, null=True, verbose_name='Политика отмены'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='copyright',
            field=models.CharField(blank=True, max_length=100, null=True, verbose_name='Copyright'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='description',
            field=models.TextField(blank=True, null=True, verbose_name='Описание'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='google_maps_link',
            field=models.URLField(blank=True, null=True, verbose_name='Ссылка на Google Maps'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='logo',
            field=models.ImageField(blank=True, null=True, upload_to='logo/', verbose_name='Логотип'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='payment_methods',
            field=models.JSONField(blank=True, null=True, verbose_name='Методы оплаты'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='privacy_policy',
            field=models.TextField(blank=True, null=True, verbose_name='Политика конфиденциальности'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='social_media',
            field=models.JSONField(blank=True, null=True, verbose_name='Социальные сети'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='terms_of_service',
            field=models.TextField(blank=True, null=True, verbose_name='Условия использования'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='yandex_maps_link',
            field=models.URLField(blank=True, null=True, verbose_name='Ссылка на Yandex Maps'),
        ),
        migrations.AddField(
            model_name='sitesettings',
            name='yclients_link',
            field=models.URLField(blank=True, null=True, verbose_name='Ссылка на YClients'),
        ),
        migrations.AddIndex(
            model_name='faq',
            index=models.Index(fields=['is_active', 'order'], name='services_ap_is_acti_11c171_idx'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0010_service_is_popular_and_more.py">
# Generated by Django 5.2.5 on 2025-09-18 10:01

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0009_alter_faq_options_alter_master_options_faq_category_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='service',
            name='is_popular',
            field=models.BooleanField(default=False, verbose_name='Популярная'),
        ),
        migrations.AddIndex(
            model_name='service',
            index=models.Index(fields=['is_active', 'is_popular'], name='services_ap_is_acti_d6758e_idx'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0011_bundleitem_gap_after_min_bundleitem_parallel_group.py">
# Generated by Django 5.2.5 on 2025-09-19 09:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0010_service_is_popular_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='bundleitem',
            name='gap_after_min',
            field=models.PositiveIntegerField(default=0),
        ),
        migrations.AddField(
            model_name='bundleitem',
            name='parallel_group',
            field=models.PositiveIntegerField(default=1),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0012_remove_bundle_services_remove_bundleitem_service_and_more.py">
# Generated by Django 5.2.5 on 2025-09-19 10:17

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0011_bundleitem_gap_after_min_bundleitem_parallel_group'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='bundle',
            name='services',
        ),
        migrations.RemoveField(
            model_name='bundleitem',
            name='service',
        ),
        migrations.AddField(
            model_name='bundle',
            name='options',
            field=models.ManyToManyField(related_name='bundles', through='services_app.BundleItem', to='services_app.serviceoption'),
        ),
        migrations.AddField(
            model_name='bundleitem',
            name='option',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='bundle_items', to='services_app.serviceoption'),
        ),
        migrations.AddField(
            model_name='bundleitem',
            name='quantity',
            field=models.PositiveIntegerField(default=1),
        ),
        migrations.AddField(
            model_name='serviceoption',
            name='name',
            field=models.CharField(blank=True, max_length=120, null=True, verbose_name='Название варианта услуги'),
        ),
        migrations.AlterField(
            model_name='bundle',
            name='name',
            field=models.CharField(blank=True, max_length=120, null=True, verbose_name='Название комплекса'),
        ),
        migrations.AlterField(
            model_name='bundleitem',
            name='bundle',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='items', to='services_app.bundle'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0013_promotion.py">
# Generated by Django 5.2.5 on 2025-09-19 11:00

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0012_remove_bundle_services_remove_bundleitem_service_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='Promotion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200, verbose_name='Название акции')),
                ('subtitle', models.CharField(blank=True, max_length=200, verbose_name='Подзаголовок')),
                ('description', models.TextField(blank=True, verbose_name='Описание')),
                ('features', models.JSONField(blank=True, null=True, verbose_name='Особенности/преимущества')),
                ('image', models.ImageField(blank=True, null=True, upload_to='promotions/', verbose_name='Изображение')),
                ('discount_percent', models.PositiveSmallIntegerField(default=0, verbose_name='Скидка, %')),
                ('price_note', models.CharField(blank=True, max_length=200, verbose_name='Примечание по цене')),
                ('starts_at', models.DateField(blank=True, null=True, verbose_name='Начало')),
                ('ends_at', models.DateField(blank=True, null=True, verbose_name='Окончание')),
                ('is_active', models.BooleanField(default=True, verbose_name='Активна')),
                ('order', models.PositiveIntegerField(default=0, verbose_name='Порядок показа')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Дата создания')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Дата обновления')),
                ('options', models.ManyToManyField(blank=True, related_name='promotions', to='services_app.serviceoption', verbose_name='Варианты услуг')),
            ],
            options={
                'verbose_name': 'Акция',
                'verbose_name_plural': 'Акции',
                'ordering': ['order', '-starts_at', 'title'],
                'indexes': [models.Index(fields=['is_active', 'order'], name='services_ap_is_acti_1a10b6_idx')],
            },
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0014_bundle_is_popular_servicepackage_is_popular_and_more.py">
# Generated by Django 5.2.5 on 2025-09-19 13:51

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0013_promotion'),
    ]

    operations = [
        migrations.AddField(
            model_name='bundle',
            name='is_popular',
            field=models.BooleanField(default=False, verbose_name='Популярный'),
        ),
        migrations.AddField(
            model_name='servicepackage',
            name='is_popular',
            field=models.BooleanField(default=False, verbose_name='Популярный'),
        ),
        migrations.AddIndex(
            model_name='bundle',
            index=models.Index(fields=['is_active', 'is_popular'], name='services_ap_is_acti_5890e8_idx'),
        ),
        migrations.AddIndex(
            model_name='servicepackage',
            index=models.Index(fields=['is_popular'], name='services_ap_is_popu_b8ca53_idx'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0015_sitesettings_yclients_company_id.py">
# Generated by Django 5.2.5 on 2025-09-19 14:11

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0014_bundle_is_popular_servicepackage_is_popular_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='sitesettings',
            name='yclients_company_id',
            field=models.CharField(blank=True, max_length=100, null=True, verbose_name='ID компании в YClients'),
        ),
    ]
</file>

<file path="mysite/services_app/migrations/0016_serviceoption_yclients_service_id.py">
# Generated by Django 5.2.5 on 2025-09-19 14:25

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('services_app', '0015_sitesettings_yclients_company_id'),
    ]

    operations = [
        migrations.AddField(
            model_name='serviceoption',
            name='yclients_service_id',
            field=models.CharField(blank=True, max_length=50, null=True, verbose_name='ID услуги в YCLIENTS'),
        ),
    ]
</file>

<file path="mysite/services_app/templates/admin/services_app/service/change_list.html">
{% extends "admin/change_list.html" %}
{% load i18n %}

{% block object-tools-items %}
    <li>
        <a href="{% url 'admin:service_import_csv' %}" class="addlink">
            {% trans 'Import CSV' %}
        </a>
    </li>
    {{ block.super }}
{% endblock %}
</file>

<file path="mysite/services_app/templates/admin/services_app/service/import_form.html">
{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<h1>Импорт услуг из CSV</h1>
<form method="post" enctype="multipart/form-data" novalidate>
  {% csrf_token %}
  <table>
    {{ form.as_table }}
  </table>
  <p>Ожидаемые колонки: <code>category,name,short,description,price_from,duration_min,is_active</code></p>
  <input type="submit" value="Импортировать" class="default">
</form>
{% endblock %}
</file>

<file path="mysite/services_app/templatetags/service_extras.py">
from decimal import Decimal
from django import template
from django.contrib.humanize.templatetags.humanize import intcomma

register = template.Library()

# правильные формы слов для русского
FORMS = {
    "session": ("процедура", "процедуры", "процедур"),
    "zone":    ("зона", "зоны", "зон"),
    "visit":   ("визит", "визита", "визитов"),
}
DEFAULT_FORMS = ("единица", "единицы", "единиц")

def _plural_ru(n: int, forms):
    n = abs(int(n))
    if n % 10 == 1 and n % 100 != 11:
        return forms[0]
    if 2 <= n % 10 <= 4 and not 12 <= n % 100 <= 14:
        return forms[1]
    return forms[2]

def _rub(val):
    # аккуратное форматирование ₽ для int/float/Decimal
    if val is None:
        return ""
    if isinstance(val, Decimal):
        q = val.quantize(Decimal("1")) if val == val.to_integral() else val.quantize(Decimal("1.00"))
        num = intcomma(q)
    else:
        num = intcomma(val)
    return f"{num} ₽"

@register.filter
def option_label(opt):
    """Строка вида:
    '60 мин × 10 процедур — 14 000 ₽ (1 400 ₽/проц.)'
    Для единицы (units=1) покажет: '60 мин — 2 500 ₽'
    """
    if not opt:
        return ""
    forms = FORMS.get(getattr(opt, "unit_type", ""), DEFAULT_FORMS)

    base = f"{opt.duration_min} мин"
    units = getattr(opt, "units", 1) or 1

    # часть про количество единиц
    units_part = f" × {units} {_plural_ru(units, forms)}" if units > 1 else ""

    # цена итого
    price_part = _rub(getattr(opt, "price", None))

    # цена за единицу (если их >1)
    per_unit_part = ""
    if units > 1 and getattr(opt, "price", None):
        per = (opt.price / units) if units else None
        per_unit_part = f" ({_rub(per)} за {_plural_ru(1, forms)})"

    return f"{base}{units_part} — {price_part}{per_unit_part}"
</file>

<file path="mysite/services_app/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="mysite/services_app/views.py">
""" from django.shortcuts import render

from django.db.models import Prefetch
from .models import Service, ServiceOption, ServiceCategory

def services(request):
    options_qs = ServiceOption.objects.filter(is_active=True).order_by(
        "order", "duration_min", "unit_type", "units"
        )
    services_qs = Service.objects.filter(is_active=True).prefetch_related(
        Prefetch("options", queryset=options_qs)
    ).select_related("category").order_by("category__order", "name")

    categories = ServiceCategory.objects.prefetch_related(
        Prefetch("services", queryset=services_qs)
    ).order_by("order", "name")

    return render(request, "website/services.html", {"categories": categories})
 """
</file>

<file path="mysite/tests/test_admin.py">
def test_admin_login_page_accessible(client):
    resp = client.get("/admin/login/")
    # обычно 200; иногда редирект 302 на /admin/login/?next=/admin/
    assert resp.status_code in (200, 302)
</file>

<file path="mysite/tests/test_db_user.py">
import pytest
from django.contrib.auth import get_user_model

@pytest.mark.django_db
def test_create_user():
    User = get_user_model()
    u = User.objects.create_user(username="demo_user", password="pass12345")
    assert u.pk and u.is_active
</file>

<file path="mysite/tests/test_healthz.py">
import pytest

@pytest.mark.django_db
def test_healthz(client):
    resp = client.get("/healthz/")
    assert resp.status_code == 200
    assert resp.json().get("status") == "ok"
</file>

<file path="mysite/tests/test_migrations_clean.py">
import pytest
from django.core.management import call_command

@pytest.mark.django_db
def test_no_unapplied_migrations():
    # падаем, если есть неприменённые миграции
    call_command("makemigrations", "--check", "--dry-run")
</file>

<file path="mysite/website/admin.py">
from django.contrib import admin

# Register your models here.
</file>

<file path="mysite/website/apps.py">
from django.apps import AppConfig


class WebsiteConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'website'
</file>

<file path="mysite/website/models.py">
from django.db import models

# Create your models here.
</file>

<file path="mysite/website/templates/website/_services.html">
{% extends "website/base.html" %}
{% block title %}Услуги — {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1>Услуги</h1>

  {% for cat in categories %}
    <h2 style="margin-top:18px">{{ cat.name }}</h2>
    <div class="grid grid-3">
      {% for s in cat.services.all %}
        {% if s.is_active %}
        <div class="card">
          <div style="font-weight:600">{{ s.name }}</div>
          {% if s.short %}<div class="muted">{{ s.short }}</div>{% endif %}
          <div class="muted">{{ s.duration_min }} мин</div>
          <div style="margin-top:8px"><b>{{ s.price_from }} ₽</b></div>
          <p><a class="btn" href="#book">Записаться</a></p>
        </div>
        {% endif %}
      {% empty %}
        <p class="muted">В этой категории пока нет услуг</p>
      {% endfor %}
    </div>
  {% empty %}
    <p class="muted">Категории ещё не заведены</p>
  {% endfor %}
{% endblock %}
</file>

<file path="mysite/website/templates/website/base.html">
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Эстетика тела{% endblock %}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#222}
    header,footer{padding:14px 20px;background:#0f172a;color:#fff}
    header a,nav a{color:#fff;text-decoration:none;margin-right:14px}
    .container{max-width:1040px;margin:0 auto;padding:20px}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff}
    .btn{display:inline-block;background:#2563eb;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none}
    .muted{color:#6b7280;font-size:14px}
  </style>
</head>
<body>
<header>
  <nav class="container">
    <a href="{% url 'website:home' %}"><b>{{ settings.salon_name|default:'Салон' }}</b></a>
    <a href="{% url 'website:services' %}">Услуги</a>
    <a href="{% url 'website:masters' %}">Мастера</a>
    <a href="{% url 'website:promotions' %}">Акции</a>
    <a href="{% url 'website:bundles' %}">Комплексы</a>
    <a href="{% url 'website:contacts' %}">Контакты</a>
    <a class="btn" style="float:right" id="book-btn" data-booking href="#">Записаться</a>
  </nav>
</header>

<main class="container">
  {% block content %}{% endblock %}
</main>

<footer>
  <div class="container">
    {{ settings.address }} · {{ settings.phone }}
  </div>
</footer>

{# Заглушка под виджет YCLIENTS. Позже подставим реальный скрипт и companyId #}
{% if settings.yclients_company_id %}
<script>
  (function () {
    var COMPANY_ID = "{{ settings.yclients_company_id|escapejs }}";

    // 1) Подключаем JS виджета YCLIENTS
    var s = document.createElement("script");
    s.async = true;
    s.src = "https://w951024.yclients.com/widgetJS"; // замените w135 на ваш поддомен из кабинета YCLIENTS
    s.onload = function () {
      // 2) Вешаем обработчики на все элементы с data-booking
      var btns = document.querySelectorAll("[data-booking]");
      btns.forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          
          if (!(window.YC && YC.init && YC.open)) {
            alert("Виджет YCLIENTS не загрузился. Проверьте companyId и домен скрипта.");
            return;
          }

          // Инициализация виджета
          YC.init({ companyId: COMPANY_ID });

          // Собираем опции (если передали service_id, staff_id и т.п.)
          var opts = {};
          var serviceId = btn.getAttribute("data-service-id");
          var staffId = btn.getAttribute("data-staff-id");
          var bundleId = btn.getAttribute("data-bundle-id");

          if (serviceId)  opts.service_id = parseInt(serviceId, 10);
          if (staffId)    opts.staff_id   = parseInt(staffId, 10);
          // Если у вас в YCLIENTS есть сущность комплексной услуги и они принимают её id:
          if (bundleId)   opts.bundle_id  = parseInt(bundleId, 10);

          // 3) Открываем виджет
          // если опций нет — откроется общий виджет компании
          YC.open(opts);
        });
      });
    };
    document.head.appendChild(s);
  })();
</script>
{% else %}
<script>
  // Если company_id не задан — показываем заглушку
  document.addEventListener("click", function (e) {
    var t = e.target.closest("[data-booking]");
    if (t) {
      e.preventDefault();
      alert("Запись временно недоступна: не указан YCLIENTS company id в настройках сайта.");
    }
  });
</script>
{% endif %}
</body>
</html>
</file>

<file path="mysite/website/templates/website/book_service_preview.html">
<h1>Запись на услугу</h1>
<p><b>{{ option.service.name }}</b></p>
<p>Длительность: {{ option.duration_min }} мин</p>
<p>Цена: {{ option.price }} ₽</p>
</file>

<file path="mysite/website/templates/website/bundles.html">
{% extends "website/base.html" %}

{# website/templates/website/bundles.html #}
{% load service_extras humanize %}
{% block content %}
<section class="container" style="margin-top:24px">
  <h1 class="mb-6">Комплексы</h1>

  {% if bundles %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {% for ctx in bundles %}
        {% with b=ctx.bundle items=ctx.items %}
        <div class="p-5 rounded-2xl shadow bg-white" id="bundle-{{ b.id }}">
          <h2 class="text-xl font-semibold mb-1">{{ b.name }}</h2>

          <div class="text-sm text-gray-600 mb-3">
            Минимум: <b>{{ ctx.min_duration }} мин</b> •
            <b>{{ ctx.price|floatformat:0|intcomma }} ₽</b>
          </div>

          <form method="get" action="{% url 'website:services' %}" class="space-y-3"
                data-bundle data-gaps="1">
            {% for it in items %}
              <div class="border rounded p-3">

                <div class="font-medium mb-1">{% if it.option %}{{ it.option.service.name }}{% else %}Не выбрано{% endif %}</div>

                {% if it.option %}
                <div class="text-sm text-gray-700 mt-1">
                  {{ it.option|option_label }}
                </div>
                {% else %}
                    <div class="text-sm text-red-600 mt-1">
                    ⚠ Не выбран вариант для элемента (настрой в админке).
                    </div>
                {% endif %}
              </div>
            {% endfor %}

            <div class="mt-2">
                <a class="btn btn-primary" href="{% url 'website:services' %}">Записаться</a>
            </div>
          </form>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">Пока нет активных комплексов.</p>
  {% endif %}
</section>
{% endblock %}
<script>
  // Пересчёт итогов при смене любого select внутри комплекта
  function formatRub(n) {
    // простое форматирование с пробелами; можно заменить на Intl.NumberFormat
    return (Math.round(Number(n)) || 0).toLocaleString('ru-RU');
  }

  document.querySelectorAll('[data-bundle]').forEach(form => {
    const recalc = () => {
      const selects = form.querySelectorAll('[data-item]');
      // собираем по группам параллельности
      const groups = {};
      let gaps = 0;

      selects.forEach(sel => {
        const selected = sel.options[sel.selectedIndex];
        const price = Number(selected.dataset.price || 0);
        const duration = Number(selected.dataset.duration || 0);
        const group = String(sel.dataset.group || '0');
        const gap = Number(sel.dataset.gap || 0);

        groups[group] = groups[group] || {maxDuration: 0, price: 0};
        groups[group].price += price;
        groups[group].maxDuration = Math.max(groups[group].maxDuration, duration);
        gaps += gap;
      });

      let totalPrice = 0;
      let totalDuration = 0;
      Object.values(groups).forEach(g => {
        totalPrice += g.price;
        totalDuration += g.maxDuration;
      });
      totalDuration += gaps;

      form.querySelector('[data-total-price]').textContent = formatRub(totalPrice);
      form.querySelector('[data-total-duration]').textContent = totalDuration;
    };

    form.addEventListener('change', e => {
      if (e.target.matches('[data-item]')) recalc();
    });
    // начальный пересчёт
    recalc();
  });
</script>
</file>

<file path="mysite/website/templates/website/contacts.html">
{% extends "website/base.html" %}
{% block title %}Контакты — {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1>Контакты</h1>
  <div class="card">
    <p><b>Адрес:</b> {{ settings.address }}</p>
    <p><b>Телефон:</b> <a href="tel:{{ settings.phone }}">{{ settings.phone }}</a></p>
    {% if settings.work_hours %}<p><b>Режим работы:</b> {{ settings.work_hours }}</p>{% endif %}
    <p>
      <a class="btn" href="#book">Записаться</a>
      {% if settings.instagram %}<a href="{{ settings.instagram }}" style="margin-left:10px">Instagram</a>{% endif %}
      {% if settings.telegram %}<a href="{{ settings.telegram }}" style="margin-left:10px">Telegram</a>{% endif %}
    </p>
  </div>
{% endblock %}
</file>

<file path="mysite/website/templates/website/home.html">
{% extends "website/base.html" %}
{% block title %}Главная — {{ settings.salon_name }}{% endblock %}
{% block content %}
  <section class="card">
    <h1 style="margin:0 0 6px">Красота и здоровье — рядом</h1>
    <p class="muted">Массаж, уход за телом и лицом. Опытные мастера, удобная запись.</p>
    <p><a class="btn" href="#book">Записаться</a></p>
  </section>

  <section style="margin-top:24px">
    <h2>Популярные услуги</h2>
    <div class="grid grid-3">
      {% for item in top_items %}
        {% with s=item.service opts=item.options %}
        <div class="card">
          <div style="font-weight:600">{{ s.name }}</div>
          {% if opts %}
            <form action="{% url 'website:book_service' %}" method="get" style="margin-top:8px">
              <label for="opt-{{ s.id }}" class="muted">Выберите вариант:</label>
              <select id="opt-{{ s.id }}" name="service_option_id" style="display:block; width:100%; margin:6px 0 10px">
                {% for o in opts %}
                  <option value="{{ o.id }}">
                    {{ o.duration_min }} мин{% if o.units and o.units > 1 %} × {{ o.units }} {{ o.get_unit_type_display }}{% endif %} — {{ o.price|floatformat:0 }} ₽
                  </option>
                {% endfor %}
              </select>
              <button type="submit" class="btn">Записаться</button>
            </form>
          {% else %}
            <div class="muted">Нет активных вариантов</div>
            <p><a class="btn" href="{% url 'website:services' %}">Подробнее</a></p>
          {% endif %}
        </div>
        {% endwith %}
      {% empty %}
        <p class="muted">Пока нет услуг</p>
      {% endfor %}
    </div>
  </section>

  {% if promotions %}
  <section style="margin-top:24px">
    <h2>Акции</h2>
    <div class="grid grid-3">
      {% for p in promotions %}
        <div class="card">
          <div style="font-weight:600">{{ p.title }}</div>
          {% if p.subtitle %}<div class="muted">{{ p.subtitle }}</div>{% endif %}
          {% if p.discount_percent %}
            <div style="margin-top:6px"><b>Скидка: {{ p.discount_percent }}%</b></div>
          {% endif %}
          {% if p.starts_at or p.ends_at %}
            <div class="muted" style="margin-top:4px">
              {% if p.starts_at %}с {{ p.starts_at|date:"d.m.Y" }}{% endif %}
              {% if p.ends_at %} по {{ p.ends_at|date:"d.m.Y" }}{% endif %}
            </div>
          {% endif %}
          <p style="margin-top:8px"><a class="btn" href="{% url 'website:promotions' %}">Подробнее</a></p>
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% if popular_bundles %}
  <section style="margin-top:24px">
    <h2>Популярные комплексы</h2>
    <div class="grid grid-3">
      {% for b in popular_bundles %}
        <div class="card">
          <div style="font-weight:600">{{ b.name|default:"Комплекс" }}</div>
          <div class="muted">Длительность: {{ b.total_duration_min }} мин</div>
          <div style="margin-top:8px"><b>{{ b.total_price|floatformat:0 }} ₽</b></div>
          {% if b.items.all %}
            <ul class="muted" style="margin:8px 0 0 18px">
              {% for it in b.items.all|slice:':3' %}
                <li>
                  {% if it.option %}
                    {{ it.option.service.name }} — {{ it.option.duration_min }} мин{% if it.option.units and it.option.units > 1 %} × {{ it.option.units }} {{ it.option.get_unit_type_display }}{% endif %}{% if it.quantity and it.quantity > 1 %} × {{ it.quantity }}{% endif %}
                  {% else %}
                    Элемент без варианта
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
          <p style="margin-top:8px"><a class="btn" href="{% url 'website:bundles' %}">Подробнее</a></p>
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% if faq %}
  <section style="margin-top:24px">
    <h2>Частые вопросы</h2>
    <div class="grid">
      {% for f in faq %}
        <div class="card">
          <div style="font-weight:600">{{ f.question }}</div>
          <div class="muted">{{ f.answer }}</div>
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}
{% endblock %}
</file>

<file path="mysite/website/templates/website/masters.html">
{% extends "website/base.html" %}
{% load static %}

{% block title %}Мастера — {{ settings.salon_name }}{% endblock %}

{% block content %}
  <h1>Наши мастера</h1>
  <div class="grid grid-3">
    {% for m in masters %}
      <div class="card">
        {% if m.photo %}<img src="{{ m.photo.url }}" alt="{{ m.name }}" style="width:100%;border-radius:10px;margin-bottom:8px">{% endif %}
        <div style="font-weight:600">{{ m.name }}</div>
        {% if m.bio %}
          <p style="margin:12px 0 8px 0;white-space:pre-wrap">{{ m.bio }}</p>
        {% endif %}
        {% if m.specialization %}<div class="muted">{{ m.specialization }}</div>{% endif %}
        {% if m.experience %}<div class="muted">{{ m.experience }}</div>{% endif %}
        {% if m.services.all %}
          <div class="muted" style="margin-top:8px">Услуги:</div>
          <ul style="margin:6px 0 0 18px">
            {% for s in m.services.all|slice:":3" %}
              <li>{{ s.name }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <p><a class="btn" href="#book">Записаться</a></p>
      </div>
    {% empty %}
      <p class="muted">Пока нет мастеров</p>
    {% endfor %}
  </div>
{% endblock %}
</file>

<file path="mysite/website/templates/website/promotions.html">
{% extends "website/base.html" %}
{% block title %}Акции — {{ settings.salon_name }}{% endblock %}
{% block content %}
  <section>
    <h1>Акции</h1>
    <div class="grid grid-2">
      {% for p in promotions %}
        <div class="card">
          <div style="display:flex; gap:12px; align-items:flex-start">
            {% if p.image %}
              <img src="{{ p.image.url }}" alt="{{ p.title }}" style="max-width:120px; height:auto; border-radius:6px">
            {% endif %}
            <div>
              <div style="font-weight:600">{{ p.title }}</div>
              {% if p.subtitle %}<div class="muted">{{ p.subtitle }}</div>{% endif %}
              {% if p.starts_at or p.ends_at %}
                <div class="muted" style="margin-top:4px">
                  {% if p.starts_at %}с {{ p.starts_at|date:"d.m.Y" }}{% endif %}
                  {% if p.ends_at %} по {{ p.ends_at|date:"d.m.Y" }}{% endif %}
                </div>
              {% endif %}
              {% if p.discount_percent %}
                <div style="margin-top:6px"><b>Скидка: {{ p.discount_percent }}%</b></div>
              {% endif %}
              {% if p.features %}
                <ul class="muted" style="margin:8px 0 0 18px">
                  {% for f in p.features %}
                    <li>{{ f }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>

          {% if p.options.all %}
            <div style="margin-top:10px">
              <form action="{% url 'website:book_service' %}" method="get">
                <label class="muted">Вариант услуги по акции:</label>
                <select name="service_option_id" style="display:block; width:100%; margin:6px 0 10px">
                  {% for o in p.options.all %}
                    <option value="{{ o.id }}">
                      {{ o.service.name }} — {{ o.duration_min }} мин{% if o.units and o.units > 1 %} × {{ o.units }} {{ o.get_unit_type_display }}{% endif %} — {{ o.price|floatformat:0 }} ₽
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn">Записаться</button>
              </form>
            </div>
          {% endif %}

          {% if p.description %}
            <p style="margin-top:10px">{{ p.description }}</p>
          {% endif %}
          {% if p.price_note %}
            <div class="muted">{{ p.price_note }}</div>
          {% endif %}
        </div>
      {% empty %}
        <p class="muted">Пока нет активных акций</p>
      {% endfor %}
    </div>
  </section>
{% endblock %}
</file>

<file path="mysite/website/templates/website/services.html">
{% extends "website/base.html" %}
{% load service_extras humanize %}
{% block title %}Услуги — {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1 class="text-3xl font-bold mb-6">Услуги</h1>
{# website/services.html #}
{% for cat in categories %}
  <h2 class="mb-4">{{ cat.name }}</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for s in cat.services.all %}
    {% if s.is_active %}
    <div class="p-5 rounded-2xl shadow bg-white">
      <h3 class="text-lg font-semibold mb-2">{{ s.name }}</h3>
      {% if s.options.all %}
        <form method="get" action="{% url 'website:book_service' %}">
          <label class="block text-sm mb-1">Вариант</label>
          <select name="service_option_id" class="w-full border rounded px-3 py-2 mb-3">
            {% for opt in s.options.all %}
              {% if opt.is_active %}
                <option
                  value="{{ opt.id }}"
                  data-duration="{{ opt.duration_min }}"
                  data-units="{{ opt.units }}"
                  data-unit-type="{{ opt.unit_type }}"
                  data-price="{{ opt.price }}"
                >
                  {{ opt|option_label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          <a class="btn" data-booking
          {% if s.yclients_service_id %}data-service-id="{{ s.yclients_service_id }}"{% endif %}
          href="#">Записаться</a>
        </form>
      {% else %}
        <p class="text-sm text-gray-500">Нет активных вариантов</p>
      {% endif %}
      {% comment %}
      {% if s.options.all %}
        <form method="get" action="{% url 'website:book_service' %}">
          <label class="block text-sm mb-1">Длительность</label>
          <select name="service_option_id" class="w-full border rounded px-3 py-2 mb-3">
            {% for opt in s.options.all %}
              {% if opt.is_active %}
                <option value="{{ opt.id }}">{{ opt.duration_min }} мин — {{ opt.price }} ₽</option>
              {% endif %}
            {% endfor %}
          </select>
          <a class="btn" data-booking
          {% if s.yclients_service_id %}data-service-id="{{ s.yclients_service_id }}"{% endif %}
          href="#">Записаться</a>
        </form>
      {% else %}
        <p class="text-sm text-gray-500">Нет активных вариантов</p>
      {% endif %}
      {% endcomment %}
    </div>
    {% endif %}
  {% endfor %}
  </div>
{% endfor %}
{% endblock %}
</file>

<file path="mysite/website/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="mysite/website/urls.py">
from django.urls import path
from . import views

app_name = 'website'

urlpatterns = [
    path("", views.home, name="home"),
    path("services/", views.services, name="services"),
    path("promotions/", views.promotions, name="promotions"),
    path("masters/", views.masters, name="masters"),
    path("contacts/", views.contacts, name="contacts"),
    path("book/", views.book_service, name="book_service"),
    path("bundles/", views.bundles, name="bundles"),
]
</file>

<file path="mysite/website/views.py">
from django.shortcuts import render, get_object_or_404
from django.http import HttpResponse, HttpResponseBadRequest
from collections import defaultdict
from django.db.models import Prefetch

from services_app.models import SiteSettings, ServiceCategory, Service, Master, FAQ, ServiceOption, Promotion, Bundle, BundleItem

def _settings():
    return SiteSettings.objects.first()

def home(request):
    # Популярные услуги + первый активный вариант ServiceOption для каждой
    from django.db.models import Prefetch
    options_qs = ServiceOption.objects.filter(is_active=True).order_by(
        "order", "duration_min", "unit_type", "units"
    )

    services = (
        Service.objects.filter(is_active=True, is_popular=True)
        .prefetch_related(Prefetch("options", queryset=options_qs))
        .select_related("category")
    )[:6]

    top_items = []
    for svc in services:
        # все активные варианты уже отсортированы в options_qs
        opts = list(svc.options.all())
        top_items.append({"service": svc, "options": opts})

    promos = (
        Promotion.objects.filter(is_active=True)
        .order_by("order", "-starts_at", "title")[:3]
    )

    from django.db.models import Prefetch
    popular_bundles = (
        Bundle.objects.filter(is_active=True, is_popular=True)
        .prefetch_related("items", "items__option", "items__option__service")
        [:3]
    )

    ctx = {
        "settings": _settings(),
        "top_items": top_items,
        "faq": FAQ.objects.filter(is_active=True).order_by("order", "id")[:6],
        "promotions": promos,
        "popular_bundles": popular_bundles,
    }
    return render(request, "website/home.html", ctx)

def services(request):
    categories = (
        ServiceCategory.objects.prefetch_related("services")
        .all()
        .order_by("order", "name")
    )
    return render(request, "website/services.html", {
        "settings": _settings(),
        "categories": categories,
    })


def promotions(request):
    items = (
        Promotion.objects.filter(is_active=True)
        .prefetch_related("options", "options__service")
        .order_by("order", "-starts_at", "title")
    )
    return render(request, "website/promotions.html", {
        "settings": _settings(),
        "promotions": items,
    })


def masters(request):
    items = Master.objects.filter(is_active=True).prefetch_related("services").all().order_by("name")
    return render(request, "website/masters.html", {
        "settings": _settings(),
        "masters": items,
    })

def contacts(request):
    return render(request, "website/contacts.html", {
        "settings": _settings(),
    })

def book_service(request):
    option_id = request.GET.get("service_option_id")
    if not option_id:
        return HttpResponseBadRequest("service_option_id is required")

    option = get_object_or_404(ServiceOption, pk=option_id, is_active=True)
    # здесь можно сразу редиректить в модуль бронирования/yclients,
    # а пока — покажем страницу подтверждения
    return render(request, "website/book_service_preview.html", {"option": option})

def _min_option(service):
    """Возвращает самый «лёгкий» вариант (для стартового подсчёта)."""
    opts = list(service.options.all())
    return opts[0] if opts else None


def bundles(request):

    def _compute_min_totals(items):
    # сгруппируем элементы по parallel_group
        groups = defaultdict(list)
        gaps_total = 0
        for it in items:
            groups[it.parallel_group].append(it)
            gaps_total += int(it.gap_after_min or 0)

        total_price = 0
        total_duration = 0
        for items in groups.values():
            gmax = 0
            for it in items:
                opt = it.option  # ← берём ровно то, что выбрано в админке
                if not opt:
                    continue
                total_price += opt.price or 0
                gmax = max(gmax, int(opt.duration_min or 0))
            total_duration += gmax

        total_duration += gaps_total
        return total_price, total_duration


    # варианты для услуг
    opt_qs = (ServiceOption.objects
              .filter(is_active=True)
              .order_by("order", "duration_min", "unit_type", "units"))

    svc_qs = (Service.objects
              .prefetch_related(Prefetch("options", queryset=opt_qs)))

    # элементы комплексов
    items_qs = (BundleItem.objects
                .select_related("bundle", "option", "option__service")
                .prefetch_related(Prefetch("option__service", queryset=svc_qs))
                .order_by("order"))

    # сами комплексы
    bundles_qs = (Bundle.objects
                  .filter(is_active=True)
                  .prefetch_related(Prefetch("items", queryset=items_qs)))

    # подготовим удобную структуру для шаблона
    bundles = []
    for b in bundles_qs:
        # получим элементы и посчитаем «минимальные» итоги
        items = list(b.items.all())
        min_price, min_duration = _compute_min_totals(items)
        price = b.fixed_price
        # не трогаем b.items (related manager), складываем в структуру
        bundles.append({
            "bundle": b,
            "items": items,
            "min_price": min_price,
            "min_duration": min_duration,
            "price": price})
    
    return render(request, "website/bundles.html", {
        "settings": _settings(),
        "bundles": bundles,
    })
</file>

<file path="pytest.ini">
[pytest]
DJANGO_SETTINGS_MODULE = mysite.settings
pythonpath = mysite
testpaths = mysite/tests
addopts = -q
</file>

<file path="README.md">
# Beauty Salon Website

A web application for managing a beauty salon, built with Django.

## Features
- Online appointment booking
- Service catalog
- Staff management
- Client profiles
- Schedule management

## Project Structure
```
mysite/
├── manage.py
├── mysite/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── salon/
│   ├── migrations/
│   ├── static/
│   ├── templates/
│   ├── __init__.py
│   ├── admin.py
│   ├── models.py
│   ├── urls.py
│   ├── views.py
│   └── tests.py
└── requirements.txt
```

## Setup
1. Create virtual environment:
```bash
python -m venv venv
venv\Scripts\activate
```

2. Install dependencies:
```bash
pip install -r requirements.txt
```

3. Run migrations:
```bash
python manage.py migrate
```

4. Create superuser:
```bash
python manage.py createsuperuser
```

5. Run development server:
```bash
python manage.py runserver
```

## Admin Access
After creating a superuser, you can access the admin panel at:
```
http://localhost:8000/admin
```

## Testing
```bash
python manage.py test
```

## Contributing
1. Fork the repository
2. Create a new branch
3. Make your changes
4. Submit a pull request

## License
This project is licensed under the MIT License.
</file>

<file path=".gitignore">
# python / venv
__pycache__/
*.py[cod]
.venv/
env/
.env
.env.*
venv/
*.sqlite3
db.sqlite3

# django
/staticfiles/
/media/
/data/
/*.log
</file>

<file path="mysite/services_app/models.py">
from django.db import models
from django.db.models import Q 
from decimal import Decimal

class Service(models.Model):
    name = models.CharField(max_length=200, verbose_name="Название услуги")
    description = models.TextField(blank=True, verbose_name="Описание")
    is_active = models.BooleanField(default=True, verbose_name="Активна")
    is_popular = models.BooleanField(default=False, verbose_name="Популярная")
    short = models.CharField(max_length=100, blank=True, null=True, verbose_name="Краткое название") 
    category = models.ForeignKey('ServiceCategory', on_delete=models.PROTECT, related_name='services', null=True, blank=True, verbose_name="Категория")
    
    duration = models.PositiveIntegerField(default=60, verbose_name="Длительность (мин)", null=True, blank=True)  # устаревшее поле
    price = models.DecimalField(max_digits=8, decimal_places=2, verbose_name="Цена", null=True, blank=True)
    duration_min = models.PositiveIntegerField(default=60, verbose_name="Длительность (мин)", null=True, blank=True)
    price_from = models.DecimalField(max_digits=8, decimal_places=2, verbose_name="Цена от", null=True, blank=True)
    
    class Meta:
        verbose_name = "Услуга"
        verbose_name_plural = "Услуги"
        indexes = [
            models.Index(fields=["is_active", "is_popular"]),
        ]

    def __str__(self):
        return self.name
    

UNIT_CHOICES = [
    ("session", "процедуры"),  # пакет процедур
    ("zone",    "зоны"),       # пакет зон
    ("visit",   "визиты"),     # пакет визитов
]

class ServiceOption(models.Model):

    name = models.CharField(max_length=120, verbose_name="Название варианта услуги", null=True, blank=True)

    service = models.ForeignKey(
        Service, on_delete=models.CASCADE, 
        related_name="options", 
        verbose_name="Услуга"
        )
    duration_min = models.PositiveIntegerField(verbose_name="Длительность (мин)")
    unit_type = models.CharField(
        max_length=16,
        choices=UNIT_CHOICES,
        default="session",
        verbose_name="Единица",
    )
    units = models.PositiveSmallIntegerField(
        default=1,
        verbose_name="Кол-во единиц",
        help_text="Напр.: 5 процедур, 3 зоны, 2 визита",
    )
    price = models.DecimalField(
        max_digits=8, 
        decimal_places=0, 
        verbose_name="Цена",
        help_text="Полная стоимость пакета"
        )
    is_active = models.BooleanField(default=True, verbose_name="Активна")
    order = models.PositiveIntegerField(default=0, verbose_name="Порядок показа")

    yclients_service_id = models.CharField(
        max_length=50,
        blank=True,
        null=True,
        verbose_name="ID услуги в YCLIENTS"
    )

    class Meta:
        verbose_name = "Вариант услуги"
        verbose_name_plural = "Варианты услуги"
        unique_together = [("service", "duration_min", "unit_type", "units")]
        ordering = ["order", "duration_min", "unit_type", "units"]
        constraints = [
            models.CheckConstraint(
                condition=Q(duration_min__gte=1), name='svcopt_duration_gte_1'
                ),
            models.CheckConstraint(
                condition=Q(units__gte=1), name="svcopt_units_gte_1"
            )
        ]
        indexes = [
            models.Index(fields=["service", "is_active", "order"]), 
        ]

    def __str__(self):
        # Пример: "VelaShape — 60 мин × 10 процедур"
        base = f"{self.duration_min} мин"
        units_label = self.get_unit_type_display()
        suffix = f" × {self.units} {units_label}" if self.units and self.units > 1 else ""
        return f"{self.service.name} — {base}{suffix}"
    
    @property
    def price_per_session(self):
        return self.price / self.units if self.units else None

class ServiceCategory(models.Model):
    name = models.CharField(max_length=100, unique=True, verbose_name="Название категории")
    description = models.TextField(blank=True, verbose_name="Описание категории")
    order = models.PositiveIntegerField(default=0, verbose_name="Порядок")
    
    class Meta:
        ordering = ["order", "name"]
        verbose_name = "Категория услуг"
        verbose_name_plural = "Категории услуг"

    def __str__(self):
        return self.name
    
class FAQ(models.Model):
    question = models.CharField(max_length=255, verbose_name="Вопрос")
    answer = models.TextField(verbose_name="Ответ")
    order = models.PositiveIntegerField(default=0, verbose_name="Порядок")
    category = models.ForeignKey(
        ServiceCategory,
        on_delete=models.PROTECT,
        related_name="faqs",
        verbose_name="Категория",
        null=True,
        blank=True,
    )
    is_active = models.BooleanField(default=True, verbose_name="Активен")

    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Дата создания")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Дата обновления")

    class Meta:
        verbose_name = "Часто задаваемый вопрос"
        verbose_name_plural = "Часто задаваемые вопросы"
        ordering = ["order", "id"]
        indexes = [
            models.Index(fields=["is_active", "order"]),
        ]

    def __str__(self):
        return self.question    
    
class SiteSettings(models.Model):
    site_name = models.CharField(max_length=100, verbose_name="Название сайта")
    contact_email = models.EmailField(verbose_name="Контактный email")
    contact_phone = models.CharField(max_length=20, blank=True, verbose_name="Контактный телефон")
    address = models.CharField(max_length=255, blank=True, verbose_name="Адрес")
    working_hours = models.CharField(max_length=255, blank=True, verbose_name="Часы работы")
    salon_name = models.CharField(max_length=100, verbose_name="Название салона")
    logo = models.ImageField(upload_to="logo/", blank=True, null=True, verbose_name="Логотип")
    description = models.TextField(blank=True, null=True, verbose_name="Описание")
    social_media = models.JSONField(blank=True, null=True, verbose_name="Социальные сети")
    payment_methods = models.JSONField(blank=True, null=True, verbose_name="Методы оплаты")
    cancellation_policy = models.TextField(blank=True, null=True, verbose_name="Политика отмены")
    privacy_policy = models.TextField(blank=True, null=True, verbose_name="Политика конфиденциальности")
    terms_of_service = models.TextField(blank=True, null=True, verbose_name="Условия использования")
    copyright = models.CharField(max_length=100, blank=True, null=True, verbose_name="Copyright")
    google_maps_link = models.URLField(blank=True, null=True, verbose_name="Ссылка на Google Maps")
    yandex_maps_link = models.URLField(blank=True, null=True, verbose_name="Ссылка на Yandex Maps")
    yclients_link = models.URLField(blank=True, null=True, verbose_name="Ссылка на YClients")
    yclients_company_id = models.CharField(max_length=100, blank=True, null=True, verbose_name="ID компании в YClients")

    class Meta:
        verbose_name = "Настройки сайта"
        verbose_name_plural = "Настройки сайта"

    def __str__(self):
        return "Настройки сайта"

class Master(models.Model):
    name = models.CharField(max_length=150, verbose_name="ФИО")
    bio = models.TextField(blank=True, verbose_name="Описание / опыт")
    photo = models.ImageField(upload_to="masters/", blank=True, null=True, verbose_name="Фото")
    services = models.ManyToManyField(Service, related_name="masters", verbose_name="Оказывает услуги")
    is_active = models.BooleanField(default=True, verbose_name="Активен")
    specialization = models.CharField(max_length=100, blank=True, null=True, verbose_name="Специализация")
    experience = models.CharField(max_length=100, blank=True, null=True, verbose_name="Опыт")
    phone = models.CharField(max_length=20, blank=True, null=True, verbose_name="Телефон")
    email = models.EmailField(blank=True, null=True, verbose_name="Email")
    working_hours = models.CharField(max_length=255, blank=True, null=True, verbose_name="Часы работы")
    rating = models.DecimalField(max_digits=3, decimal_places=1, blank=True, null=True, verbose_name="Рейтинг")

    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Дата создания")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Дата обновления")
    
    class Meta:
        verbose_name = "Мастер"
        verbose_name_plural = "Мастера"
        ordering = ["-created_at"]

    def __str__(self):
        return self.name

class ServicePackage(models.Model):
    title = models.CharField(max_length=200, verbose_name="Название комплекса")
    description = models.TextField(blank=True, verbose_name="Описание")
    services = models.ManyToManyField(Service, related_name="packages", verbose_name="Услуги в комплексе")
    total_price = models.DecimalField(max_digits=8, decimal_places=2, verbose_name="Цена за комплекс")
    is_popular = models.BooleanField(default=False, verbose_name="Популярный")
    class Meta:
        verbose_name = "Комплекс услуг"
        verbose_name_plural = "Комплексы услуг"
        indexes = [
            models.Index(fields=["is_popular"]),
        ]

    def __str__(self):
        return self.title

class Bundle(models.Model):
    name = models.CharField(max_length=120, verbose_name="Название комплекса", null=True, blank=True)  # название комплекса (набор услуг)
    # простая логика цены: либо фиксированная, либо сумма услуг минус скидка
    fixed_price = models.DecimalField(max_digits=8, decimal_places=2, null=True, blank=True)
    discount = models.DecimalField(max_digits=8, decimal_places=2, default=Decimal("0.00"))

    # связь «многие-ко-многим» через промежуточную таблицу,
    # в которой хранится порядок услуг внутри комплекса
    options = models.ManyToManyField('ServiceOption', through='BundleItem', related_name='bundles')

    is_active = models.BooleanField(default=True, verbose_name="Активен")
    is_popular = models.BooleanField(default=False, verbose_name="Популярный")
    
    class Meta:
        verbose_name = "Комплекс (набор услуг)"
        verbose_name_plural = "Комплексы (наборы услуг)"
        indexes = [
            models.Index(fields=["is_active", "is_popular"]),
        ]

    def __str__(self):
        return self.name

    # посчитаем итоговую цену: либо fixed, либо сумма - скидка
    def total_price(self) -> Decimal:
        if self.fixed_price is not None:
            return self.fixed_price
        # суммируем цену вариантов с учётом количества
        items = self.items.select_related("option").all()
        total = Decimal("0.00")
        for it in items:
            if it.option and it.option.price is not None:
                total += Decimal(it.option.price) * it.quantity
        return max(Decimal("0.00"), total - self.discount)

    # простая длительность: сумма длительностей всех услуг
    # (без параллельности и пауз — чтобы было максимально понятно)
    def total_duration_min(self) -> int:
        # простая сумма длительностей вариантов с учётом количества
        items = self.items.select_related("option").all()
        return sum((it.option.duration_min if it.option else 0) * it.quantity for it in items)

class BundleItem(models.Model):
    bundle = models.ForeignKey(Bundle, on_delete=models.CASCADE, related_name="items")
    option = models.ForeignKey(
        ServiceOption, on_delete=models.PROTECT, related_name="bundle_items", null=True, blank=True)
    quantity = models.PositiveIntegerField(default=1)
    
    order = models.PositiveIntegerField(default=1)  # порядок в комплексе

    parallel_group = models.PositiveIntegerField(default=1)  # группа параллельности
    gap_after_min = models.PositiveIntegerField(default=0)  # пауза после услуги в минутах

    class Meta:
        ordering = ['order']


class Promotion(models.Model):
    title = models.CharField(max_length=200, verbose_name="Название акции")
    subtitle = models.CharField(max_length=200, blank=True, verbose_name="Подзаголовок")
    description = models.TextField(blank=True, verbose_name="Описание")
    features = models.JSONField(blank=True, null=True, verbose_name="Особенности/преимущества")
    image = models.ImageField(upload_to="promotions/", blank=True, null=True, verbose_name="Изображение")

    # Привязка к конкретным вариантам услуг (может быть пусто — тогда акция общая)
    options = models.ManyToManyField(
        ServiceOption, blank=True, related_name="promotions", verbose_name="Варианты услуг"
    )

    discount_percent = models.PositiveSmallIntegerField(default=0, verbose_name="Скидка, %")
    price_note = models.CharField(max_length=200, blank=True, verbose_name="Примечание по цене")

    starts_at = models.DateField(blank=True, null=True, verbose_name="Начало")
    ends_at = models.DateField(blank=True, null=True, verbose_name="Окончание")
    is_active = models.BooleanField(default=True, verbose_name="Активна")
    order = models.PositiveIntegerField(default=0, verbose_name="Порядок показа")

    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Дата создания")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Дата обновления")

    class Meta:
        verbose_name = "Акция"
        verbose_name_plural = "Акции"
        ordering = ["order", "-starts_at", "title"]
        indexes = [
            models.Index(fields=["is_active", "order"]),
        ]

    def __str__(self) -> str:
        return self.title
</file>

<file path=".github/workflows/deploy-staging.yml">
name: Deploy to Staging (SSH)

on:
  push:
    branches: [ dev ]   # триггер на пуши в dev
  workflow_dispatch: {}  # вручную тоже можно

concurrency:
  group: stg-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: staging   # используем среду staging (секреты и, при желании, approve)
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      # (необязательно) быстрые smoke-тесты, чтобы отсеять явные косяки
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Run quick tests (optional)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          python -m pip install pytest || true
          pytest -q || true

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            REPO_DIR="${{ secrets.REPO_DIR }}"
            APP_DIR="${{ secrets.APP_DIR }}"
            VENV="${{ secrets.VENV }}"
            SERVICE="${{ secrets.SERVICE_NAME }}"

            command -v git || (sudo apt-get update && sudo apt-get install -y git)

            # Тянем ветку dev
            if [ -d "$REPO_DIR/.git" ]; then
            cd "$REPO_DIR"
            git fetch --all --prune
            git reset --hard origin/dev
            else
            mkdir -p "$REPO_DIR"
            git clone --depth 1 https://github.com/${{ github.repository }} "$REPO_DIR"
            cd "$REPO_DIR"
            git checkout dev || git fetch origin dev && git checkout -b dev origin/dev
            fi

            # Активация venv и зависимости
            source "$VENV/bin/activate"
            pip install -r "$REPO_DIR/requirements.txt"

            # Сначала экспорт, потом echo (чтобы не ловить set -u на пустой переменной)
            export DJANGO_SETTINGS_MODULE="${{ secrets.DJANGO_SETTINGS_MODULE }}"

            echo "REPO_DIR=${REPO_DIR:-<unset>}"
            echo "APP_DIR=${APP_DIR:-<unset>}"
            echo "VENV=${VENV:-<unset>}"
            echo "DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE:-<unset>}"

            # Django рутины (в $APP_DIR должен лежать manage.py)
            cd "$APP_DIR"
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput
            python manage.py check --deploy || true

            # Рестарт gunicorn (sudoers уже настроен)
            sudo systemctl restart "${SERVICE:-formula_tela_staging}"

      - name: Health check
        run: curl -fsS ${{ secrets.HEALTH_URL }} -I
</file>

<file path=".github/workflows/deploy.yml">
name: Deploy to Production (SSH)

on:
  push:
    branches: [ main ]      # деплой только на коммитах в main
  workflow_dispatch: {}      # ручной запуск кнопкой

concurrency:
  group: prod-deploy
  cancel-in-progress: true   # не перекрывать деплои

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # требуем, чтобы CI-джоб из другого workflow был зеленый (по желанию)
    # strategy: можно добавить здесь “needs” к reusable workflow, но оставим просто отдельный прогон ниже
    environment:
      # включает ручной approve и подхватывает env-secrets
      name: "production"
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Quick smoke tests on CI (optional)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install & run tests (optional)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          python -m pip install pytest || true
          pytest -q || true   # не валим деплой, если тестов нет

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            REPO_DIR="${{ secrets.REPO_DIR }}"
            APP_DIR="${{ secrets.APP_DIR }}"
            VENV="${{ secrets.VENV }}"

            command -v git || (sudo apt-get update && sudo apt-get install -y git)

            if [ -d "$REPO_DIR/.git" ]; then
              cd "$REPO_DIR"
              git fetch --all
              git reset --hard origin/main
            else
              mkdir -p "$REPO_DIR"
              git clone --depth 1 https://github.com/${{ github.repository }} "$REPO_DIR"
              cd "$REPO_DIR"
            fi

            # серверное venv
            source "$VENV/bin/activate"
            pip install -r "$REPO_DIR/requirements.txt"

            # Django рутины
            export DJANGO_SETTINGS_MODULE=${{ secrets.DJANGO_SETTINGS_MODULE }}
            cd "$APP_DIR"
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput
            python manage.py check --deploy || true

            # рестарт gunicorn
            sudo systemctl restart ${SERVICE_NAME:-formula_tela}

      - name: Health check (optional)
        run: curl -fsS https://formulatela58.ru/healthz || exit 1
</file>

<file path="mysite/mysite/urls.py">
"""
URL configuration for mysite project.

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/5.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from django.http import JsonResponse

def healthz(_request):
    return JsonResponse({"status": "ok"})

urlpatterns = [
    path('admin/', admin.site.urls),
    path('booking/', include('booking.urls')),  # Added trailing slash
    path('', include('website.urls')),
    path('healthz/', healthz, name='healthz'),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
</file>

<file path=".github/workflows/ci.yml">
name: CI
on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

jobs:
  test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: mysite

    env:
      DJANGO_SETTINGS_MODULE: mysite.settings.dev
      DJANGO_SECRET_KEY: test-secret
      DJANGO_DEBUG: "True"
      DB_ENGINE: django.db.backends.sqlite3
      DB_NAME: ${{ github.workspace }}/mysite/data/test.sqlite3

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Make data dir
        run: mkdir -p data

      - name: Install deps\
        working-directory: .
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          # если используешь pytest:
          # pip install pytest pytest-django

      - name: Django checks & DB migrate
        run: |
          python manage.py check
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput

      # - name: Run tests
      #   run: pytest -q
</file>

</files>
