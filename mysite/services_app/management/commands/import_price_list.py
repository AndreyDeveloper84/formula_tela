"""
Management command: import_price_list

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —É—Å–ª—É–≥–∏ –∏–∑ xlsx-—Ñ–∞–π–ª–∞ (–≤—ã–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å.–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞)
–≤ –º–æ–¥–µ–ª–∏ ServiceCategory, Service, ServiceOption.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python manage.py import_price_list price_list.xlsx --dry-run   # –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    python manage.py import_price_list price_list.xlsx             # —Ä–µ–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç
    python manage.py import_price_list price_list.xlsx --no-photos # –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
"""
import os
import re
import tempfile
import urllib.request
from decimal import Decimal

import openpyxl
from django.core.files.base import ContentFile
from django.core.management.base import BaseCommand
from django.db import transaction

from services_app.models import Service, ServiceCategory, ServiceOption

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ú–∞–ø–ø–∏–Ω–≥ xlsx-–∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Üí –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CATEGORY_MAP = {
    # –†—É—á–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏
    "–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π":       "–†—É—á–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",
    "–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Åc–∏—á–µ—Å–∫–∏–π":       "–†—É—á–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",   # —Å –ª–∞—Ç–∏–Ω—Å–∫–æ–π 'c'

    # –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂
    "–ú–∞—Å—Å–∞–∂ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π":         "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂",

    # –ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂
    "–ú–∞—Å—Å–∞–∂ –∞–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π":    "–ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂",

    # –õ–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂–Ω—ã–π –º–∞—Å—Å–∞–∂
    "–ú–∞—Å—Å–∞–∂ –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂–Ω—ã–π":     "–õ–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂–Ω—ã–π –º–∞—Å—Å–∞–∂",

    # –ú–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω
    "–ú–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω":     "–ú–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω",

    # –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞
    "–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞":               "–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞",

    # –ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂
    "–ú–∞—Å—Å–∞–∂ –±–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π":  "–ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂",
    "–ú–∞—Å—Å–∞–∂":                    "–ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂",

    # –ö–≤–∞–Ω—Ç–æ–≤—ã–π –º–∞—Å—Å–∞–∂
    "–ö–≤–∞–Ω—Ç–æ–≤—ã–π –º–∞—Å—Å–∞–∂":          "–ö–≤–∞–Ω—Ç–æ–≤—ã–π –º–∞—Å—Å–∞–∂",

    # –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏
    "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂":                          "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",
    "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω":           "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",
    "–ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ–ª–∞":            "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",
    "–ö–∞–≤–∏—Ç–∞—Ü–∏—è":                            "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",
    "Rf-lifting":                           "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",
    "–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞ / RF - –ª–∏—Ñ—Ç–∏–Ω–≥":     "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",

    # –ú–∞—Å—Å–∞–∂–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã
    "–ú–∞—Å—Å–∞–∂–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã":       "–ú–∞—Å—Å–∞–∂–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã",

    # –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –õ–∏—Ü–æ –∏ –¢–µ–ª–æ":     "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è",
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –†—É–∫–∏ –∏ –ø–æ–¥–º—ã—à–∫–∏":  "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è",
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ë–∏–∫–∏–Ω–∏":           "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è",
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –Ø–≥–æ–¥–∏—Ü—ã":          "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è",
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ù–æ–≥–∏":             "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è",

    # –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)
    "–≠–ø–∏–ª—è—Ü–∏—è / –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è":             "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)",
    "–í—Å–µ —Ç–µ–ª–æ (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)":                "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)",
    "–ì–ª—É–±–æ–∫–æ–µ (–±–∏–∫–∏–Ω–∏+–ø–æ–¥–º—ã—à–∫–∏+–Ω–æ–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é)": "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)",
    "–ì–ª—É–±–æ–∫–æ–µ (—Ç–æ—Ç–∞–ª—å–Ω–æ–µ) –±–∏–∫–∏–Ω–∏ + –ø–æ–¥–º—ã—à–∫–∏":    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)",
    "–í—Å–µ —Ç–µ–ª–æ (–±–∏–∫–∏–Ω–∏, –ø–æ–¥–º—ã—à–∫–∏, –≥–æ–ª–µ–Ω–∏)":        "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)",
    "–í—Å–µ —Ç–µ–ª–æ (6 –∑–æ–Ω)":                          "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏",

    # –£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞
    "–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞":            "–£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞",
    "–ê–ª—å–≥–∏–Ω–∞–ª—å–Ω—ã–µ –º–∞—Å–∫–∏":           "–£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞",
    "–ö–∞—Ä–±–æ–∫–∏—Å—Ç–µ—Ä–∞–ø–∏—è –ª–∏—Ü–∞":         "–£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞",
    "–ü–∏–ª–∏–Ω–≥ –ø–æ —Ç–∏–ø—É –∫–æ–∂–∏":         "–£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞",
    "–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è (–£–ó) —á–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞": "–£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞",
}

# –ü–æ—Ä—è–¥–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ —Å–∞–π—Ç–µ
CATEGORY_ORDER = {
    "–†—É—á–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏": 1,
    "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂": 2,
    "–ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂": 3,
    "–õ–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂–Ω—ã–π –º–∞—Å—Å–∞–∂": 4,
    "–ú–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω": 5,
    "–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞": 6,
    "–ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂": 7,
    "–ö–≤–∞–Ω—Ç–æ–≤—ã–π –º–∞—Å—Å–∞–∂": 8,
    "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏": 9,
    "–ú–∞—Å—Å–∞–∂–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã": 10,
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è": 11,
    "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ)": 12,
    "–£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞": 13,
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ú–∞–ø–ø–∏–Ω–≥ xlsx ‚Üí —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ Service (–ø–æ ID)
# –ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å, –∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–ª—é—á: (xlsx_category, xlsx_name) ‚Üí service_id –≤ –±–∞–∑–µ
EXISTING_SERVICE_MAP = {
    # --- –†—É—á–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏ ---
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ü–∞—Ä–Ω–∞—è –º–∞—Å—Å–∞–∂–Ω–∞—è —É—Å–ª—É–≥–∞"): 5,
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ú–∞—Å—Å–∞–∂ –≤ 4 —Ä—É–∫–∏"): 6,
    # –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂ ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –∏–∑ xlsx (30/60/90/120 –º–∏–Ω) ‚Üí –æ–¥–∏–Ω Service id=60
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π/ –†–µ–ª–∞–∫—Å –º–∞—Å—Å–∞–∂ (30 –º–∏–Ω—É—Ç)"): 60,
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π/ –†–µ–ª–∞–∫—Å –º–∞—Å—Å–∞–∂ (60 –º–∏–Ω—É—Ç)"): 60,
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π/ –†–µ–ª–∞–∫—Å –º–∞—Å—Å–∞–∂ (90 –º–∏–Ω—É—Ç)"): 60,
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π/ –†–µ–ª–∞–∫—Å –º–∞—Å—Å–∞–∂ (120 –º–∏–Ω—É—Ç)"): 60,
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂ –∑–∞–¥–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ —Ç–µ–ª–∞ (90 –º–∏–Ω—É—Ç)"): 60,
    ("–ú–∞—Å—Å–∞–∂ –∫–ª–∞—Åc–∏—á–µ—Å–∫–∏–π", "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂ –∑–∞–¥–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ —Ç–µ–ª–∞ "): 60,

    # --- –ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π ---
    ("–ú–∞—Å—Å–∞–∂", "–ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂"): 10,
    ("–ú–∞—Å—Å–∞–∂ –±–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π", "–ë–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂ –¥–µ—Ç—Å–∫–∏–π "): 10,

    # --- –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π ---
    ("–ú–∞—Å—Å–∞–∂ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂ (90 –º–∏–Ω—É—Ç)"): 61,
    ("–ú–∞—Å—Å–∞–∂ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∞–∂ (60 –º–∏–Ω—É—Ç)"): 61,
    ("–ú–∞—Å—Å–∞–∂ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π  –º–∞—Å—Å–∞–∂ (30 –º–∏–Ω—É—Ç)"): 61,

    # --- –ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π ---
    ("–ú–∞—Å—Å–∞–∂ –∞–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π", "–ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω (60 –º–∏–Ω—É—Ç)"): 7,
    ("–ú–∞—Å—Å–∞–∂ –∞–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π", "–ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂ ‚Äî –≥–ª–∞–¥–∫–∞—è –∫–æ–∂–∞ (45 –º–∏–Ω—É—Ç)"): 7,

    # --- –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ ---
    ("–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞", "–ì–ª—É–±–æ–∫–æ–µ –æ–º–æ–ª–æ–∂–µ–Ω–∏–µ (–º–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ 75 –º–∏–Ω—É—Ç)"): 9,
    ("–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞", "–†–∏—Ç—É–∞–ª –∫—Ä–∞—Å–æ—Ç—ã ‚Äî VIP –º–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ (105 –º–∏–Ω—É—Ç —Å —É—Ö–æ–¥–æ–º)"): 9,
    ("–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞", "–≠–∫—Å–ø—Ä–µ—Å—Å-–ª–∏—Ñ—Ç–∏–Ω–≥ (–º–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ 30 –º–∏–Ω—É—Ç)"): 9,

    # --- –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ ---
    ("–ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ–ª–∞", "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂ VelaShape ‚Äî –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ñ–∏–≥—É—Ä—ã –∏ —Ç–æ–Ω—É—Å —Ç–µ–ª–∞ (60 –º–∏–Ω—É—Ç, –≤—Å—ë —Ç–µ–ª–æ)"): 14,
    ("–ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ–ª–∞", "–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –∫–∞–≤–∏—Ç–∞—Ü–∏—è ‚Äî –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∂–∏—Ä–æ–≤—ã—Ö –æ—Ç–ª–æ–∂–µ–Ω–∏–π (1 –∑–æ–Ω–∞)"): 18,
    ("–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞ / RF - –ª–∏—Ñ—Ç–∏–Ω–≥", "RF-–ª–∏—Ñ—Ç–∏–Ω–≥ –ª–∏—Ü–∞ –∏ —à–µ–∏ ‚Äî –ø–æ–¥—Ç—è–∂–∫–∞ –∏ —É–ø—Ä—É–≥–æ—Å—Ç—å –∫–æ–∂–∏"): 19,
    ("–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞ / RF - –ª–∏—Ñ—Ç–∏–Ω–≥", "RF-–ª–∏—Ñ—Ç–∏–Ω–≥ –ª–∏—Ü–∞, —à–µ–∏ –∏ –¥–µ–∫–æ–ª—å—Ç–µ ‚Äî –ø–æ–¥—Ç—è–∂–∫–∞ –∏ —É–ø—Ä—É–≥–æ—Å—Ç—å –∫–æ–∂–∏"): 20,
    ("–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞ / RF - –ª–∏—Ñ—Ç–∏–Ω–≥", "RF-–ª–∏—Ñ—Ç–∏–Ω–≥ –ª–∏—Ü–∞ ‚Äî –ø–æ–¥—Ç—è–∂–∫–∞ –∏ —É–ø—Ä—É–≥–æ—Å—Ç—å –∫–æ–∂–∏"): 19,
    ("–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω", "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –±—ë–¥–µ—Ä –∏ —è–≥–æ–¥–∏—Ü ‚Äî –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∏ –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂"): 22,
    ("–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂", "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –≤—Å–µ–≥–æ —Ç–µ–ª–∞ ‚Äî —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –∏ –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂ (60 –º–∏–Ω—É—Ç)"): 21,
    ("–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω", "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –∂–∏–≤–æ—Ç–∞ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∏ –ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂"): 24,
    ("–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω", "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ —Å–ø–∏–Ω—ã –∏ —Ä—É–∫ ‚Äî —Å–Ω—è—Ç–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ"): 23,
    ("–ö–∞–≤–∏—Ç–∞—Ü–∏—è", "–ö–∞–≤–∏—Ç–∞—Ü–∏—è (–∂–∏–≤–æ—Ç)"): 18,
    ("Rf-lifting", "RF-–ª–∏—Ñ—Ç–∏–Ω–≥ (–ª–∏—Ü–æ + —à–µ—è)"): 19,
    ("–í—Å–µ —Ç–µ–ª–æ (6 –∑–æ–Ω)", "–í–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ "): 21,
    ("–í—Å–µ —Ç–µ–ª–æ (6 –∑–æ–Ω)", "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂ Vela shape"): 14,

    # --- –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è ---
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –õ–∏—Ü–æ –∏ –¢–µ–ª–æ", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –≤—Å–µ–≥–æ —Ç–µ–ª–∞"): 32,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –õ–∏—Ü–æ –∏ –¢–µ–ª–æ", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –≤–µ—Ä—Ö–Ω–µ–π –≥—É–±—ã"): 44,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –õ–∏—Ü–æ –∏ –¢–µ–ª–æ", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –ª–∏–Ω–∏–∏ –∂–∏–≤–æ—Ç–∞"): None,  # –Ω–æ–≤–∞—è
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –†—É–∫–∏ –∏ –ø–æ–¥–º—ã—à–∫–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –ø–æ–¥–º—ã—à–µ—á–Ω—ã—Ö –≤–ø–∞–¥–∏–Ω"): 41,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –†—É–∫–∏ –∏ –ø–æ–¥–º—ã—à–∫–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è —Ä—É–∫ –¥–æ –ª–æ–∫—Ç—è"): 42,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –†—É–∫–∏ –∏ –ø–æ–¥–º—ã—à–∫–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è —Ä—É–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é"): 33,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ë–∏–∫–∏–Ω–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –±–∏–∫–∏–Ω–∏ –ø–æ –ª–∏–Ω–∏–∏ –±–µ–ª—å—è"): 40,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ë–∏–∫–∏–Ω–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –∑–æ–Ω—ã –±–∏–∫–∏–Ω–∏ —Ç–æ—Ç–∞–ª—å–Ω–æ"): 38,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ë–∏–∫–∏–Ω–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –∑–æ–Ω—ã –±–∏–∫–∏–Ω–∏ –≥–ª—É–±–æ–∫–æ–µ"): 39,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –Ø–≥–æ–¥–∏—Ü—ã", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è —è–≥–æ–¥–∏—Ü"): 37,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ù–æ–≥–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –±—ë–¥–µ—Ä (–ø–µ—Ä–µ–¥–Ω—è—è/–∑–∞–¥–Ω—è—è/–±–æ–∫–æ–≤–∞—è —á–∞—Å—Ç—å)"): None,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ù–æ–≥–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –±—ë–¥–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é"): 34,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ù–æ–≥–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –≥–æ–ª–µ–Ω–µ–π —Å –∫–æ–ª–µ–Ω—è–º–∏"): 35,
    ("–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è / –ù–æ–≥–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è –Ω–æ–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é"): None,

    # --- –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∫–æ–º–±–æ) ---
    ("–≠–ø–∏–ª—è—Ü–∏—è / –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è \"–ö–ª–∞—Å—Å–∏–∫–∞\": –≥–æ–ª–µ–Ω–∏ + –±–∏–∫–∏–Ω–∏ + –ø–æ–¥–º—ã—à–∫–∏"): 53,
    ("–≠–ø–∏–ª—è—Ü–∏—è / –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è \"Must Have\": –±–∏–∫–∏–Ω–∏ + –ø–æ–¥–º—ã—à–∫–∏"): 52,
    ("–≠–ø–∏–ª—è—Ü–∏—è / –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è \"Super\": –ø–æ–ª–Ω—ã–µ –Ω–æ–≥–∏ + –±–∏–∫–∏–Ω–∏ + –ø–æ–¥–º—ã—à–∫–∏"): 51,
    ("–í—Å–µ —Ç–µ–ª–æ (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è "): 32,
    ("–ì–ª—É–±–æ–∫–æ–µ (–±–∏–∫–∏–Ω–∏+–ø–æ–¥–º—ã—à–∫–∏+–Ω–æ–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é)", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è "): 51,
    ("–ì–ª—É–±–æ–∫–æ–µ (—Ç–æ—Ç–∞–ª—å–Ω–æ–µ) –±–∏–∫–∏–Ω–∏ + –ø–æ–¥–º—ã—à–∫–∏", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è "): 52,
    ("–í—Å–µ —Ç–µ–ª–æ (–±–∏–∫–∏–Ω–∏, –ø–æ–¥–º—ã—à–∫–∏, –≥–æ–ª–µ–Ω–∏)", "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è "): 53,

    # --- –£—Ö–æ–¥—ã –¥–ª—è –ª–∏—Ü–∞ ---
    ("–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞", "–ß–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞ + –ø–∏–ª–∏–Ω–≥ ‚Äî –≥–ª—É–±–æ–∫–æ–µ –æ—á–∏—â–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–∂–∏"): 31,
    ("–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞", "–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è —á–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞ ‚Äî –¥–µ–ª–∏–∫–∞—Ç–Ω–æ–µ –æ—á–∏—â–µ–Ω–∏–µ –∫–æ–∂–∏"): 30,
    ("–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è –ª–∏—Ü–∞", "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞ ‚Äî –≥–ª—É–±–æ–∫–æ–µ –æ—á–∏—â–µ–Ω–∏–µ –∫–æ–∂–∏"): 29,
    ("–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è (–£–ó) —á–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞", "–ß–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞ "): 30,
    ("–ü–∏–ª–∏–Ω–≥ –ø–æ —Ç–∏–ø—É –∫–æ–∂–∏", "–ü–∏–ª–∏–Ω–≥ "): 25,  # –æ–¥–∏–Ω –∏–∑ –ø–∏–ª–∏–Ω–≥–æ–≤
}

# –°—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –¥—É–±–ª—è–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
# –∏ –Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –æ–ø—Ü–∏—é (–¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ –±–∞–∑–µ)
SKIP_DUPLICATE_ROWS = {
    # –°—Ç—Ä–æ–∫–∏ 64-66, 71 ‚Äî –¥—É–±–ª–∏ –∫–æ–º–±–æ-—ç–ø–∏–ª—è—Ü–∏–π (—Ç–µ –∂–µ —É—Å–ª—É–≥–∏/—Ü–µ–Ω—ã, –¥—Ä—É–≥–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è)
    64, 65, 66, 71,
    # –°—Ç—Ä–æ–∫–∞ 47 ‚Äî –¥—É–±–ª—å –±–∏–æ—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ (–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)
    47,
    # –°—Ç—Ä–æ–∫–∞ 72 ‚Äî –¥—É–±–ª—å –≤–∏–±—Ä–æ–º–∞—Å—Å–∞–∂ –≤—Å—ë —Ç–µ–ª–æ
    72,
    # –°—Ç—Ä–æ–∫–∞ 73 ‚Äî –¥—É–±–ª—å VelaShape
    73,
    # –°—Ç—Ä–æ–∫–∞ 74 ‚Äî –¥—É–±–ª—å –∫–∞–≤–∏—Ç–∞—Ü–∏–∏
    74,
    # –°—Ç—Ä–æ–∫–∞ 75 ‚Äî –¥—É–±–ª—å RF-–ª–∏—Ñ—Ç–∏–Ω–≥
    75,
    # –°—Ç—Ä–æ–∫–∞ 70 ‚Äî –¥—É–±–ª—å –£–ó-—á–∏—Å—Ç–∫–∏
    70,
    # –°—Ç—Ä–æ–∫–∞ 69 ‚Äî –¥—É–±–ª—å –ø–∏–ª–∏–Ω–≥
    69,
}


def _extract_duration(name, qty):
    """–ò–∑–≤–ª–µ—á—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –ø–æ–ª—è qty."""
    if qty and str(qty).isdigit() and int(qty) > 0:
        return int(qty)
    m = re.search(r'(\d+)\s*–º–∏–Ω', name)
    if m:
        return int(m.group(1))
    return 60  # –¥–µ—Ñ–æ–ª—Ç


def _download_photo(url):
    """–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –ø–æ URL, –≤–µ—Ä–Ω—É—Ç—å (filename, content) –∏–ª–∏ None."""
    if not url or not url.startswith("http"):
        return None
    try:
        req = urllib.request.Request(url, headers={"User-Agent": "Mozilla/5.0"})
        with urllib.request.urlopen(req, timeout=15) as resp:
            data = resp.read()
            ext = ".jpg"
            ct = resp.headers.get("Content-Type", "")
            if "png" in ct:
                ext = ".png"
            elif "webp" in ct:
                ext = ".webp"
            fname = f"service_{os.urandom(4).hex()}{ext}"
            return fname, data
    except Exception as e:
        return None


class Command(BaseCommand):
    help = "–ò–º–ø–æ—Ä—Ç –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –∏–∑ xlsx –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"

    def add_arguments(self, parser):
        parser.add_argument("file", type=str, help="–ü—É—Ç—å –∫ xlsx-—Ñ–∞–π–ª—É")
        parser.add_argument("--dry-run", action="store_true", help="–¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å, –±–µ–∑ –∑–∞–ø–∏—Å–∏")
        parser.add_argument("--no-photos", action="store_true", help="–ù–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ")

    def handle(self, *args, **options):
        filepath = options["file"]
        dry_run = options["dry_run"]
        no_photos = options["no_photos"]

        if dry_run:
            self.stdout.write(self.style.WARNING("=== DRY RUN ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–æ ===\n"))

        wb = openpyxl.load_workbook(filepath)
        ws = wb["Sheet1"]

        rows_data = []
        for i, row in enumerate(ws.iter_rows(min_row=2, max_row=ws.max_row, values_only=True), 1):
            rows_data.append({
                "row_num": i,
                "category": (row[1] or "").strip(),
                "name": (row[2] or "").strip(),
                "description": (row[3] or "").strip(),
                "short_description": (row[4] or "").strip(),
                "photo_url": (row[5] or "").strip(),
                "price": row[7],
                "qty": row[8],
                "unit": (row[9] or "").strip(),
                "is_popular": str(row[10] or "").strip().lower() == "–¥–∞",
            })

        # ‚îÄ‚îÄ –®–ê–ì 1: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚îÄ‚îÄ
        self.stdout.write(self.style.HTTP_INFO("\n‚îÄ‚îÄ –®–ê–ì 1: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚îÄ‚îÄ"))
        categories_to_create = set()
        for rd in rows_data:
            site_cat = CATEGORY_MAP.get(rd["category"])
            if not site_cat:
                self.stdout.write(self.style.ERROR(f"  ‚ö† –ù–µ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: '{rd['category']}' (—Å—Ç—Ä–æ–∫–∞ {rd['row_num']})"))
                continue
            categories_to_create.add(site_cat)

        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∂–µ–Ω)" ‚Üí "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è"
        cat_rename = {"–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–∂–µ–Ω)": "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è"}

        cats_created = 0
        cats_updated = 0
        cats_renamed = 0
        cat_objects = {}

        if not dry_run:
            with transaction.atomic():
                # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
                for old_name, new_name in cat_rename.items():
                    try:
                        cat = ServiceCategory.objects.get(name=old_name)
                        cat.name = new_name
                        cat.save()
                        cats_renamed += 1
                        self.stdout.write(f"  üîÑ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞: '{old_name}' ‚Üí '{new_name}'")
                    except ServiceCategory.DoesNotExist:
                        pass

                # –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                for cat_name in sorted(categories_to_create):
                    order = CATEGORY_ORDER.get(cat_name, 99)
                    obj, created = ServiceCategory.objects.get_or_create(
                        name=cat_name,
                        defaults={"order": order}
                    )
                    if not created:
                        obj.order = order
                        obj.save()
                        cats_updated += 1
                    else:
                        cats_created += 1
                    cat_objects[cat_name] = obj

                # –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–º—É–∂)
                unused = ["–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (–º—É–∂)", "–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∞–∂–∏"]
                for u in unused:
                    try:
                        c = ServiceCategory.objects.get(name=u)
                        if c.services.count() == 0:
                            c.delete()
                            self.stdout.write(f"  üóë –£–¥–∞–ª–µ–Ω–∞ –ø—É—Å—Ç–∞—è: '{u}'")
                    except ServiceCategory.DoesNotExist:
                        pass
        else:
            for cat_name in sorted(categories_to_create):
                existing = ServiceCategory.objects.filter(name=cat_name).exists()
                status = "EXISTS" if existing else "NEW"
                self.stdout.write(f"  {'‚úÖ' if existing else 'üÜï'} [{status}] {cat_name} (order={CATEGORY_ORDER.get(cat_name, 99)})")
            cat_objects = {name: ServiceCategory.objects.filter(name=name).first() for name in categories_to_create}

        self.stdout.write(f"\n  –ò—Ç–æ–≥–æ: —Å–æ–∑–¥–∞–Ω–æ={cats_created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ={cats_updated}, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ={cats_renamed}")

        # ‚îÄ‚îÄ –®–ê–ì 2: –£—Å–ª—É–≥–∏ –∏ –æ–ø—Ü–∏–∏ ‚îÄ‚îÄ
        self.stdout.write(self.style.HTTP_INFO("\n‚îÄ‚îÄ –®–ê–ì 2: –£—Å–ª—É–≥–∏ –∏ –æ–ø—Ü–∏–∏ ‚îÄ‚îÄ"))

        services_created = 0
        services_updated = 0
        options_created = 0
        options_updated = 0
        photos_downloaded = 0
        skipped = 0

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ service_id (–¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö) –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏ (–¥–ª—è –Ω–æ–≤—ã—Ö)
        processed_services = {}  # service_id ‚Üí —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω

        for rd in rows_data:
            row_num = rd["row_num"]

            if row_num in SKIP_DUPLICATE_ROWS:
                self.stdout.write(f"  ‚è≠ –°—Ç—Ä–æ–∫–∞ {row_num}: SKIP (–¥—É–±–ª—å) ‚Äî {rd['name']}")
                skipped += 1
                continue

            site_cat_name = CATEGORY_MAP.get(rd["category"])
            if not site_cat_name:
                self.stdout.write(self.style.ERROR(f"  ‚ö† –°—Ç—Ä–æ–∫–∞ {row_num}: –Ω–µ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ ‚Äî {rd['category']}"))
                skipped += 1
                continue

            key = (rd["category"], rd["name"])
            existing_id = EXISTING_SERVICE_MAP.get(key)

            price = Decimal(str(rd["price"])) if rd["price"] else Decimal("0")
            duration = _extract_duration(rd["name"], rd["qty"])

            if existing_id is not None:
                # ‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —É—Å–ª—É–≥–∏ ‚îÄ‚îÄ
                if dry_run:
                    svc = Service.objects.filter(id=existing_id).first()
                    svc_name = svc.name if svc else "NOT FOUND"
                    self.stdout.write(f"  üîÑ –°—Ç—Ä–æ–∫–∞ {row_num}: UPDATE Service id={existing_id} ({svc_name})")
                    self.stdout.write(f"      cat‚Üí{site_cat_name}, price={price}, dur={duration}min")
                    if rd["description"] and svc and not svc.description:
                        self.stdout.write(f"      +description ({len(rd['description'])} chars)")
                    if rd["photo_url"] and not no_photos:
                        self.stdout.write(f"      +photo: {rd['photo_url'][:60]}...")
                    continue

                try:
                    svc = Service.objects.get(id=existing_id)
                except Service.DoesNotExist:
                    self.stdout.write(self.style.ERROR(f"  ‚ùå –°—Ç—Ä–æ–∫–∞ {row_num}: Service id={existing_id} –Ω–µ –Ω–∞–π–¥–µ–Ω!"))
                    continue

                # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                cat_obj = cat_objects.get(site_cat_name)
                if cat_obj:
                    svc.category = cat_obj

                # –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ (–µ—Å–ª–∏ –ø—É—Å—Ç–æ–µ –≤ –±–∞–∑–µ, –∞ –≤ xlsx –µ—Å—Ç—å)
                if rd["description"] and not svc.description:
                    svc.description = rd["description"]

                # –û–±–Ω–æ–≤–ª—è–µ–º is_popular
                if rd["is_popular"]:
                    svc.is_popular = True

                # –û–±–Ω–æ–≤–ª—è–µ–º price_from
                svc.price_from = price

                # –§–æ—Ç–æ
                if rd["photo_url"] and not no_photos and not svc.image:
                    result = _download_photo(rd["photo_url"])
                    if result:
                        fname, data = result
                        svc.image.save(fname, ContentFile(data), save=False)
                        photos_downloaded += 1
                        self.stdout.write(f"      üì∑ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ")

                svc.save()
                services_updated += 1

                # –û–±–Ω–æ–≤–ª—è–µ–º/—Å–æ–∑–¥–∞—ë–º –æ–ø—Ü–∏—é
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç service (–≥—Ä—É–ø–ø–∞ —Å—Ç—Ä–æ–∫)
                if existing_id not in processed_services:
                    processed_services[existing_id] = True

                # –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏—é –¥–ª—è –¥–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                opt, opt_created = ServiceOption.objects.get_or_create(
                    service=svc,
                    duration_min=duration,
                    units=1,
                    unit_type="session",
                    defaults={"price": price, "is_active": True}
                )
                if not opt_created:
                    if opt.price != price:
                        opt.price = price
                        opt.save()
                        options_updated += 1
                        self.stdout.write(f"  üí∞ –°—Ç—Ä–æ–∫–∞ {row_num}: UPDATE opt id={opt.id} price‚Üí{price}")
                else:
                    options_created += 1
                    self.stdout.write(f"  üÜï –°—Ç—Ä–æ–∫–∞ {row_num}: NEW opt {svc.name} / {duration}min / {price}‚ÇΩ")

                self.stdout.write(f"  ‚úÖ –°—Ç—Ä–æ–∫–∞ {row_num}: {svc.name} ‚Üí {site_cat_name}")

            else:
                # ‚îÄ‚îÄ –ù–æ–≤–∞—è —É—Å–ª—É–≥–∞ ‚îÄ‚îÄ
                if dry_run:
                    self.stdout.write(f"  üÜï –°—Ç—Ä–æ–∫–∞ {row_num}: NEW Service '{rd['name']}'")
                    self.stdout.write(f"      cat={site_cat_name}, price={price}, dur={duration}min")
                    if rd["description"]:
                        self.stdout.write(f"      +description ({len(rd['description'])} chars)")
                    if rd["photo_url"] and not no_photos:
                        self.stdout.write(f"      +photo: {rd['photo_url'][:60]}...")
                    continue

                cat_obj = cat_objects.get(site_cat_name)

                svc = Service.objects.create(
                    name=rd["name"],
                    description=rd["description"],
                    is_active=True,
                    is_popular=rd["is_popular"],
                    category=cat_obj,
                    price_from=price,
                    duration_min=duration,
                )
                services_created += 1

                # –§–æ—Ç–æ
                if rd["photo_url"] and not no_photos:
                    result = _download_photo(rd["photo_url"])
                    if result:
                        fname, data = result
                        svc.image.save(fname, ContentFile(data), save=True)
                        photos_downloaded += 1

                # –°–æ–∑–¥–∞—ë–º –æ–ø—Ü–∏—é
                ServiceOption.objects.create(
                    service=svc,
                    duration_min=duration,
                    price=price,
                    units=1,
                    unit_type="session",
                    is_active=True,
                )
                options_created += 1

                self.stdout.write(f"  üÜï –°—Ç—Ä–æ–∫–∞ {row_num}: {svc.name} ‚Üí {site_cat_name} / {duration}min / {price}‚ÇΩ")

        # ‚îÄ‚îÄ –ò–¢–û–ì–ò ‚îÄ‚îÄ
        self.stdout.write(self.style.HTTP_INFO("\n‚îÄ‚îÄ –ò–¢–û–ì–ò ‚îÄ‚îÄ"))
        self.stdout.write(f"  –ö–∞—Ç–µ–≥–æ—Ä–∏–π: —Å–æ–∑–¥–∞–Ω–æ={cats_created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ={cats_updated}, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ={cats_renamed}")
        self.stdout.write(f"  –£—Å–ª—É–≥: —Å–æ–∑–¥–∞–Ω–æ={services_created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ={services_updated}")
        self.stdout.write(f"  –û–ø—Ü–∏–π: —Å–æ–∑–¥–∞–Ω–æ={options_created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ={options_updated}")
        self.stdout.write(f"  –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {photos_downloaded}")
        self.stdout.write(f"  –ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏): {skipped}")

        if dry_run:
            self.stdout.write(self.style.WARNING("\n=== DRY RUN –∑–∞–≤–µ—Ä—à—ë–Ω. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —É–±–µ—Ä–∏—Ç–µ --dry-run ==="))
        else:
            self.stdout.write(self.style.SUCCESS("\n‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!"))

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤—è–∑–æ–∫
            self.stdout.write(self.style.HTTP_INFO("\n‚îÄ‚îÄ –ü–†–û–í–ï–†–ö–ê –ü–†–ò–í–Ø–ó–û–ö ‚îÄ‚îÄ"))
            from services_app.models import Bundle, Promotion
            for b in Bundle.objects.all():
                items = b.items.select_related("option").all()
                broken = [i for i in items if not i.option]
                self.stdout.write(f"  Bundle '{b.name}': {items.count()} items, broken={len(broken)}")

            for p in Promotion.objects.all():
                opts = p.options.all()
                self.stdout.write(f"  Promotion '{p.title}': {opts.count()} options")

            self.stdout.write(self.style.HTTP_INFO("\n‚îÄ‚îÄ –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–î ‚îÄ‚îÄ"))
            self.stdout.write(f"  ServiceCategory: {ServiceCategory.objects.count()}")
            self.stdout.write(f"  Service: {Service.objects.count()}")
            self.stdout.write(f"  ServiceOption: {ServiceOption.objects.count()}")
