    {% extends 'website/base.html' %}
    {% load static %}

    {% block title %}{{ service.name }} | {{ settings.salon_name|default:"–°—Ç—É–¥–∏—è —ç—Å—Ç–µ—Ç–∏–∫–∏ –§–æ—Ä–º—É–ª–∞ –¢–µ–ª–∞" }}{% endblock %}

    {% block extra_css %}
    <style>
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        .modal-contact {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-contact.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-contact-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-contact-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        
        .modal-contact-close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #000;
        }
        
        .booking-summary {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .booking-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .booking-summary-item:last-child {
            margin-bottom: 0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .service-image {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }
        
        /* ============================================
        –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø FLATPICKR –ö–ê–õ–ï–ù–î–ê–†–Ø
        ============================================ */
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (–∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ) */
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange {
            background: #6366f1 !important;
            border-color: #6366f1 !important;
        }
        
        /* Hover —ç—Ñ—Ñ–µ–∫—Ç */
        .flatpickr-day:hover {
            background: #e0e7ff !important;
            border-color: #c7d2fe !important;
        }
        
        /* –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å */
        .flatpickr-day.today {
            border-color: #6366f1 !important;
        }
        
        /* –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã (—Å–µ—Ä—ã–µ) */
        .flatpickr-day.disabled,
        .flatpickr-day.disabled:hover {
            color: #d1d5db !important;
            background: transparent !important;
            cursor: not-allowed !important;
        }
        
        /* –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .flatpickr-months .flatpickr-prev-month:hover svg,
        .flatpickr-months .flatpickr-next-month:hover svg {
            fill: #6366f1 !important;
        }
        
        /* ============================================
        –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
        ============================================ */
        
        @media (max-width: 768px) {
            .flatpickr-calendar {
                font-size: 16px !important;
            }
            
            .flatpickr-day {
                height: 42px !important;
                line-height: 42px !important;
            }
        }

    </style>
    {% endblock %}

    {% block content %}
        <!-- ========================= –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ========================= -->
        <section class="service serv3 mb-112 mt-56">
            <div class="container"> 
                <div class="row row1">
                    <div class="col-xl-6 col-lg-8">
                        <h2 class="wow fadeInUp" data-wow-delay=".2s">{{ service.name }}</h2>
                        {% if service.description %}
                            <p class="wow fadeInUp" data-wow-delay=".3s">{{ service.description|linebreaks }}</p>
                        {% endif %}
                        
                        <!-- –§–û–†–ú–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø -->
                        <form id="booking-form" class="mt-40">
                            <div class="in-form">
                                {% if options_count > 0 %}
                                    <!-- –í—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ --> 
                                    {% if durations_count > 1 %}
                                    <select 
                                        id="duration-select" 
                                        class="form-select" 
                                        required>
                                        <option value="">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                        {% for duration in durations %}
                                        <option value="{{ duration }}">{{ duration }} –º–∏–Ω—É—Ç</option>
                                        {% endfor %}
                                    </select>
                                    {% elif durations_count == 1 %}
                                    <!-- –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ disabled -->
                                    {% with duration=durations.0 %}
                                    <input 
                                        type="text" 
                                        class="text-def" 
                                        value="{{ duration }} –º–∏–Ω—É—Ç" 
                                        disabled>
                                    <input 
                                        type="hidden" 
                                        id="duration-select" 
                                        value="{{ duration }}">
                                    {% endwith %}
                                    {% endif %}
                                    
                                    <!-- –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ -->
                                    {% if is_single_quantity_for_all_durations %}
                                    <!-- –ï—Å–ª–∏ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º input disabled -->
                                    <input 
                                        type="text" 
                                        class="text-def" 
                                        id="quantity-display"
                                        value="{{ single_quantity_value }} {{ single_quantity_unit_type_display }}" 
                                        disabled>
                                    <input 
                                        type="hidden" 
                                        id="quantity-select" 
                                        value="{{ single_quantity_value }}">
                                    {% elif durations_count == 1 and quantities_count > 1 %}
                                    <!-- –ï—Å–ª–∏ –æ–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤ -->
                                    <select 
                                        id="quantity-select" 
                                        class="form-select" 
                                        required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                        {% for opt in options %}
                                        <option value="{{ opt.units }}">{{ opt.units }} {{ opt.get_unit_type_display }}</option>
                                        {% endfor %}
                                    </select>
                                    {% elif durations_count == 1 and quantities_count == 1 %}
                                    <!-- –ï—Å–ª–∏ –æ–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ disabled -->
                                    {% with opt=options.0 %}
                                    <input 
                                        type="text" 
                                        class="text-def" 
                                        id="quantity-display"
                                        value="{{ opt.units }} {{ opt.get_unit_type_display }}" 
                                        disabled>
                                    <input 
                                        type="hidden" 
                                        id="quantity-select" 
                                        value="{{ opt.units }}">
                                    {% endwith %}
                                    {% else %}
                                    <!-- –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –∏ —Ä–∞–∑–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    <select 
                                        id="quantity-select" 
                                        class="form-select" 
                                        required>
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                    </select>
                                    {% endif %}
                                    
                                    <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏ -->
                                    <input type="hidden" id="option-select" value="">
                                    
                                {% else %}
                                    <!-- –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏ -->
                                    <div class="alert alert-warning">
                                        {% if has_yclients_options|default:True %}
                                            –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏
                                        {% else %}
                                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –£ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω YClients ID. 
                                            –û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                                        {% endif %}
                                    </div>
                                    <input type="hidden" id="option-select" value="">
                                    <input type="hidden" id="duration-select" value="">
                                    <input type="hidden" id="quantity-select" value="">
                                {% endif %}
                                
                                <!-- –í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞ -->
                                <select 
                                    id="master-select" 
                                    class="form-select" 
                                    required>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>
                                </select>
                                
                                <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
                                <input 
                                    type="date" 
                                    id="date-zapis" 
                                    class="form-control" 
                                    disabled
                                    required>
                                
                                <!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ -->
                                <select id="time-zapis" class="form-select" required disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–∞—Ç—É</option>
                                </select>
                                
                                <!-- –°—Ç–æ–∏–º–æ—Å—Ç—å -->
                                <input 
                                    type="text" 
                                    id="price-display" 
                                    class="text-def semi" 
                                    value="–°—Ç–æ–∏–º–æ—Å—Ç—å: {% if options_count == 1 %}{{ options.0.price|floatformat:0 }}{% else %}‚Äî{% endif %} ‚ÇΩ" 
                                    disabled>
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ -->
                            <button 
                                type="submit" 
                                id="submit-booking" 
                                class="btn-black t-btn submit">
                                –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω
                            </button>
                        </form>	
                    </div>
                    
                    <div class="col-xl-6 col-lg-4">
                        <div class="item">
                            {% if service.image %}
                                <img src="{{ service.image.url }}" class="responsive mn7" alt="{{ service.name }}" title="{{ service.name }}" loading="lazy">
                                <img src="{{ service.image.url }}" class="responsive mobb7" alt="{{ service.name }}" title="{{ service.name }}" loading="lazy">
                            {% else %}
                                <!-- Placeholder –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                <div class="responsive mn7" style="background: #f5f5f5; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                                    <span>{{ service.name }}</span>
                                </div>
                                <div class="responsive mobb7" style="background: #f5f5f5; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                    <span>{{ service.name }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ========================= –î—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏ ========================= -->
        {% if other_services %}
        <section class="service serv2 mb-112">
            <div class="container"> 
                <h2>–î—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏</h2>
                <div class="row">
                    {% for other_service in other_services %}
                    <div class="col-xxl-3 col-xl-4 col-md-4 col-sm-6">
                        <a href="{% url 'website:service_detail' other_service.id %}" class="item">
                            {% if other_service.image %}
                                <img src="{{ other_service.image.url }}" class="responsive mn" alt="{{ other_service.name }}" title="{{ other_service.name }}" loading="lazy">
                                <img src="{{ other_service.image.url }}" class="responsive mobb" alt="{{ other_service.name }}" title="{{ other_service.name }}" loading="lazy">
                            {% else %}
                                <div class="responsive mn" style="background: #f5f5f5; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <span>{{ other_service.name }}</span>
                                </div>
                                <div class="responsive mobb" style="background: #f5f5f5; min-height: 150px; display: flex; align-items: center; justify-content: center;">
                                    <span>{{ other_service.name }}</span>
                                </div>
                            {% endif %}
                            <span class="semi d-flex align-items-center justify-content-center">{{ other_service.name }}</span>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
        <div id="contact-modal" class="modal-contact">
            <div class="modal-contact-content">
                <span class="modal-contact-close" onclick="closeContactModal()">&times;</span>
                
                <h3 style="margin-bottom: 20px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                
                <!-- –°–≤–æ–¥–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div class="booking-summary">
                    <div class="booking-summary-item">
                        <span>–£—Å–ª—É–≥–∞:</span>
                        <strong id="summary-service"></strong>
                    </div>
                    <div class="booking-summary-item">
                        <span>–ú–∞—Å—Ç–µ—Ä:</span>
                        <strong id="summary-master"></strong>
                    </div>
                    <div class="booking-summary-item">
                        <span>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</span>
                        <strong id="summary-datetime"></strong>
                    </div>
                    <div class="booking-summary-item">
                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                        <strong id="summary-price"></strong>
                    </div>
                </div>
                
                <!-- –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
                <form id="contact-form">
                    <div class="form-group">
                        <label for="client-name">–í–∞—à–µ –∏–º—è *</label>
                        <input 
                            type="text" 
                            id="client-name" 
                            placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" 
                            required>
                    </div>
                    
                    <div class="form-group">
                        <label for="client-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input 
                            type="tel" 
                            id="client-phone" 
                            placeholder="+7 (900) 123-45-67" 
                            required>
                    </div>
                    
                    <div class="form-group">
                        <label for="client-email">Email</label>
                        <input 
                            type="email" 
                            id="client-email" 
                            placeholder="email@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="client-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea 
                            id="client-comment" 
                            rows="3"
                            placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                    </div>
                    
                    <div id="modal-alert"></div>
                    
                    <button 
                        type="submit" 
                        id="confirm-booking" 
                        class="btn-black t-btn" 
                        style="width: 100%; margin-top: 10px;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                </form>
            </div>
        </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_BASE_URL = '{{ request.scheme }}://{{ request.get_host }}';
        
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
        let bookingData = {};
        let availableDates = [];
        let datePicker = null;
        
        // ========== –î–ê–ù–ù–´–ï –û–ü–¶–ò–ô –£–°–õ–£–ì–ò (—Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ) ==========
        const serviceOptions = [
            {% for opt in options %}
            {
                id: {{ opt.id }},
                duration: {{ opt.duration_min }},
                quantity: {{ opt.units }},
                unitType: '{{ opt.unit_type }}',
                unitTypeDisplay: '{{ opt.get_unit_type_display }}',
                price: {{ opt.price|floatformat:0 }},
                yclientsId: '{{ opt.yclients_service_id|default:"" }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –æ–ø—Ü–∏–∏: {duration: {quantity: option}}
        const optionsMap = {};
        serviceOptions.forEach(opt => {
            if (!optionsMap[opt.duration]) {
                optionsMap[opt.duration] = {};
            }
            optionsMap[opt.duration][opt.quantity] = opt;
        });
        
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const uniqueDurations = [...new Set(serviceOptions.map(opt => opt.duration))].sort((a, b) => a - b);
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—Ü–∏–∏ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
        function getOptionByDurationAndQuantity(duration, quantity) {
            if (!duration || !quantity) return null;
            return optionsMap[duration] && optionsMap[duration][quantity] || null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(price);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        function updatePrice() {
            const durationSelect = document.getElementById('duration-select');
            const quantitySelect = document.getElementById('quantity-select');
            const quantityDisplay = document.getElementById('quantity-display');
            const priceDisplay = document.getElementById('price-display');
            const optionSelect = document.getElementById('option-select');
            
            if (!durationSelect || !priceDisplay) return;
            
            const duration = durationSelect.value;
            // –ü–æ–ª—É—á–∞–µ–º quantity –∏–∑ select –∏–ª–∏ –∏–∑ hidden input (–µ—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è input disabled)
            let quantity = '';
            if (quantitySelect && quantitySelect.type !== 'hidden') {
                quantity = quantitySelect.value;
            } else if (quantitySelect && quantitySelect.type === 'hidden') {
                quantity = quantitySelect.value;
            }
            
            if (duration && quantity) {
                const option = getOptionByDurationAndQuantity(parseInt(duration), parseInt(quantity));
                if (option) {
                    priceDisplay.value = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatPrice(option.price)} ‚ÇΩ`;
                    if (optionSelect) {
                        optionSelect.value = option.id;
                    }
                    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Å—Ç–µ—Ä–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–ø—Ü–∏–∏
                    loadMasters();
                } else {
                    priceDisplay.value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ‚Äî ‚ÇΩ';
                    if (optionSelect) {
                        optionSelect.value = '';
                    }
                }
            } else {
                priceDisplay.value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ‚Äî ‚ÇΩ';
                if (optionSelect) {
                    optionSelect.value = '';
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ–Ω—ã select –Ω–∞ input disabled (–∫–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ 1 –≤–∞—Ä–∏–∞–Ω—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
        function replaceQuantitySelectWithInput(quantity, unitTypeDisplay) {
            const quantitySelect = document.getElementById('quantity-select');
            if (!quantitySelect) return;
            
            // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ input, –Ω–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ
            if (quantitySelect.tagName === 'INPUT' && quantitySelect.type === 'text') {
                return;
            }
            
            const parent = quantitySelect.parentElement;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'text-def';
            input.value = `${quantity} ${getQuantityLabel(quantity, unitTypeDisplay)}`;
            input.disabled = true;
            input.id = 'quantity-display';
            
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'quantity-select';
            hiddenInput.value = quantity;
            
            parent.replaceChild(input, quantitySelect);
            parent.appendChild(hiddenInput);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ–Ω—ã input disabled –Ω–∞ select (–∫–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
        function replaceQuantityInputWithSelect() {
            const quantityDisplay = document.getElementById('quantity-display');
            const quantitySelect = document.getElementById('quantity-select');
            
            if (!quantityDisplay) return;
            
            const parent = quantityDisplay.parentElement;
            const select = document.createElement('select');
            select.id = 'quantity-select';
            select.className = 'form-select';
            select.required = true;
            
            parent.replaceChild(select, quantityDisplay);
            if (quantitySelect && quantitySelect.type === 'hidden') {
                parent.removeChild(quantitySelect);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è select –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function updateQuantitySelect(duration) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π - –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º
            const quantityDisplay = document.getElementById('quantity-display');
            const quantitySelect = document.getElementById('quantity-select');
            
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å input disabled –∏ —ç—Ç–æ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ quantity-select - –∑–Ω–∞—á–∏—Ç —ç—Ç–æ —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (quantityDisplay && quantitySelect && quantitySelect.type === 'hidden') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π)
                // –ï—Å–ª–∏ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, JavaScript –Ω–µ –¥–æ–ª–∂–µ–Ω –µ–≥–æ –º–µ–Ω—è—Ç—å
                const allQuantities = new Set();
                Object.values(optionsMap).forEach(durationMap => {
                    Object.keys(durationMap).forEach(qty => allQuantities.add(qty));
                });
                
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π - –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º
                if (allQuantities.size === 1) {
                    updatePrice();
                    return;
                }
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å input disabled, –Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–Ω–æ–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π - –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ select
            if (quantityDisplay) {
                replaceQuantityInputWithSelect();
            }
            
            if (!quantitySelect) return;
            
            if (!duration) {
                quantitySelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>';
                quantitySelect.classList.remove('visible');
                quantitySelect.required = false;
                return;
            }
            
            const durationInt = parseInt(duration);
            const quantities = optionsMap[durationInt] ? Object.keys(optionsMap[durationInt]).map(Number).sort((a, b) => a - b) : [];
            
            if (quantities.length === 0) {
                quantitySelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</option>';
                quantitySelect.classList.add('visible');
                quantitySelect.required = false;
                return;
            }
            
            // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º input disabled
            if (quantities.length === 1) {
                const option = optionsMap[durationInt][quantities[0]];
                replaceQuantitySelectWithInput(quantities[0], option.unitTypeDisplay);
                updatePrice();
                return;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º select
            quantitySelect.classList.add('visible');
            quantitySelect.required = true;
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –æ–ø—Ü–∏—è–º–∏
            quantitySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>';
            
            quantities.forEach(qty => {
                const option = optionsMap[durationInt][qty];
                const optionElem = document.createElement('option');
                optionElem.value = qty;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç: "1 –ø—Ä–æ—Ü–µ–¥—É—Ä–∞" –∏–ª–∏ "5 –ø—Ä–æ—Ü–µ–¥—É—Ä"
                const unitLabel = option.unitTypeDisplay;
                optionElem.textContent = `${qty} ${getQuantityLabel(qty, unitLabel)}`;
                
                quantitySelect.appendChild(optionElem);
            });
            
            quantitySelect.value = '';
            updatePrice();
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
        function getQuantityLabel(quantity, unitType) {
            // –î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞: 1 –ø—Ä–æ—Ü–µ–¥—É—Ä–∞, 2-4 –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, 5+ –ø—Ä–æ—Ü–µ–¥—É—Ä
            const lastDigit = quantity % 10;
            const lastTwoDigits = quantity % 100;
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                // 11-14: –≤—Å–µ–≥–¥–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ (–ø—Ä–æ—Ü–µ–¥—É—Ä, –∑–æ–Ω, –≤–∏–∑–∏—Ç–æ–≤)
                if (unitType === '–ø—Ä–æ—Ü–µ–¥—É—Ä—ã') return '–ø—Ä–æ—Ü–µ–¥—É—Ä';
                if (unitType === '–∑–æ–Ω—ã') return '–∑–æ–Ω';
                if (unitType === '–≤–∏–∑–∏—Ç—ã') return '–≤–∏–∑–∏—Ç–æ–≤';
                return unitType;
            }
            
            if (lastDigit === 1) {
                // 1, 21, 31...: –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ
                if (unitType === '–ø—Ä–æ—Ü–µ–¥—É—Ä—ã') return '–ø—Ä–æ—Ü–µ–¥—É—Ä–∞';
                if (unitType === '–∑–æ–Ω—ã') return '–∑–æ–Ω–∞';
                if (unitType === '–≤–∏–∑–∏—Ç—ã') return '–≤–∏–∑–∏—Ç';
                return unitType;
            }
            
            if (lastDigit >= 2 && lastDigit <= 4) {
                // 2-4, 22-24...: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ (–ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –∑–æ–Ω—ã, –≤–∏–∑–∏—Ç—ã)
                return unitType;
            }
            
            // 5-9, 0: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π (–ø—Ä–æ—Ü–µ–¥—É—Ä, –∑–æ–Ω, –≤–∏–∑–∏—Ç–æ–≤)
            if (unitType === '–ø—Ä–æ—Ü–µ–¥—É—Ä—ã') return '–ø—Ä–æ—Ü–µ–¥—É—Ä';
            if (unitType === '–∑–æ–Ω—ã') return '–∑–æ–Ω';
            if (unitType === '–≤–∏–∑–∏—Ç—ã') return '–≤–∏–∑–∏—Ç–æ–≤';
            return unitType;
        }
        
        // ========== –ó–ê–ì–†–£–ó–ö–ê –ú–ê–°–¢–ï–†–û–í ==========
        async function loadMasters() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
                const optionSelect = document.getElementById('option-select');
                if (!optionSelect) {
                    console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç option-select –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const serviceOptionId = optionSelect.value;
                
                // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
                if (!serviceOptionId) {
                    const select = document.getElementById('master-select');
                    if (select) {
                        select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
                    }
                    console.log('‚è∏Ô∏è –í–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω, –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è');
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —É—Å–ª—É–≥–µ
                const url = `${API_BASE_URL}/api/booking/get_staff/?service_option_id=${serviceOptionId}`;
                console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Å–ª—É–≥–∏:', serviceOptionId);
                
                const select = document.getElementById('master-select');
                select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤...</option>';
                select.disabled = true;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.data) {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                    
                    if (data.data.length === 0) {
                        select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏</option>';
                        console.warn('‚ö†Ô∏è –ù–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏');
                        select.disabled = false;
                        return;
                    }
                    
                    data.data.forEach(master => {
                        const option = document.createElement('option');
                        option.value = master.id;
                        
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–º—è: –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–º–∏–ª–∏—è –∏ –∏–º—è –æ—Ç–¥–µ–ª—å–Ω–æ - –æ–±—ä–µ–¥–∏–Ω—è–µ–º, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º name
                        let masterName = master.name || '';
                        
                        // –ï—Å–ª–∏ –≤ API –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è first_name –∏ last_name
                        if (master.first_name || master.last_name) {
                            const parts = [];
                            if (master.last_name) parts.push(master.last_name);
                            if (master.first_name) parts.push(master.first_name);
                            masterName = parts.join(' ');
                        }
                        
                        option.textContent = masterName;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (master.specialization) {
                            option.textContent += ` (${master.specialization})`;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    console.log('‚úÖ –ú–∞—Å—Ç–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data.data.length);
                } else {
                    select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ API:', data.error || 'Unknown error');
                }
                
                select.disabled = false;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤:', error);
                const select = document.getElementById('master-select');
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
                select.disabled = false;
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (disabled)
        function initializeEmptyDatePicker() {
            const dateInput = document.getElementById('date-zapis');
            
            if (!dateInput) {
                console.error('‚ùå dateInput –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å
            if (datePicker && typeof datePicker.destroy === 'function') {
                try {
                    datePicker.destroy();
                } catch (e) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
                }
                datePicker = null;
            }
            
            // –ö–∞–ª–µ–Ω–¥–∞—Ä—å disabled –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–ª—é—á–∞–µ–º input
            dateInput.disabled = true;
            dateInput.value = '';
            
            // –ù–ï –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º flatpickr –¥–ª—è disabled –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º–∞—Å—Ç–µ—Ä –≤—ã–±—Ä–∞–Ω –∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã
            console.log('üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–∫–ª—é—á–µ–Ω (–º–∞—Å—Ç–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω)');
        }
        
        // –§–ª–∞–≥–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        let isLoadingDates = false;
        let isLoadingTimes = false;
        let lastRequestedDate = null;
        let lastRequestedStaffId = null;

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –î–ê–¢ ==========
        async function loadAvailableDates(staffId) {
            console.log('üîç loadAvailableDates –≤—ã–∑–≤–∞–Ω–∞ —Å staffId:', staffId);
            
            if (!staffId) {
                console.error('‚ùå staffId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ loadAvailableDates');
                return;
            }
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            if (isLoadingDates) {
                console.log('‚è∏Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å');
                return;
            }
            
            // –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (lastRequestedStaffId === staffId && availableDates.length > 0) {
                console.log('‚è∏Ô∏è –î–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }
            
            isLoadingDates = true;
            lastRequestedStaffId = staffId;
            
            try {
                const url = `${API_BASE_URL}/api/booking/available_dates/?staff_id=${staffId}`;
                console.log('üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞:', staffId);
                console.log('üì° URL:', url);
                
                const response = await fetch(url);
                console.log('üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                
                if (!response.ok) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ—Ç API:', data);
                
                if (data.success && data.data && data.data.dates) {
                    availableDates = data.data.dates;
                    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –¥–∞—Ç:', availableDates.length, availableDates);
                    
                    if (availableDates.length > 0) {
                        console.log('‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç:', availableDates.length);
                        initializeDatePicker(staffId);
                    } else {
                        console.log('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞');
                        alert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏');
                    }
                } else {
                    console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API:', data);
                    if (data.error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç API:', data.error);
                    }
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç:', error);
                console.error('Stack trace:', error.stack);
            } finally {
                isLoadingDates = false;
            }
        }

        function initializeDatePicker(staffId) {
            const dateInput = document.getElementById('date-zapis');
            
            if (!dateInput) {
                console.error('‚ùå dateInput –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (!availableDates || availableDates.length === 0) {
                console.error('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
                return;
            }
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å
            if (datePicker && typeof datePicker.destroy === 'function') {
                try {
                    datePicker.destroy();
                } catch (e) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ —Å—Ç–∞—Ä–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
                }
                datePicker = null;
            }
            
            // –í–∫–ª—é—á–∞–µ–º input –¥–∞—Ç—ã
            dateInput.disabled = false;
            
            // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            let isInitializing = true;
            const firstDate = availableDates[0];
            
            console.log('üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å –¥–∞—Ç–∞–º–∏:', availableDates);
            
            try {
                // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                datePicker = flatpickr(dateInput, {
                    locale: 'ru',
                    dateFormat: 'Y-m-d',
                    altInput: true,
                    altFormat: 'j F Y (D)',
                    minDate: availableDates[0],
                    maxDate: availableDates[availableDates.length - 1],
                    enable: availableDates,
                    defaultDate: firstDate,
                    disableMobile: false,
                    allowInput: false,
                    clickOpens: true,
                    
                    // ‚úÖ onChange —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    onChange: function(selectedDates, dateStr, instance) {
                        console.log('üìÖ –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞:', dateStr, 'isInitializing:', isInitializing);
                        
                        if (!dateStr || !staffId) {
                            return;
                        }
                        
                        // –í–∫–ª—é—á–∞–µ–º select –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–≥–¥–∞ –¥–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞
                        const timeSelect = document.getElementById('time-zapis');
                        if (timeSelect) {
                            timeSelect.disabled = false;
                        }
                        
                        // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É (–±–µ–∑ debounce –¥–ª—è –ø–µ—Ä–≤–æ–π –¥–∞—Ç—ã)
                        if (isInitializing && dateStr === firstDate) {
                            isInitializing = false;
                            console.log('üöÄ –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –¥–∞—Ç—ã:', firstDate);
                            loadAvailableTimes(staffId, firstDate);
                        } else if (!isInitializing) {
                            // –î–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º debounce
                            debouncedLoadTimes(staffId, dateStr);
                        }
                    },
                    
                    onReady: function(selectedDates, dateStr, instance) {
                        console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤ —Å', availableDates.length, '–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏');
                        isInitializing = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                    },
                    
                    onOpen: function() {
                        console.log('üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–∫—Ä—ã—Ç');
                    }
                });
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if (datePicker && typeof datePicker.open === 'function') {
                    datePicker.open();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
                console.error('Stack trace:', error.stack);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –û–±—ë—Ä–Ω—É—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è loadAvailableTimes —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º debounce
        const debouncedLoadTimes = debounce(loadAvailableTimes, 500);

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –í–†–ï–ú–Å–ù ==========
        async function loadAvailableTimes(staffId, date) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const requestKey = `${staffId}_${date}`;
            if (isLoadingTimes) {
                console.log('‚è∏Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å');
                return;
            }
            
            if (lastRequestedDate === requestKey) {
                console.log('‚è∏Ô∏è –í—Ä–µ–º—è –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è/–∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                return;
            }
            
            isLoadingTimes = true;
            lastRequestedDate = requestKey;
            
            const timeSelect = document.getElementById('time-zapis');
            timeSelect.disabled = true;
            
            try {
                const url = `${API_BASE_URL}/api/booking/available_times/?staff_id=${staffId}&date=${date}`;
                console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:', url);
                
                const response = await fetch(url);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ –û—Ç–≤–µ—Ç –æ—Ç API:', data);
                
                if (data.success && data.data && data.data.times) {
                    const times = data.data.times;
                    
                    if (times.length > 0) {
                        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
                        const grouped = groupTimesByPeriod(times);
                        
                        // –û—á–∏—â–∞–µ–º select
                        timeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</option>';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º
                        for (const [period, periodTimes] of Object.entries(grouped)) {
                            if (periodTimes.length > 0) {
                                const optgroup = document.createElement('optgroup');
                                optgroup.label = period;
                                
                                periodTimes.forEach(time => {
                                    const option = document.createElement('option');
                                    option.value = time;
                                    option.textContent = time;
                                    optgroup.appendChild(option);
                                });
                                
                                timeSelect.appendChild(optgroup);
                            }
                        }
                        
                        console.log('‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–æ—Ç–æ–≤:', times.length);
                    } else {
                        // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                        console.log('‚ö†Ô∏è –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É');
                        timeSelect.innerHTML = '<option value="">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –≤—Å–µ –∑–∞–Ω—è—Ç–æ</option>';
                    }
                } else {
                    // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API
                    console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:', data);
                    timeSelect.innerHTML = '<option value="">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</option>';
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏:', error);
                timeSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑</option>';
            } finally {
                timeSelect.disabled = false;
                isLoadingTimes = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –¥–Ω—è
        function groupTimesByPeriod(times) {
            const periods = {
                'üåÖ –£—Ç—Ä–æ (9:00 - 12:00)': [],
                '‚òÄÔ∏è –î–µ–Ω—å (12:00 - 17:00)': [],
                'üåÜ –í–µ—á–µ—Ä (17:00 - 21:00)': []
            };
            
            times.forEach(time => {
                const hour = parseInt(time.split(':')[0]);
                
                if (hour >= 9 && hour < 12) {
                    periods['üåÖ –£—Ç—Ä–æ (9:00 - 12:00)'].push(time);
                } else if (hour >= 12 && hour < 17) {
                    periods['‚òÄÔ∏è –î–µ–Ω—å (12:00 - 17:00)'].push(time);
                } else if (hour >= 17 && hour < 21) {
                    periods['üåÜ –í–µ—á–µ—Ä (17:00 - 21:00)'].push(time);
                }
            });
            
            return periods;
        }

            
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –î–õ–Ø SELECT –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ò –ö–û–õ–ò–ß–ï–°–¢–í–ê ==========
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const durationSelect = document.getElementById('duration-select');
        if (durationSelect) {
            durationSelect.addEventListener('change', function(e) {
                const duration = e.target.value;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º select –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                updateQuantitySelect(duration);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                if (duration) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                    const masterSelect = document.getElementById('master-select');
                    if (masterSelect) {
                        masterSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
                        masterSelect.value = '';
                    }
                    
                    const dateInput = document.getElementById('date-zapis');
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.disabled = true;
                    }
                    
                    const timeSelect = document.getElementById('time-zapis');
                    if (timeSelect) {
                        timeSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–∞—Ç—É</option>';
                        timeSelect.disabled = true;
                    }
                    
                    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    if (datePicker && typeof datePicker.destroy === 'function') {
                        try {
                            datePicker.destroy();
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
                        }
                        datePicker = null;
                    }
                    
                    // –°–æ–∑–¥–∞—ë–º disabled –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    initializeEmptyDatePicker();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                    lastRequestedDate = null;
                    lastRequestedStaffId = null;
                    availableDates = [];
                    isLoadingDates = false;
                    isLoadingTimes = false;
                } else {
                    // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ - –æ—á–∏—â–∞–µ–º –≤—Å—ë
                    updatePrice();
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        const quantitySelect = document.getElementById('quantity-select');
        if (quantitySelect) {
            quantitySelect.addEventListener('change', function(e) {
                const quantity = e.target.value;
                
                if (quantity) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
                    updatePrice();
                } else {
                    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
                    updatePrice();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    const masterSelect = document.getElementById('master-select');
                    if (masterSelect) {
                        masterSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
                        masterSelect.value = '';
                    }
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ü–∏—é
            const durationSelect = document.getElementById('duration-select');
            const quantitySelect = document.getElementById('quantity-select');
            const quantityDisplay = document.getElementById('quantity-display');
            
            if (durationSelect) {
                const duration = durationSelect.value;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                if (duration) {
                    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å input disabled (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
                    if (quantityDisplay && quantitySelect && quantitySelect.type === 'hidden') {
                        const quantity = quantitySelect.value;
                        if (quantity) {
                            const option = getOptionByDurationAndQuantity(parseInt(duration), parseInt(quantity));
                            if (option) {
                                const optionSelect = document.getElementById('option-select');
                                if (optionSelect) {
                                    optionSelect.value = option.id;
                                }
                                updatePrice();
                            }
                        }
                    } else if (quantitySelect && quantitySelect.tagName === 'SELECT') {
                        // –ï—Å–ª–∏ —ç—Ç–æ select - –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                        const quantity = quantitySelect.value;
                        if (quantity) {
                            const option = getOptionByDurationAndQuantity(parseInt(duration), parseInt(quantity));
                            if (option) {
                                const optionSelect = document.getElementById('option-select');
                                if (optionSelect) {
                                    optionSelect.value = option.id;
                                }
                                updatePrice();
                            }
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º select
                            updateQuantitySelect(duration);
                        }
                    }
                }
            }
        });
        
        // ‚úÖ –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è master-select (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOMContentLoaded)
        
        // ========== –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ==========
        document.getElementById('booking-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const optionSelect = document.getElementById('option-select');
            const durationSelect = document.getElementById('duration-select');
            const quantitySelect = document.getElementById('quantity-select');
            const quantityDisplay = document.getElementById('quantity-display');
            const masterSelect = document.getElementById('master-select');
            const timeSelect = document.getElementById('time-zapis');
            
            // –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
            const serviceOptionId = optionSelect ? optionSelect.value : null;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –æ–ø—Ü–∏—è
            if (!durationSelect || !durationSelect.value) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º quantity –∏–∑ select –∏–ª–∏ –∏–∑ hidden input (–µ—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è input disabled)
            let quantity = '';
            if (quantitySelect && quantitySelect.type !== 'hidden') {
                quantity = quantitySelect.value;
            } else if (quantitySelect && quantitySelect.type === 'hidden') {
                quantity = quantitySelect.value;
            }
            
            if (!quantity) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                return;
            }
            
            if (!serviceOptionId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            const duration = parseInt(durationSelect.value);
            const quantityInt = parseInt(quantity);
            const option = getOptionByDurationAndQuantity(duration, quantityInt);
            
            if (!option) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏');
                return;
            }
            
            const staffId = masterSelect.value;
            const masterName = masterSelect.options[masterSelect.selectedIndex].text;
            const date = document.getElementById('date-zapis').value;
            const time = timeSelect.value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if (!staffId || !date || !time) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            bookingData = {
                staff_id: parseInt(staffId),
                service_ids: [parseInt(option.yclientsId)],
                date: date,
                time: time,
                master_name: masterName,
                service_name: '{{ service.name|escapejs }}',
                service_price: option.price
            };
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–¥–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('summary-service').textContent = '{{ service.name|escapejs }}';
            document.getElementById('summary-master').textContent = masterName;
            document.getElementById('summary-datetime').textContent = `${formatDate(date)} –≤ ${time}`;
            document.getElementById('summary-price').textContent = `${formatPrice(option.price)} ‚ÇΩ`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('contact-modal').classList.add('active');
        });
        
        // ========== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò ==========
        document.getElementById('contact-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('confirm-booking');
            const originalText = btn.textContent;
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            btn.innerHTML = '<span class="spinner"></span> –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å...';
            btn.classList.add('btn-loading');
            
            // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
            const clientData = {
                name: document.getElementById('client-name').value.trim(),
                phone: document.getElementById('client-phone').value.replace(/\D/g, ''),
                email: document.getElementById('client-email').value.trim() || 'no-email@formulatela.ru'
            };
            
            const comment = document.getElementById('client-comment').value.trim();
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
            const requestData = {
                ...bookingData,
                client: clientData,
                comment: comment
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', requestData);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/booking/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (response.ok && data.success) {
                    // –£—Å–ø–µ—Ö!
                    showModalAlert('‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ! ID: ' + data.data.booking_id, 'success');
                    
                    // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // –û—à–∏–±–∫–∞
                    const errorMsg = data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏';
                    showModalAlert('‚ùå ' + errorMsg, 'error');
                    btn.textContent = originalText;
                    btn.classList.remove('btn-loading');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showModalAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                btn.textContent = originalText;
                btn.classList.remove('btn-loading');
            }
        });
        
        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function closeContactModal() {
            document.getElementById('contact-modal').classList.remove('active');
            document.getElementById('contact-form').reset();
            document.getElementById('modal-alert').innerHTML = '';
        }
        
        function showModalAlert(message, type) {
            const alertDiv = document.getElementById('modal-alert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('ru-RU', options);
        }
        
        function formatPrice(price) {
            return parseInt(price).toLocaleString('ru-RU');
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏
                const optionElem = document.getElementById('option-select');
                if (optionElem) {
                    if (optionElem.tagName === 'INPUT' && optionElem.value) {
                        // –ï—Å–ª–∏ —ç—Ç–æ —Å–∫—Ä—ã—Ç—ã–π input —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º - —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
                        console.log('üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤...');
                        loadMasters();
                    } else if (optionElem.tagName === 'SELECT') {
                        // –ï—Å–ª–∏ —ç—Ç–æ select - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–æ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
                        console.log('üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏, –∂–¥—ë–º –≤—ã–±–æ—Ä–∞...');
                        const select = document.getElementById('master-select');
                        if (select) {
                            select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
                        }
                    }
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('date-zapis');
                if (dateInput) {
                    dateInput.min = today;
                    // –ö–∞–ª–µ–Ω–¥–∞—Ä—å disabled –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω –º–∞—Å—Ç–µ—Ä)
                    dateInput.disabled = true;
                    dateInput.value = '';
                }
                
                // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è master-select
                const masterSelect = document.getElementById('master-select');
                if (masterSelect) {
                    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ master-select –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
                    masterSelect.addEventListener('change', function(e) {
                        const staffId = e.target.value;
                        const dateInput = document.getElementById('date-zapis');
                        const timeSelect = document.getElementById('time-zapis');
                        
                        console.log('üë§ –í—ã–±—Ä–∞–Ω –º–∞—Å—Ç–µ—Ä:', staffId);
                        
                        if (staffId) {
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                            lastRequestedDate = null;
                            lastRequestedStaffId = null;
                            availableDates = [];
                            
                            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –µ–≥–æ
                            if (timeSelect) {
                                timeSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>';
                                timeSelect.disabled = true;
                            }
                            
                            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                            if (datePicker && typeof datePicker.destroy === 'function') {
                                try {
                                    datePicker.destroy();
                                } catch (e) {
                                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
                                }
                                datePicker = null;
                            }
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
                            console.log('üìÖ –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞:', staffId);
                            loadAvailableDates(staffId);
                        } else {
                            // –ú–∞—Å—Ç–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω - –æ—Ç–∫–ª—é—á–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≤—Ä–µ–º—è
                            if (dateInput) {
                                dateInput.value = '';
                                dateInput.disabled = true;
                            }
                            if (timeSelect) {
                                timeSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                                timeSelect.disabled = true;
                            }
                            availableDates = [];
                            lastRequestedDate = null;
                            lastRequestedStaffId = null;
                            
                            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                            if (datePicker && typeof datePicker.destroy === 'function') {
                                try {
                                    datePicker.destroy();
                                } catch (e) {
                                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', e);
                                }
                                datePicker = null;
                            }
                            
                            // –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫–ª—é—á–∞–µ–º input (–Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º flatpickr)
                            if (dateInput) {
                                dateInput.disabled = true;
                                dateInput.value = '';
                            }
                        }
                    });
                    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ master-select –¥–æ–±–∞–≤–ª–µ–Ω');
                } else {
                    console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç master-select –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã:', error);
                console.error('Stack trace:', error.stack);
            }
        });
    </script>
    {% endblock %}
