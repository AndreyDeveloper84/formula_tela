{% extends 'website/base.html' %}
{% load static %}

{% block title %}{{ service.name }} | {{ settings.salon_name|default:"–°—Ç—É–¥–∏—è —ç—Å—Ç–µ—Ç–∏–∫–∏ –§–æ—Ä–º—É–ª–∞ –¢–µ–ª–∞" }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/booking.css' %}">
{% endblock %}

{% block content %}
    <!-- ========================= –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (uslugi3 / uslugi4) ========================= -->
    <section class="service serv3 mb-112 mt-56">
        <div class="container"> 
            <div class="row row1">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –æ–ø–∏—Å–∞–Ω–∏–µ + —Ñ–æ—Ä–º–∞ -->
                <div class="col-xl-6 col-lg-8">
                    <h2>{{ service.name }}</h2>
                    {% if service.description %}
                        {{ service.description|linebreaks }}
                    {% endif %}
                    
                    <!-- ========================= –§–û–†–ú–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ========================= -->
                    <form id="booking-form" class="mt-40">
                        {% csrf_token %}
                        <div class="in-form">
                            {% if options_count > 0 %}
                                {# ======================================================== #}
                                {# –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨: select (–Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) –∏–ª–∏ disabled  #}
                                {# ======================================================== #}
                                {% if durations_count > 1 %}
                                    {# --- uslugi4-—Å—Ç–∏–ª—å: –≤—ã–±–∏—Ä–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å --- #}
                                    <select id="duration-select" class="form-select" required>
                                        <option value="">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                        {% for duration in durations %}
                                        <option value="{{ duration }}">{{ duration }} –º–∏–Ω—É—Ç</option>
                                        {% endfor %}
                                    </select>
                                {% elif durations_count == 1 %}
                                    {# --- uslugi3-—Å—Ç–∏–ª—å: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å --- #}
                                    {% with duration=durations.0 %}
                                    <input type="text" class="text-def" value="{{ duration }} –º–∏–Ω—É—Ç" disabled>
                                    <input type="hidden" id="duration-select" value="{{ duration }}">
                                    {% endwith %}
                                {% endif %}
                                
                                {# ======================================================== #}
                                {# –ö–û–õ–ò–ß–ï–°–¢–í–û: select / disabled / –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ duration  #}
                                {# ======================================================== #}
                                {% if is_single_quantity_for_all_durations %}
                                    {# –î–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí input disabled #}
                                    <input type="text" class="text-def" id="quantity-display"
                                           value="{{ single_quantity_value }} {{ single_quantity_unit_type_display }}" disabled>
                                    <input type="hidden" id="quantity-select" value="{{ single_quantity_value }}">

                                {% elif durations_count == 1 and quantities_count > 1 %}
                                    {# –û–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤ ‚Üí select #}
                                    <select id="quantity-select" class="form-select" required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                        {% for opt in options %}
                                        <option value="{{ opt.units }}">{{ opt.units }} {{ opt.get_unit_type_display }}</option>
                                        {% endfor %}
                                    </select>

                                {% elif durations_count == 1 and quantities_count == 1 %}
                                    {# –û–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí input disabled #}
                                    {% with opt=options.0 %}
                                    <input type="text" class="text-def" id="quantity-display"
                                           value="{{ opt.units }} {{ opt.get_unit_type_display }}" disabled>
                                    <input type="hidden" id="quantity-select" value="{{ opt.units }}">
                                    {% endwith %}

                                {% else %}
                                    {# –ù–µ—Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π, —Ä–∞–∑–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π select #}
                                    <select id="quantity-select" class="form-select" required>
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                    </select>
                                {% endif %}
                                
                                {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏ #}
                                <input type="hidden" id="option-select" value="">
                                
                            {% else %}
                                {# –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ #}
                                <div class="alert alert-warning">
                                    –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏
                                </div>
                                <input type="hidden" id="option-select" value="">
                                <input type="hidden" id="duration-select" value="">
                                <input type="hidden" id="quantity-select" value="">
                            {% endif %}
                            
                            {# ======================================================== #}
                            {# –ú–ê–°–¢–ï–† (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ API)                          #}
                            {# ======================================================== #}
                            <select id="master-select" class="form-select" required>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>
                            </select>
                            
                            {# ======================================================== #}
                            {# –î–ê–¢–ê (Flatpickr ‚Äî –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–∞—Å—Ç–µ—Ä–∞)      #}
                            {# ======================================================== #}
                            <input type="text" id="date-zapis" class="form-control"
                                   placeholder="–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞" disabled required>
                            
                            {# ======================================================== #}
                            {# –í–†–ï–ú–Ø (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ API –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã)         #}
                            {# ======================================================== #}
                            <select id="time-zapis" class="form-select" required disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>
                            </select>
                            
                            {# ======================================================== #}
                            {# –°–¢–û–ò–ú–û–°–¢–¨                                                #}
                            {# ======================================================== #}
                            <input type="text" id="price-display" class="text-def semi"
                                   value="–°—Ç–æ–∏–º–æ—Å—Ç—å: {% if options_count == 1 %}{{ options.0.price|floatformat:0 }}{% else %}‚Äî{% endif %} ‚ÇΩ"
                                   disabled>
                        </div>
                        
                        {# –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ ‚Äî <a>, –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ #}
                        <a href="#" id="submit-booking" class="btn-black t-btn submit">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω</a>
                    </form>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ -->
                <div class="col-xl-6 col-lg-4">
                    <div class="item">
                        {% if service.image %}
                            <img src="{{ service.image.url }}" class="responsive mn7"
                                 alt="{{ service.name }}" title="{{ service.name }}" loading="lazy">
                        {% endif %}
                        {% if service.image_mobile %}
                            <img src="{{ service.image_mobile.url }}" class="responsive mobb7"
                                 alt="{{ service.name }}" title="{{ service.name }}" loading="lazy">
                        {% elif service.image %}
                            <img src="{{ service.image.url }}" class="responsive mobb7"
                                 alt="{{ service.name }}" title="{{ service.name }}" loading="lazy">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- ========================= –î—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏) ========================= -->
    {% if other_categories %}
    <section class="service serv2 mb-112">
        <div class="container"> 
            <h2>–î—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏</h2>
            <div class="row">
                {% for cat in other_categories %}
                {% if cat.image %}
                <div class="col-xxl-3 col-xl-4 col-md-4 col-sm-6">
                    <a href="{% url 'website:services' %}#category-{{ cat.id }}" class="item">
                        <img src="{{ cat.image.url }}" class="responsive mn"
                             alt="{{ cat.name }}" title="{{ cat.name }}" loading="lazy">
                        {% if cat.image_mobile %}
                        <img src="{{ cat.image_mobile.url }}" class="responsive mobb"
                             alt="{{ cat.name }}" title="{{ cat.name }}" loading="lazy">
                        {% else %}
                        <img src="{{ cat.image.url }}" class="responsive mobb"
                             alt="{{ cat.name }}" title="{{ cat.name }}" loading="lazy">
                        {% endif %}
                        <span class="semi d-flex align-items-center justify-content-center">{{ cat.name }}</span>
                    </a>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- ========================= –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ ========================= -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title semi" id="contactModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <!-- –°–≤–æ–¥–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div class="booking-summary mb-30" style="background: #f5f5f5; padding: 20px; border-radius: 8px;">
                        <div class="d-flex justify-content-between mb-10">
                            <span>–£—Å–ª—É–≥–∞:</span>
                            <strong id="summary-service"></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-10">
                            <span>–ú–∞—Å—Ç–µ—Ä:</span>
                            <strong id="summary-master"></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-10">
                            <span>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</span>
                            <strong id="summary-datetime"></strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <strong id="summary-price"></strong>
                        </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
                    <form id="contact-form">
                        <div class="in-form">
                            <input type="text" id="client-name" class="form-control"
                                   placeholder="–í–∞—à–µ –∏–º—è *" required>
                            <input type="tel" id="client-phone" class="form-control"
                                   placeholder="–¢–µ–ª–µ—Ñ–æ–Ω *" required>
                            <input type="email" id="client-email" class="form-control"
                                   placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                            <textarea id="client-comment" class="form-control" rows="3"
                                      placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                        </div>
                        
                        <div id="modal-alert"></div>
                        
                        <button type="submit" id="confirm-booking"
                                class="btn-black t-btn" style="width: 100%; margin-top: 15px;">
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================
const API_BASE_URL = '{{ request.scheme }}://{{ request.get_host }}';

// –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
let bookingData = {};
let availableDates = [];
let datePicker = null;
let isLoadingDates = false;
let isLoadingTimes = false;

// ============================================================
// –î–ê–ù–ù–´–ï –û–ü–¶–ò–ô –£–°–õ–£–ì–ò (–∏–∑ Django ‚Üí JS)
// ============================================================
const serviceOptions = [
    {% for opt in options %}
    {
        id: {{ opt.id }},
        duration: {{ opt.duration_min }},
        quantity: {{ opt.units }},
        unitType: '{{ opt.unit_type }}',
        unitTypeDisplay: '{{ opt.get_unit_type_display }}',
        price: {{ opt.price|floatformat:0 }},
        yclientsId: '{{ opt.yclients_service_id|default:"" }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫: {duration: {quantity: option}}
const optionsMap = {};
serviceOptions.forEach(opt => {
    if (!optionsMap[opt.duration]) optionsMap[opt.duration] = {};
    optionsMap[opt.duration][opt.quantity] = opt;
});

// ============================================================
// –£–¢–ò–õ–ò–¢–´
// ============================================================

function getOptionByDurationAndQuantity(duration, quantity) {
    return (optionsMap[duration] && optionsMap[duration][quantity]) || null;
}

function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU').format(price);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
}

function getCsrfToken() {
    const el = document.querySelector('[name=csrfmiddlewaretoken]');
    if (el) return el.value;
    // Fallback: –∏–∑ cookie
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
}

// –°–∫–ª–æ–Ω–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü: 1 –ø—Ä–æ—Ü–µ–¥—É—Ä–∞, 2 –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, 5 –ø—Ä–æ—Ü–µ–¥—É—Ä
function getQuantityLabel(quantity, unitType) {
    const last = quantity % 10;
    const lastTwo = quantity % 100;
    
    if (lastTwo >= 11 && lastTwo <= 14) {
        if (unitType === '–ø—Ä–æ—Ü–µ–¥—É—Ä—ã') return '–ø—Ä–æ—Ü–µ–¥—É—Ä';
        if (unitType === '–∑–æ–Ω—ã') return '–∑–æ–Ω';
        if (unitType === '–≤–∏–∑–∏—Ç—ã') return '–≤–∏–∑–∏—Ç–æ–≤';
        return unitType;
    }
    if (last === 1) {
        if (unitType === '–ø—Ä–æ—Ü–µ–¥—É—Ä—ã') return '–ø—Ä–æ—Ü–µ–¥—É—Ä–∞';
        if (unitType === '–∑–æ–Ω—ã') return '–∑–æ–Ω–∞';
        if (unitType === '–≤–∏–∑–∏—Ç—ã') return '–≤–∏–∑–∏—Ç';
        return unitType;
    }
    if (last >= 2 && last <= 4) return unitType;
    
    if (unitType === '–ø—Ä–æ—Ü–µ–¥—É—Ä—ã') return '–ø—Ä–æ—Ü–µ–¥—É—Ä';
    if (unitType === '–∑–æ–Ω—ã') return '–∑–æ–Ω';
    if (unitType === '–≤–∏–∑–∏—Ç—ã') return '–≤–∏–∑–∏—Ç–æ–≤';
    return unitType;
}

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –¥–Ω—è
function groupTimesByPeriod(times) {
    const periods = {
        'üåÖ –£—Ç—Ä–æ (9:00 ‚Äì 12:00)': [],
        '‚òÄÔ∏è –î–µ–Ω—å (12:00 ‚Äì 17:00)': [],
        'üåÜ –í–µ—á–µ—Ä (17:00 ‚Äì 21:00)': []
    };
    times.forEach(time => {
        const h = parseInt(time.split(':')[0]);
        if (h >= 9 && h < 12) periods['üåÖ –£—Ç—Ä–æ (9:00 ‚Äì 12:00)'].push(time);
        else if (h >= 12 && h < 17) periods['‚òÄÔ∏è –î–µ–Ω—å (12:00 ‚Äì 17:00)'].push(time);
        else if (h >= 17 && h < 21) periods['üåÜ –í–µ—á–µ—Ä (17:00 ‚Äì 21:00)'].push(time);
    });
    return periods;
}

// ============================================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –¶–ï–ù–´ –ò –û–ü–¶–ò–ò
// ============================================================

function updatePrice() {
    const durationEl = document.getElementById('duration-select');
    const quantityEl = document.getElementById('quantity-select');
    const priceEl = document.getElementById('price-display');
    const optionEl = document.getElementById('option-select');
    
    if (!durationEl || !priceEl) return;
    
    const duration = parseInt(durationEl.value);
    const quantity = parseInt(quantityEl ? quantityEl.value : '');
    
    if (duration && quantity) {
        const opt = getOptionByDurationAndQuantity(duration, quantity);
        if (opt) {
            priceEl.value = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatPrice(opt.price)} ‚ÇΩ`;
            if (optionEl) optionEl.value = opt.id;
            loadMasters();
            return;
        }
    }
    
    priceEl.value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ‚Äî ‚ÇΩ';
    if (optionEl) optionEl.value = '';
}

// ============================================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–ê (–ø—Ä–∏ —Å–º–µ–Ω–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
// ============================================================

function updateQuantityForDuration(duration) {
    const quantityDisplay = document.getElementById('quantity-display');
    const quantitySelect = document.getElementById('quantity-select');
    
    // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –¥–ª—è –≤—Å–µ—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
    const allQuantities = new Set();
    Object.values(optionsMap).forEach(dmap => {
        Object.keys(dmap).forEach(q => allQuantities.add(q));
    });
    if (allQuantities.size === 1 && quantityDisplay) {
        updatePrice();
        return;
    }
    
    if (!duration) {
        if (quantitySelect && quantitySelect.tagName === 'SELECT') {
            quantitySelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>';
        }
        updatePrice();
        return;
    }
    
    const durationInt = parseInt(duration);
    const quantities = optionsMap[durationInt]
        ? Object.keys(optionsMap[durationInt]).map(Number).sort((a, b) => a - b)
        : [];
    
    if (quantities.length === 0) {
        if (quantitySelect && quantitySelect.tagName === 'SELECT') {
            quantitySelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</option>';
        }
        updatePrice();
        return;
    }
    
    if (quantities.length === 1) {
        // –û–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ disabled input
        const opt = optionsMap[durationInt][quantities[0]];
        const container = (quantitySelect || quantityDisplay).parentElement;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã quantity
        const oldDisplay = document.getElementById('quantity-display');
        const oldSelect = document.getElementById('quantity-select');
        if (oldDisplay) oldDisplay.remove();
        if (oldSelect) oldSelect.remove();
        
        // –°–æ–∑–¥–∞—ë–º disabled input + hidden
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'text-def';
        inp.value = `${quantities[0]} ${getQuantityLabel(quantities[0], opt.unitTypeDisplay)}`;
        inp.disabled = true;
        inp.id = 'quantity-display';
        
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.id = 'quantity-select';
        hidden.value = quantities[0];
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ duration-select (–∏–ª–∏ –µ–≥–æ disabled-–≤–µ—Ä—Å–∏–∏)
        const durationEl = document.getElementById('duration-select');
        const insertAfter = durationEl.type === 'hidden'
            ? durationEl.previousElementSibling  // disabled input –ø–µ—Ä–µ–¥ hidden
            : durationEl;
        insertAfter.after(hidden);
        insertAfter.after(inp);
        
        updatePrice();
        return;
    }
    
    // –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å select
    const container = (quantitySelect || quantityDisplay).parentElement;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const oldDisplay = document.getElementById('quantity-display');
    const oldSelect = document.getElementById('quantity-select');
    if (oldDisplay) oldDisplay.remove();
    if (oldSelect) oldSelect.remove();
    
    const sel = document.createElement('select');
    sel.id = 'quantity-select';
    sel.className = 'form-select';
    sel.required = true;
    sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>';
    
    quantities.forEach(qty => {
        const opt = optionsMap[durationInt][qty];
        const o = document.createElement('option');
        o.value = qty;
        o.textContent = `${qty} ${getQuantityLabel(qty, opt.unitTypeDisplay)}`;
        sel.appendChild(o);
    });
    
    const durationEl = document.getElementById('duration-select');
    const insertAfter = durationEl.type === 'hidden'
        ? durationEl.previousElementSibling
        : durationEl;
    insertAfter.after(sel);
    
    updatePrice();
}

// ============================================================
// –°–ë–†–û–° –ü–û–õ–ï–ô (–ø—Ä–∏ —Å–º–µ–Ω–µ duration/quantity/master)
// ============================================================

function resetMasterAndBelow() {
    const masterSelect = document.getElementById('master-select');
    if (masterSelect) {
        masterSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
        masterSelect.value = '';
    }
    resetDateAndBelow();
}

function resetDateAndBelow() {
    const dateInput = document.getElementById('date-zapis');
    if (dateInput) {
        dateInput.value = '';
        dateInput.disabled = true;
        dateInput.placeholder = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞';
    }
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º Flatpickr
    if (datePicker) {
        try { datePicker.destroy(); } catch(e) {}
        datePicker = null;
    }
    
    availableDates = [];
    isLoadingDates = false;
    isLoadingTimes = false;
    
    resetTimeSelect();
}

function resetTimeSelect() {
    const timeSelect = document.getElementById('time-zapis');
    if (timeSelect) {
        timeSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>';
        timeSelect.disabled = true;
    }
}

// ============================================================
// API: –ó–ê–ì–†–£–ó–ö–ê –ú–ê–°–¢–ï–†–û–í
// ============================================================

async function loadMasters() {
    const optionEl = document.getElementById('option-select');
    if (!optionEl || !optionEl.value) {
        console.log('‚è∏Ô∏è –í–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω');
        return;
    }
    
    const serviceOptionId = optionEl.value;
    const select = document.getElementById('master-select');
    select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤...</option>';
    select.disabled = true;
    
    try {
        const url = `${API_BASE_URL}/api/booking/get_staff/?service_option_id=${serviceOptionId}`;
        console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤:', url);
        
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (data.success && data.data && data.data.length > 0) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
            data.data.forEach(master => {
                const o = document.createElement('option');
                o.value = master.id;
                o.textContent = master.name || '';
                if (master.specialization) o.textContent += ` (${master.specialization})`;
                select.appendChild(o);
            });
            console.log('‚úÖ –ú–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', data.data.length);
        } else {
            select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
            console.warn('‚ö†Ô∏è –ú–∞—Å—Ç–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤:', err);
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    } finally {
        select.disabled = false;
        resetDateAndBelow();
    }
}

// ============================================================
// API: –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –î–ê–¢
// ============================================================

async function loadAvailableDates(staffId) {
    if (!staffId || isLoadingDates) return;
    isLoadingDates = true;
    
    try {
        const url = `${API_BASE_URL}/api/booking/available_dates/?staff_id=${staffId}`;
        console.log('üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç:', url);
        
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (data.success && data.data && data.data.dates && data.data.dates.length > 0) {
            availableDates = data.data.dates;
            console.log('‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç:', availableDates.length);
            initializeDatePicker(staffId);
        } else {
            console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç');
            const dateInput = document.getElementById('date-zapis');
            if (dateInput) {
                dateInput.placeholder = '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –¥–∞—Ç';
                dateInput.disabled = true;
            }
        }
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç:', err);
    } finally {
        isLoadingDates = false;
    }
}

// ============================================================
// FLATPICKR: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø
// ============================================================

function initializeDatePicker(staffId) {
    const dateInput = document.getElementById('date-zapis');
    if (!dateInput || !availableDates.length) return;
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π
    if (datePicker) {
        try { datePicker.destroy(); } catch(e) {}
        datePicker = null;
    }
    
    dateInput.disabled = false;
    dateInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É';
    
    const firstDate = availableDates[0];
    
    datePicker = flatpickr(dateInput, {
        locale: 'ru',
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'j F Y (D)',
        minDate: availableDates[0],
        maxDate: availableDates[availableDates.length - 1],
        enable: availableDates,
        defaultDate: firstDate,
        disableMobile: false,
        allowInput: false,
        clickOpens: true,
        
        onChange: function(selectedDates, dateStr) {
            if (!dateStr || !staffId) return;
            resetTimeSelect();
            const timeSelect = document.getElementById('time-zapis');
            if (timeSelect) timeSelect.disabled = false;
            loadAvailableTimes(staffId, dateStr);
        },
        
        onReady: function() {
            console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–≤–æ–π –¥–∞—Ç—ã
            loadAvailableTimes(staffId, firstDate);
        }
    });
    
    // –ê–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏–µ
    if (datePicker) datePicker.open();
}

// ============================================================
// API: –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –í–†–ï–ú–Å–ù
// ============================================================

let timesDebounceTimer = null;

async function loadAvailableTimes(staffId, date) {
    // Debounce 300ms
    clearTimeout(timesDebounceTimer);
    timesDebounceTimer = setTimeout(() => _loadAvailableTimes(staffId, date), 300);
}

async function _loadAvailableTimes(staffId, date) {
    if (isLoadingTimes) return;
    isLoadingTimes = true;
    
    const timeSelect = document.getElementById('time-zapis');
    const optionEl = document.getElementById('option-select');
    const serviceOptionId = optionEl ? optionEl.value : '';
    
    timeSelect.disabled = true;
    timeSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    
    try {
        let url = `${API_BASE_URL}/api/booking/available_times/?staff_id=${staffId}&date=${date}`;
        if (serviceOptionId) url += `&service_option_id=${serviceOptionId}`;
        console.log('‚è∞ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:', url);
        
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (data.success && data.data && data.data.times && data.data.times.length > 0) {
            const times = data.data.times;
            const grouped = groupTimesByPeriod(times);
            
            timeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>';
            
            for (const [period, periodTimes] of Object.entries(grouped)) {
                if (periodTimes.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = period;
                    periodTimes.forEach(time => {
                        const o = document.createElement('option');
                        o.value = time;
                        o.textContent = time;
                        optgroup.appendChild(o);
                    });
                    timeSelect.appendChild(optgroup);
                }
            }
            
            console.log(`‚úÖ –°–ª–æ—Ç–æ–≤: ${times.length}`);
        } else {
            timeSelect.innerHTML = '<option value="">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –≤—Å—ë –∑–∞–Ω—è—Ç–æ</option>';
        }
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏:', err);
        timeSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    } finally {
        timeSelect.disabled = false;
        isLoadingTimes = false;
    }
}

// ============================================================
// –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–ò–°–ò (–∫–ª–∏–∫ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω¬ª)
// ============================================================

function handleBookingSubmit() {
    const optionEl = document.getElementById('option-select');
    const durationEl = document.getElementById('duration-select');
    const quantityEl = document.getElementById('quantity-select');
    const masterSelect = document.getElementById('master-select');
    const dateInput = document.getElementById('date-zapis');
    const timeSelect = document.getElementById('time-zapis');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!durationEl || !durationEl.value) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'); return; }
    
    const quantity = quantityEl ? quantityEl.value : '';
    if (!quantity) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'); return; }
    
    const serviceOptionId = optionEl ? optionEl.value : '';
    if (!serviceOptionId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏'); return; }
    
    if (!masterSelect || !masterSelect.value) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞'); return; }
    
    const date = dateInput ? dateInput.value : '';
    if (!date) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; }
    
    const time = timeSelect ? timeSelect.value : '';
    if (!time) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è'); return; }
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
    const opt = getOptionByDurationAndQuantity(
        parseInt(durationEl.value),
        parseInt(quantity)
    );
    if (!opt) { alert('–û—à–∏–±–∫–∞: –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    
    const masterName = masterSelect.options[masterSelect.selectedIndex].text;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    bookingData = {
        staff_id: parseInt(masterSelect.value),
        service_ids: [parseInt(opt.yclientsId)],
        date: date,
        time: time,
        master_name: masterName,
        service_name: '{{ service.name|escapejs }}',
        service_price: opt.price
    };
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–¥–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.getElementById('summary-service').textContent = '{{ service.name|escapejs }}';
    document.getElementById('summary-master').textContent = masterName;
    document.getElementById('summary-datetime').textContent = `${formatDate(date)} –≤ ${time}`;
    document.getElementById('summary-price').textContent = `${formatPrice(opt.price)} ‚ÇΩ`;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º Bootstrap modal
    const modal = new bootstrap.Modal(document.getElementById('contactModal'));
    modal.show();
}

// ============================================================
// –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò (—Ñ–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
// ============================================================

async function handleConfirmBooking(e) {
    e.preventDefault();
    
    const btn = document.getElementById('confirm-booking');
    const originalText = btn.textContent;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å...';
    btn.disabled = true;
    
    const requestData = {
        ...bookingData,
        client: {
            name: document.getElementById('client-name').value.trim(),
            phone: document.getElementById('client-phone').value.replace(/\D/g, ''),
            email: document.getElementById('client-email').value.trim() || 'no-email@formulatela.ru'
        },
        comment: document.getElementById('client-comment').value.trim()
    };
    
    try {
        const resp = await fetch(`${API_BASE_URL}/api/booking/create/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await resp.json();
        
        if (resp.ok && data.success) {
            showModalAlert('‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞! ID: ' + data.data.booking_id, 'success');
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showModalAlert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏'), 'danger');
            btn.textContent = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', err);
        showModalAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'danger');
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

function showModalAlert(message, type) {
    document.getElementById('modal-alert').innerHTML =
        `<div class="alert alert-${type} mt-15">${message}</div>`;
}

// ============================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –û–î–ò–ù DOMContentLoaded
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
    console.log('üì¶ –û–ø—Ü–∏–π —É—Å–ª—É–≥–∏:', serviceOptions.length);
    
    // ---- 1. –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º—ã ----
    const form = document.getElementById('booking-form');
    if (form) {
        form.addEventListener('change', function(e) {
            const id = e.target.id;
            
            if (id === 'duration-select') {
                updateQuantityForDuration(e.target.value);
                resetMasterAndBelow();
            }
            
            if (id === 'quantity-select') {
                updatePrice();
                // –ï—Å–ª–∏ option-select —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∏–∑ updatePrice
            }
            
            if (id === 'master-select') {
                const staffId = e.target.value;
                resetDateAndBelow();
                if (staffId) {
                    loadAvailableDates(staffId);
                }
            }
        });
    }
    
    // ---- 2. –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω¬ª ----
    const submitBtn = document.getElementById('submit-booking');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            handleBookingSubmit();
        });
    }
    
    // ---- 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ ----
    const contactForm = document.getElementById('contact-form');
    if (contactForm) {
        contactForm.addEventListener('submit', handleConfirmBooking);
    }
    
    // ---- 4. –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç) ----
    const durationEl = document.getElementById('duration-select');
    const quantityEl = document.getElementById('quantity-select');
    const optionEl = document.getElementById('option-select');
    
    if (durationEl && durationEl.value) {
        const duration = parseInt(durationEl.value);
        const quantity = quantityEl ? parseInt(quantityEl.value) : null;
        
        if (duration && quantity) {
            const opt = getOptionByDurationAndQuantity(duration, quantity);
            if (opt && optionEl) {
                optionEl.value = opt.id;
                updatePrice();
                // –ú–∞—Å—Ç–µ—Ä–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ updatePrice()
                console.log('üìã –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤');
            }
        }
    }
});
</script>
{% endblock %}
