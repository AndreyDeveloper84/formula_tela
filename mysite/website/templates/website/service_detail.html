{% extends 'website/base.html' %}
{% load static %}

{% block title %}{{ service.name }} | {{ settings.salon_name|default:"–°—Ç—É–¥–∏—è —ç—Å—Ç–µ—Ç–∏–∫–∏ –§–æ—Ä–º—É–ª–∞ –¢–µ–ª–∞" }}{% endblock %}

{% block extra_css %}
<style>
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
    .modal-contact {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }
    
    .modal-contact.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-contact-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-contact-close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        line-height: 1;
    }
    
    .modal-contact-close:hover {
        color: #000;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #000;
    }
    
    .booking-summary {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .booking-summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .booking-summary-item:last-child {
        margin-bottom: 0;
    }
    
    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .btn-loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .service-image {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        padding: 20px;
    }
    
    /* ============================================
       –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø FLATPICKR –ö–ê–õ–ï–ù–î–ê–†–Ø
       ============================================ */
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (–∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ) */
    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
        background: #6366f1 !important;
        border-color: #6366f1 !important;
    }
    
    /* Hover —ç—Ñ—Ñ–µ–∫—Ç */
    .flatpickr-day:hover {
        background: #e0e7ff !important;
        border-color: #c7d2fe !important;
    }
    
    /* –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å */
    .flatpickr-day.today {
        border-color: #6366f1 !important;
    }
    
    /* –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã (—Å–µ—Ä—ã–µ) */
    .flatpickr-day.disabled,
    .flatpickr-day.disabled:hover {
        color: #d1d5db !important;
        background: transparent !important;
        cursor: not-allowed !important;
    }
    
    /* –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .flatpickr-months .flatpickr-prev-month:hover svg,
    .flatpickr-months .flatpickr-next-month:hover svg {
        fill: #6366f1 !important;
    }
    
    /* ============================================
       –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø –í–´–ë–û–†–ê –í–†–ï–ú–ï–ù–ò
       ============================================ */
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ */
    .time-select-wrapper {
        position: relative;
        margin-top: 20px;
    }
    
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è SELECT –≤—Ä–µ–º–µ–Ω–∏ */
    #time-zapis {
        width: 100%;
        padding: 14px 16px;
        padding-right: 40px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
        font-size: 16px;
        font-weight: 500;
        color: #1f2937;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }
    
    #time-zapis:hover {
        border-color: #c7d2fe;
        background: #fafafa;
    }
    
    #time-zapis:focus {
        outline: none;
        border-color: #6366f1;
        background: white;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    #time-zapis:disabled {
        background: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }
    
    /* –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –¥–ª—è SELECT */
    .time-select-wrapper::after {
        content: '‚è∞';
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        pointer-events: none;
    }
    
    /* –û–ø—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ SELECT */
    #time-zapis option {
        padding: 12px;
        font-size: 15px;
    }
    
    /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏ */
    #time-zapis option[disabled] {
        font-weight: 700;
        color: #6366f1;
        background: #f3f4f6;
        font-size: 13px;
        letter-spacing: 0.5px;
    }
    
    /* ============================================
       –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò
       ============================================ */
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        z-index: 10;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* ============================================
       –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
       ============================================ */
    
    @media (max-width: 768px) {
        .flatpickr-calendar {
            font-size: 16px !important;
        }
        
        .flatpickr-day {
            height: 42px !important;
            line-height: 42px !important;
        }
        
        #time-zapis {
            font-size: 17px; /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —á—É—Ç—å –±–æ–ª—å—à–µ */
            padding: 16px;
        }
        
        .time-select-wrapper::after {
            font-size: 20px;
        }
    }
    
    /* ============================================
       BADGE –° –ö–û–õ–ò–ß–ï–°–¢–í–û–ú –î–û–°–¢–£–ü–ù–´–• –°–õ–û–¢–û–í
       ============================================ */
    
    .time-badge {
        display: inline-block;
        background: #6366f1;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
        vertical-align: middle;
    }
    
    .time-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        font-weight: 600;
        color: #1f2937;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .form-select,
    .form-control,
    .text-def {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 15px;
        width: 100%;
        font-size: 16px;
    }
    
    .form-select:focus,
    .form-control:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }
    
    .text-def {
        background: #f5f5f5;
        color: #666;
    }
    
    .submit {
        width: 100%;
        margin-top: 10px;
    }
    
    .in-form {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
    <!-- ========================= –ë–∞–Ω–Ω–µ—Ä —É—Å–ª—É–≥–∏ ========================= -->
    <section class="banner2 cat1">
        <div class="container"> 
            <div class="b2 d-flex flex-column">
                <h2 class="wow fadeInUp" data-wow-delay=".2s">{{ service.name }}</h2>
                {% if service.description %}
                    <p class="text-banner wow fadeInUp" data-wow-delay=".4s">{{ service.description|linebreaks }}</p>
                {% endif %}
            </div>
        </div>
    </section>
    
    <!-- ========================= –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ========================= -->
    <section class="service serv3 mb-72">
        <div class="container"> 
            <div class="row">
                <div class="col-lg-6">
                    <h2 class="mb-4 wow fadeInUp" data-wow-delay=".2s">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É</h2>
                    
                    <!-- –§–û–†–ú–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø -->
                    <form id="booking-form" class="mt-4">
                        <div class="in-form">
                            <!-- –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Å–ª—É–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ) -->
                            {% if service.options_filtered.count > 1 %}
                            <select 
                                id="option-select" 
                                class="form-select" 
                                required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>
                                {% for opt in service.options_filtered %}
                                <option 
                                    value="{{ opt.id }}"
                                    data-yclients-id="{{ opt.yclients_service_id }}"
                                    data-duration="{{ opt.duration_min }}"
                                    data-price="{{ opt.price }}">
                                    {{ opt.duration_min }} –º–∏–Ω ‚Äî {{ opt.price|floatformat:0 }} ‚ÇΩ
                                </option>
                                {% endfor %}
                            </select>
                            {% elif service.options_filtered.count == 1 %}
                            <!-- –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ disabled -->
                            {% with opt=service.options_filtered.0 %}
                            <input type="text" class="text-def" value="{{ opt.duration_min }} –º–∏–Ω—É—Ç" disabled>
                            <input 
                                type="hidden" 
                                id="option-select" 
                                value="{{ opt.id }}"
                                data-yclients-id="{{ opt.yclients_service_id }}"
                                data-duration="{{ opt.duration_min }}"
                                data-price="{{ opt.price }}">
                            {% endwith %}
                            {% else %}
                            <!-- –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏ -->
                            <div class="alert alert-warning">
                                –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏
                            </div>
                            {% endif %}
                            
                            <!-- –í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞ -->
                            <select 
                                id="master-select" 
                                class="form-select" 
                                required>
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤...</option>
                            </select>
                            
                            <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
                            <input 
                                type="date" 
                                id="date-zapis" 
                                class="form-control" 
                                required>
                            
                            <!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ (SELECT –≤–º–µ—Å—Ç–æ INPUT) -->
                            <div class="time-select-wrapper">
                                <label class="time-label" for="time-zapis">
                                    <span>–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏</span>
                                    <span id="time-badge" class="time-badge" style="display: none;">0 —Å–ª–æ—Ç–æ–≤</span>
                                </label>
                                <select id="time-zapis" class="form-select" required>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞ –∏ –¥–∞—Ç—É</option>
                                </select>
                                <div class="loading-overlay" id="time-loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                            
                            <!-- –°—Ç–æ–∏–º–æ—Å—Ç—å -->
                            <input 
                                type="text" 
                                id="price-display" 
                                class="text-def" 
                                value="–°—Ç–æ–∏–º–æ—Å—Ç—å: {% if service.options_filtered.count == 1 %}{{ service.options_filtered.0.price|floatformat:0 }}{% else %}‚Äî{% endif %} ‚ÇΩ" 
                                disabled>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ -->
                        <button 
                            type="submit" 
                            id="submit-booking" 
                            class="btn-black t-btn submit">
                            –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω
                        </button>
                    </form>	
                </div>
                
                <div class="col-lg-6">
                    <div class="service-image wow fadeInUp" data-wow-delay=".4s">
                        {% if service.image %}
                            <img src="{{ service.image.url }}" alt="{{ service.name }}" class="img-fluid" style="max-height: 100%; width: 100%; object-fit: cover; border-radius: 12px;">
                        {% else %}
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                                <div>{{ service.name }}</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <div id="contact-modal" class="modal-contact">
        <div class="modal-contact-content">
            <span class="modal-contact-close" onclick="closeContactModal()">&times;</span>
            
            <h3 style="margin-bottom: 20px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
            
            <!-- –°–≤–æ–¥–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="booking-summary">
                <div class="booking-summary-item">
                    <span>–£—Å–ª—É–≥–∞:</span>
                    <strong id="summary-service"></strong>
                </div>
                <div class="booking-summary-item">
                    <span>–ú–∞—Å—Ç–µ—Ä:</span>
                    <strong id="summary-master"></strong>
                </div>
                <div class="booking-summary-item">
                    <span>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</span>
                    <strong id="summary-datetime"></strong>
                </div>
                <div class="booking-summary-item">
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                    <strong id="summary-price"></strong>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
            <form id="contact-form">
                <div class="form-group">
                    <label for="client-name">–í–∞—à–µ –∏–º—è *</label>
                    <input 
                        type="text" 
                        id="client-name" 
                        placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" 
                        required>
                </div>
                
                <div class="form-group">
                    <label for="client-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input 
                        type="tel" 
                        id="client-phone" 
                        placeholder="+7 (900) 123-45-67" 
                        required>
                </div>
                
                <div class="form-group">
                    <label for="client-email">Email</label>
                    <input 
                        type="email" 
                        id="client-email" 
                        placeholder="email@example.com">
                </div>
                
                <div class="form-group">
                    <label for="client-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea 
                        id="client-comment" 
                        rows="3"
                        placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                </div>
                
                <div id="modal-alert"></div>
                
                <button 
                    type="submit" 
                    id="confirm-booking" 
                    class="btn-black t-btn" 
                    style="width: 100%; margin-top: 10px;">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const API_BASE_URL = '{{ request.scheme }}://{{ request.get_host }}';
    
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
    let bookingData = {};
    let availableDates = [];
    let datePicker = null;
    
    // ========== –ó–ê–ì–†–£–ó–ö–ê –ú–ê–°–¢–ï–†–û–í ==========
    async function loadMasters() {
        try {
            // –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏
            const optionElem = document.getElementById('option-select');
            let serviceOptionId = null;
            
            if (!optionElem) {
                console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç option-select –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (optionElem.tagName === 'SELECT') {
                // –ï—Å–ª–∏ —ç—Ç–æ select - –±–µ—Ä–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                serviceOptionId = optionElem.value;
                
                // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
                if (!serviceOptionId) {
                    const select = document.getElementById('master-select');
                    select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
                    console.log('‚è∏Ô∏è –í–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω, –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è');
                    return;
                }
            } else {
                // –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —É—Å–ª—É–≥–∏ - —Å—Ä–∞–∑—É –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                serviceOptionId = optionElem.value;
            }
            
            if (!serviceOptionId) {
                console.warn('‚ö†Ô∏è serviceOptionId –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —É—Å–ª—É–≥–µ
            const url = `${API_BASE_URL}/api/booking/get_staff/?service_option_id=${serviceOptionId}`;
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Å–ª—É–≥–∏:', serviceOptionId);
            
            const select = document.getElementById('master-select');
            select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤...</option>';
            select.disabled = true;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.data) {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                
                if (data.data.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏</option>';
                    console.warn('‚ö†Ô∏è –ù–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏');
                    select.disabled = false;
                    return;
                }
                
                data.data.forEach(master => {
                    const option = document.createElement('option');
                    option.value = master.id;
                    option.textContent = master.name;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (master.specialization) {
                        option.textContent += ` (${master.specialization})`;
                    }
                    
                    select.appendChild(option);
                });
                
                console.log('‚úÖ –ú–∞—Å—Ç–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data.data.length);
            } else {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ API:', data.error || 'Unknown error');
            }
            
            select.disabled = false;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤:', error);
            const select = document.getElementById('master-select');
            select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
            select.disabled = false;
        }
    }

    // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    function initializeEmptyDatePicker() {
        const dateInput = document.getElementById('date-zapis');
        
        if (datePicker) {
            return; // –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
        }
        
        datePicker = flatpickr(dateInput, {
            locale: 'ru',
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'j F Y (D)',
            enable: [], // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ = –≤—Å–µ –¥–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            allowInput: false,
            disableMobile: false,
            clickOpens: false, // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω –º–∞—Å—Ç–µ—Ä
            
            onReady: function(selectedDates, dateStr, instance) {
                console.log('üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤');
            }
        });
    }
    
    // –§–ª–∞–≥–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    let isLoadingDates = false;
    let isLoadingTimes = false;
    let lastRequestedDate = null;
    let lastRequestedStaffId = null;

    // ========== –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –î–ê–¢ ==========
    async function loadAvailableDates(staffId) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        if (isLoadingDates) {
            console.log('‚è∏Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å');
            return;
        }
        
        // –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if (lastRequestedStaffId === staffId && availableDates.length > 0) {
            console.log('‚è∏Ô∏è –î–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            return;
        }
        
        isLoadingDates = true;
        lastRequestedStaffId = staffId;
        
        try {
            const url = `${API_BASE_URL}/api/booking/available_dates/?staff_id=${staffId}`;
            console.log('üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞:', staffId);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.data && data.data.dates) {
                availableDates = data.data.dates;
                
                if (availableDates.length > 0) {
                    console.log('‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç:', availableDates.length);
                    initializeDatePicker(staffId);
                } else {
                    console.log('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞');
                    alert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏');
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç:', error);
        } finally {
            isLoadingDates = false;
        }
    }

    function initializeDatePicker(staffId) {
        const dateInput = document.getElementById('date-zapis');
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å
        if (datePicker) {
            datePicker.destroy();
            datePicker = null;
        }
        
        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        let isInitializing = true;
        const firstDate = availableDates[0];
        
        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        datePicker = flatpickr(dateInput, {
            locale: 'ru',
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'j F Y (D)',
            minDate: availableDates[0],
            maxDate: availableDates[availableDates.length - 1],
            enable: availableDates,
            defaultDate: firstDate,
            disableMobile: false,
            allowInput: false,
            clickOpens: true,
            
            // ‚úÖ onChange —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            onChange: function(selectedDates, dateStr, instance) {
                console.log('üìÖ –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞:', dateStr, 'isInitializing:', isInitializing);
                
                if (!dateStr || !staffId) {
                    return;
                }
                
                // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É (–±–µ–∑ debounce –¥–ª—è –ø–µ—Ä–≤–æ–π –¥–∞—Ç—ã)
                if (isInitializing && dateStr === firstDate) {
                    isInitializing = false;
                    console.log('üöÄ –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –¥–∞—Ç—ã:', firstDate);
                    loadAvailableTimes(staffId, firstDate);
                } else if (!isInitializing) {
                    // –î–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º debounce
                    debouncedLoadTimes(staffId, dateStr);
                }
            },
            
            onReady: function(selectedDates, dateStr, instance) {
                console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤ —Å', availableDates.length, '–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏');
                isInitializing = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            },
            
            onOpen: function() {
                console.log('üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–∫—Ä—ã—Ç');
            }
        });
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        datePicker.open();
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // –û–±—ë—Ä–Ω—É—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è loadAvailableTimes —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º debounce
    const debouncedLoadTimes = debounce(loadAvailableTimes, 500);

    // ========== –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –í–†–ï–ú–Å–ù ==========
    async function loadAvailableTimes(staffId, date) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        const requestKey = `${staffId}_${date}`;
        if (isLoadingTimes) {
            console.log('‚è∏Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å');
            return;
        }
        
        if (lastRequestedDate === requestKey) {
            console.log('‚è∏Ô∏è –í—Ä–µ–º—è –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è/–∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            return;
        }
        
        isLoadingTimes = true;
        lastRequestedDate = requestKey;
        
        const timeSelect = document.getElementById('time-zapis');
        const loadingOverlay = document.getElementById('time-loading');
        const timeBadge = document.getElementById('time-badge');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        if (loadingOverlay) {
            loadingOverlay.classList.add('active');
        }
        timeSelect.disabled = true;
        
        try {
            const url = `${API_BASE_URL}/api/booking/available_times/?staff_id=${staffId}&date=${date}`;
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:', url);
            
            const response = await fetch(url);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
            if (!response.ok) {
                console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì¶ –û—Ç–≤–µ—Ç –æ—Ç API:', data);
            
            if (data.success && data.data && data.data.times) {
                const times = data.data.times;
                
                if (times.length > 0) {
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
                    const grouped = groupTimesByPeriod(times);
                    
                    // –û—á–∏—â–∞–µ–º select
                    timeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</option>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º
                    for (const [period, periodTimes] of Object.entries(grouped)) {
                        if (periodTimes.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = period;
                            
                            periodTimes.forEach(time => {
                                const option = document.createElement('option');
                                option.value = time;
                                option.textContent = time;
                                optgroup.appendChild(option);
                            });
                            
                            timeSelect.appendChild(optgroup);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º badge
                    if (timeBadge) {
                        timeBadge.textContent = `${times.length} ${getSlotWord(times.length)}`;
                        timeBadge.style.display = 'inline-block';
                    }
                    
                    console.log('‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–æ—Ç–æ–≤:', times.length);
                } else {
                    // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                    console.log('‚ö†Ô∏è –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É');
                    timeSelect.innerHTML = '<option value="">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –≤—Å–µ –∑–∞–Ω—è—Ç–æ</option>';
                    if (timeBadge) {
                        timeBadge.style.display = 'none';
                    }
                }
            } else {
                // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API
                console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:', data);
                timeSelect.innerHTML = '<option value="">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</option>';
                if (timeBadge) {
                    timeBadge.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏:', error);
            timeSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑</option>';
            if (timeBadge) {
                timeBadge.style.display = 'none';
            }
        } finally {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
            timeSelect.disabled = false;
            isLoadingTimes = false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –¥–Ω—è
    function groupTimesByPeriod(times) {
        const periods = {
            'üåÖ –£—Ç—Ä–æ (9:00 - 12:00)': [],
            '‚òÄÔ∏è –î–µ–Ω—å (12:00 - 17:00)': [],
            'üåÜ –í–µ—á–µ—Ä (17:00 - 21:00)': []
        };
        
        times.forEach(time => {
            const hour = parseInt(time.split(':')[0]);
            
            if (hour >= 9 && hour < 12) {
                periods['üåÖ –£—Ç—Ä–æ (9:00 - 12:00)'].push(time);
            } else if (hour >= 12 && hour < 17) {
                periods['‚òÄÔ∏è –î–µ–Ω—å (12:00 - 17:00)'].push(time);
            } else if (hour >= 17 && hour < 21) {
                periods['üåÜ –í–µ—á–µ—Ä (17:00 - 21:00)'].push(time);
            }
        });
        
        return periods;
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "—Å–ª–æ—Ç"
    function getSlotWord(count) {
        const cases = [2, 0, 1, 1, 1, 2];
        const words = ['—Å–ª–æ—Ç', '—Å–ª–æ—Ç–∞', '—Å–ª–æ—Ç–æ–≤'];
        return words[(count % 100 > 4 && count % 100 < 20) ? 2 : cases[Math.min(count % 10, 5)]];
    }
        
    // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ó–ú–ï–ù–ï–ù–ò–ô ==========
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Å–ª—É–≥–∏
    const optionSelect = document.getElementById('option-select');
    if (optionSelect && optionSelect.tagName === 'SELECT') {
        optionSelect.addEventListener('change', function(e) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            
            if (!e.target.value) {
                // –í–∞—Ä–∏–∞–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω - –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('master-select').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
                document.getElementById('date-zapis').value = '';
                document.getElementById('time-zapis').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                document.getElementById('price-display').value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ‚Äî ‚ÇΩ';
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                if (datePicker) {
                    datePicker.destroy();
                    datePicker = null;
                }
                return;
            }
            
            const price = selectedOption.dataset.price;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
            if (price) {
                document.getElementById('price-display').value = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatPrice(price)} ‚ÇΩ`;
            }
            
            // ‚úÖ –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –ú–ê–°–¢–ï–†–û–í –î–õ–Ø –ù–û–í–û–ô –£–°–õ–£–ì–ò
            console.log('üîÑ –í–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏ –∏–∑–º–µ–Ω—ë–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤...');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            lastRequestedDate = null;
            lastRequestedStaffId = null;
            availableDates = [];
            isLoadingDates = false;
            isLoadingTimes = false;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('master-select').value = '';
            document.getElementById('date-zapis').value = '';
            document.getElementById('time-zapis').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            if (datePicker) {
                datePicker.destroy();
                datePicker = null;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è –Ω–æ–≤–æ–π —É—Å–ª—É–≥–∏
            loadMasters();
        });
    }
    
    // ‚úÖ –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è master-select
    document.getElementById('master-select').addEventListener('change', function(e) {
        const staffId = e.target.value;
        
        if (staffId) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            lastRequestedDate = null;
            lastRequestedStaffId = null;
            availableDates = [];
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏
            const timeSelect = document.getElementById('time-zapis');
            timeSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            if (datePicker) {
                datePicker.destroy();
                datePicker = null;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
            loadAvailableDates(staffId);
        } else {
            // –û—á–∏—â–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
            document.getElementById('date-zapis').value = '';
            document.getElementById('time-zapis').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
            availableDates = [];
            lastRequestedDate = null;
            lastRequestedStaffId = null;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            if (datePicker) {
                datePicker.destroy();
                datePicker = null;
            }
        }
    });
    
    // ========== –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ==========
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const optionElem = document.getElementById('option-select');
        const masterSelect = document.getElementById('master-select');
        const timeSelect = document.getElementById('time-zapis');
        
        let selectedOption, yclientsServiceId, duration, price;
        
        if (optionElem.tagName === 'SELECT') {
            selectedOption = optionElem.options[optionElem.selectedIndex];
            yclientsServiceId = selectedOption.dataset.yclientsId;
            duration = selectedOption.dataset.duration;
            price = selectedOption.dataset.price;
        } else {
            // Hidden input - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç
            yclientsServiceId = optionElem.dataset.yclientsId;
            duration = optionElem.dataset.duration;
            price = optionElem.dataset.price;
        }
        
        const staffId = masterSelect.value;
        const masterName = masterSelect.options[masterSelect.selectedIndex].text;
        const date = document.getElementById('date-zapis').value;
        const time = timeSelect.value;
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!yclientsServiceId || !staffId || !date || !time) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        bookingData = {
            staff_id: parseInt(staffId),
            service_ids: [parseInt(yclientsServiceId)],
            date: date,
            time: time,
            master_name: masterName,
            service_name: '{{ service.name|escapejs }}',
            service_price: price
        };
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–¥–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        document.getElementById('summary-service').textContent = '{{ service.name|escapejs }}';
        document.getElementById('summary-master').textContent = masterName;
        document.getElementById('summary-datetime').textContent = `${formatDate(date)} –≤ ${time}`;
        document.getElementById('summary-price').textContent = `${formatPrice(price)} ‚ÇΩ`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('contact-modal').classList.add('active');
    });
    
    // ========== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò ==========
    document.getElementById('contact-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('confirm-booking');
        const originalText = btn.textContent;
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        btn.innerHTML = '<span class="spinner"></span> –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å...';
        btn.classList.add('btn-loading');
        
        // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
        const clientData = {
            name: document.getElementById('client-name').value.trim(),
            phone: document.getElementById('client-phone').value.replace(/\D/g, ''),
            email: document.getElementById('client-email').value.trim() || 'no-email@formulatela.ru'
        };
        
        const comment = document.getElementById('client-comment').value.trim();
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        const requestData = {
            ...bookingData,
            client: clientData,
            comment: comment
        };
        
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', requestData);
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/booking/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (response.ok && data.success) {
                // –£—Å–ø–µ—Ö!
                showModalAlert('‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ! ID: ' + data.data.booking_id, 'success');
                
                // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                // –û—à–∏–±–∫–∞
                const errorMsg = data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏';
                showModalAlert('‚ùå ' + errorMsg, 'error');
                btn.textContent = originalText;
                btn.classList.remove('btn-loading');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            showModalAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            btn.textContent = originalText;
            btn.classList.remove('btn-loading');
        }
    });
    
    // ========== –£–¢–ò–õ–ò–¢–´ ==========
    function closeContactModal() {
        document.getElementById('contact-modal').classList.remove('active');
        document.getElementById('contact-form').reset();
        document.getElementById('modal-alert').innerHTML = '';
    }
    
    function showModalAlert(message, type) {
        const alertDiv = document.getElementById('modal-alert');
        alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return date.toLocaleDateString('ru-RU', options);
    }
    
    function formatPrice(price) {
        return parseInt(price).toLocaleString('ru-RU');
    }
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', function() {
        initializeEmptyDatePicker();
        
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏
        const optionElem = document.getElementById('option-select');
        if (optionElem) {
            if (optionElem.tagName === 'INPUT' && optionElem.value) {
                // –ï—Å–ª–∏ —ç—Ç–æ —Å–∫—Ä—ã—Ç—ã–π input —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º - —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤
                console.log('üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤...');
                loadMasters();
            } else if (optionElem.tagName === 'SELECT') {
                // –ï—Å–ª–∏ —ç—Ç–æ select - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–æ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
                console.log('üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —É—Å–ª—É–≥–∏, –∂–¥—ë–º –≤—ã–±–æ—Ä–∞...');
                const select = document.getElementById('master-select');
                select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
            }
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-zapis').min = today;
    });
</script>
{% endblock %}
