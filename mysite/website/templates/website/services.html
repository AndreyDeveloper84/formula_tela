{% extends "website/base.html" %}
{% load service_extras humanize %}
{% block title %}Услуги — {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1 class="text-3xl font-bold mb-6">Услуги</h1>

{% for cat in categories %}
  <h2 class="mb-4">{{ cat.name }}</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for s in cat.services.all %}
    {% if s.is_active %}
    <div class="p-5 rounded-2xl shadow bg-white">
      <h3 class="text-lg font-semibold mb-2">{{ s.name }}</h3>
      {% if s.options.all %}
        <form method="get">
          <label class="block text-sm mb-1">Вариант</label>
          <select id="opt-{{ s.id }}" class="w-full border rounded px-3 py-2 mb-3">
            {% for opt in s.options.all %}
              {% if opt.is_active %}
                <option
                  value="{{ opt.id }}"
                  data-yclients-id="{{ opt.yclients_service_id }}"
                  data-duration="{{ opt.duration_min }}"
                  data-units="{{ opt.units }}"
                  data-unit-type="{{ opt.unit_type }}"
                  data-price="{{ opt.price }}"
                >
                  {{ opt|option_label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          <a class="btn" 
             href="#" 
             onclick="openYClientsModal('opt-{{ s.id }}'); return false;">
            Записаться
          </a>
        </form>
      {% else %}
        <p class="text-sm text-gray-500">Нет активных вариантов</p>
      {% endif %}
    </div>
    {% endif %}
  {% endfor %}
  </div>
{% endfor %}

{# Модальное окно с iframe #}
<div id="yclients-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999;">
  <div style="position:relative; width:90%; max-width:1000px; height:90%; margin:5% auto; background:white; border-radius:10px; overflow:hidden;">
    <button onclick="closeYClientsModal()" style="position:absolute; top:10px; right:10px; z-index:10000; background:red; color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:5px; font-size:18px;">✕ Закрыть</button>
    <iframe id="yclients-iframe" src="" style="width:100%; height:100%; border:none;"></iframe>
  </div>
</div>

<script>
function openYClientsModal(selectId) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  const selectedOption = select.options[select.selectedIndex];
  const serviceId = selectedOption.getAttribute('data-yclients-id');
  
  // Базовый URL
  const companyId = "{{ settings.yclients_company_id }}";
  let url = `https://n951024.yclients.com/company/${companyId}`;
  
  // Если есть service_id - пробуем добавить (может и не сработает, но попробуем)
  if (serviceId && serviceId !== 'None' && serviceId !== '' && serviceId !== 'null') {
    url += `?o=s${serviceId}`;
  }
  
  console.log("Открываем iframe с URL:", url);
  
  // Загружаем в iframe
  document.getElementById('yclients-iframe').src = url;
  
  // Показываем модальное окно
  document.getElementById('yclients-modal').style.display = 'block';
}

function closeYClientsModal() {
  document.getElementById('yclients-modal').style.display = 'none';
  document.getElementById('yclients-iframe').src = '';
}

// Закрытие по клику вне окна
document.getElementById('yclients-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeYClientsModal();
  }
});

// Закрытие по Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeYClientsModal();
  }
});
</script>

{% endblock %}