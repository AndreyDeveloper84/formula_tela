{% extends "website/base.html" %}
{% load service_extras humanize %}
{% block title %}–£—Å–ª—É–≥–∏ ‚Äî {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1 class="text-3xl font-bold mb-6">–£—Å–ª—É–≥–∏</h1>

{% for cat in categories %}
  <h2 class="mb-4">{{ cat.name }}</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for s in cat.services.all %}
    {% if s.is_active %}
    <div class="p-5 rounded-2xl shadow bg-white">
      <h3 class="text-lg font-semibold mb-2">{{ s.name }}</h3>
      
      {% if s.options.all %}
        <div>
          <label class="block text-sm mb-1">–í–∞—Ä–∏–∞–Ω—Ç</label>
          <select name="service_option_id" id="opt-{{ s.id }}" class="w-full border rounded px-3 py-2 mb-3">
            {% for opt in s.options.all %}
              {% if opt.is_active %}
                <option
                  value="{{ opt.id }}"
                  data-duration="{{ opt.duration_min }}"
                  data-price="{{ opt.price }}"
                  data-yclients-id="{{ opt.yclients_service_id }}"
                >
                  {{ opt|option_label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          {# –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç YClients –Ω–∞–ø—Ä—è–º—É—é #}
          <a class="btn" 
             href="#"
             {% if s.preferred_master_id %}data-staff-id="{{ s.preferred_master_id }}"{% endif %}
             onclick="openYClientsBooking(event, 'opt-{{ s.id }}', this.getAttribute('data-staff-id')); return false;">
            –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
          </a>
        </div>
      {% else %}
        <p class="text-sm text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>
      {% endif %}
    </div>
    {% endif %}
  {% endfor %}
  </div>
{% endfor %}

<script>
function openYClientsBooking(event, selectId, staffId) {
  event.preventDefault();
  
  const select = document.getElementById(selectId);
  if (!select) {
    console.error("‚ùå –°–µ–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:", selectId);
    return;
  }
  
  const selectedOption = select.options[select.selectedIndex];
  const serviceId = selectedOption.getAttribute('data-yclients-id');
  
  console.log("=== –û–¢–ö–†–´–¢–ò–ï –ó–ê–ü–ò–°–ò YCLIENTS ===");
  console.log("   Company ID: {{ settings.yclients_company_id }}");
  console.log("   Service ID:", serviceId || "–Ω–µ —É–∫–∞–∑–∞–Ω (–±—É–¥–µ—Ç –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫)");
  console.log("   Staff ID:", staffId || "–Ω–µ —É–∫–∞–∑–∞–Ω (–ª—é–±–æ–π –º–∞—Å—Ç–µ—Ä)");
  
  // –ë–∞–∑–æ–≤—ã–π URL
  const baseUrl = "https://n951024.yclients.com/company/{{ settings.yclients_company_id }}";
  
  // –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  let url = baseUrl;
  const params = new URLSearchParams();
  
  // –î–æ–±–∞–≤–ª—è–µ–º service_id –µ—Å–ª–∏ –µ—Å—Ç—å
  if (serviceId && serviceId !== 'None' && serviceId !== '' && serviceId !== 'null') {
    params.append('service_id', serviceId);
    console.log("   ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä service_id –¥–æ–±–∞–≤–ª–µ–Ω");
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º staff_id –µ—Å–ª–∏ –µ—Å—Ç—å
  if (staffId && staffId !== 'None' && staffId !== '' && staffId !== 'null') {
    params.append('staff_id', staffId);
    console.log("   ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä staff_id –¥–æ–±–∞–≤–ª–µ–Ω");
  }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π URL
  const paramsString = params.toString();
  if (paramsString) {
    url += '?' + paramsString;
  }
  
  console.log("   üîó –§–∏–Ω–∞–ª—å–Ω—ã–π URL:", url);
  console.log("===================================");
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
  const popup = window.open(
    url, 
    'yclients_booking', 
    'width=1000,height=800,scrollbars=yes,resizable=yes,location=yes'
  );
  
  if (!popup) {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∑–∞–ø–∏—Å–∏.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
    console.error("‚ùå –ü–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º");
    
    // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
    console.log("   ‚ÑπÔ∏è –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –≤ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ...");
    window.location.href = url;
  } else {
    console.log("‚úÖ –û–∫–Ω–æ –∑–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ");
  }
}
</script>

{% endblock %}