{% extends "website/base.html" %}
{% load static service_extras humanize %}
{% block title %}–£—Å–ª—É–≥–∏ ‚Äî {{ settings.salon_name|default:"–°—Ç—É–¥–∏—è —ç—Å—Ç–µ—Ç–∏–∫–∏ –§–æ—Ä–º—É–ª–∞ –¢–µ–ª–∞" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="{% static 'css/booking.css' %}">
<style>
    /* Flatpickr –ø–æ–≤–µ—Ä—Ö Bootstrap –º–æ–¥–∞–ª–∫–∏ */
    .flatpickr-calendar {
        z-index: 10060 !important;
    }
    /* Flatpickr altInput –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
    #modal-booking-form input.flatpickr-input[readonly] {
        background-color: #fff !important;
        color: #000 !important;
        cursor: pointer !important;
        opacity: 1 !important;
    }
    /* –ü–æ–ª–µ –¥–∞—Ç—ã ‚Äî —Å—Ç–∏–ª—å –∫–∞–∫ —É select */
    .date-wrapper {
        position: relative;
        cursor: pointer;
        width: 100%;
    }
    .date-wrapper #m-date-zapis,
    .date-wrapper .flatpickr-input {
        width: 100% !important;
        cursor: pointer !important;
    }
    /* altInput –æ—Ç Flatpickr ‚Äî —Å—Ç–∏–ª–∏–∑—É–µ–º –∫–∞–∫ form-select */
    .date-wrapper input[readonly],
    .date-wrapper .flatpickr-wrapper input {
        background-color: #fff !important;
        color: #000 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.25rem;
        appearance: none;
        width: 100% !important;
        box-sizing: border-box;
    }
    /* –ú–æ–¥–∞–ª–∫–∞ ‚Äî –º–æ–±–∏–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-width: 576px) {
        #bookingModal .modal-body {
            padding: 20px !important;
        }
    }
    /* –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (—à–∞–≥ 2) */
    #m-contact-form .form-group {
        margin-bottom: 15px;
    }
    #m-contact-form .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 14px;
    }
    #m-contact-form .form-group input,
    #m-contact-form .form-group textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 16px;
        font-family: inherit;
        transition: border-color 0.2s;
    }
    #m-contact-form .form-group input:focus,
    #m-contact-form .form-group textarea:focus {
        outline: none;
        border-color: #000;
    }
    /* –°–≤–æ–¥–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .booking-summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
    }
    .booking-summary-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 14px;
    }
    .booking-summary-item span {
        opacity: 0.6;
    }
    .booking-summary-item strong {
        text-align: right;
        max-width: 60%;
    }
    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏ (override Bootstrap 5.0.0-beta1) */
    #bookingModal.modal {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    #bookingModal .modal-dialog {
        display: flex !important;
        justify-content: center !important;
        min-height: 100vh;
        align-items: center;
        margin: 0 auto !important;
        max-width: 100% !important;
        width: 100% !important;
        pointer-events: none;
    }
    #bookingModal .modal-content {
        max-width: 500px;
        width: calc(100% - 30px);
        pointer-events: auto;
        max-height: 90vh;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
    <!-- ========================= –ë–∞–Ω–Ω–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ========================= -->
    {% if promotions %}
    <section class="banner2">
        <div class="container"> 
            <div class="b2 d-flex flex-column" id="parallax">
                {% with promo=promotions.0 %}
                    <h2 class="wow fadeInUp" data-wow-delay=".2s">{{ promo.title|default:"–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ" }}</h2>
                    <p class="text-banner wow fadeInUp" data-wow-delay=".4s">
                        {{ promo.subtitle|default:"–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å"|safe }}
                    </p>
                {% endwith %}
            </div>
        </div>
    </section>
    {% endif %}
    
    <!-- ========================= –£—Å–ª—É–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ========================= -->
    {% for cat in categories %}
        <section class="service serv1 mb-72" id="category-{{ cat.id }}">
            <div class="container"> 
                <h2 class="wow fadeInUp" data-wow-delay=".2s">{{ cat.name }}</h2>
                {% if cat.description %}
                    <p class="text-banner mb-4 wow fadeInUp" data-wow-delay=".3s">{{ cat.description }}</p>
                {% endif %}
                <div class="row">
                    {% for s in cat.services.all %}
                        {% if s.is_active %}
                            <div class="col-lg-4 col-md-6 col-sm-6 wow fadeInUp" data-wow-delay="{% if forloop.counter == 1 %}0.4{% elif forloop.counter == 2 %}0.6{% elif forloop.counter == 3 %}0.8{% elif forloop.counter == 4 %}1{% elif forloop.counter == 5 %}1.2{% else %}1.4{% endif %}s">
                                <a href="{% url 'website:service_detail' service_id=s.id %}" class="item">
                                    {% if s.image %}
                                        <img src="{{ s.image.url }}" class="responsive mn7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% else %}
                                        <img src="{% static 'images/us1.jpg' %}" class="responsive mn7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% endif %}
                                    {% if s.image_mobile %}
                                        <img src="{{ s.image_mobile.url }}" class="responsive mobb7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% elif s.image %}
                                        <img src="{{ s.image.url }}" class="responsive mobb7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% else %}
                                        <img src="{% static 'images/us1.jpg' %}" class="responsive mobb7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% endif %}
                                </a>
                                
                                <a href="{% url 'website:service_detail' service_id=s.id %}" class="text-center mb-40">
                                    <span class="semi f20 mb-15">{{ s.name }}</span>
                                    {% if s.options.all %}
                                        {% with first_option=s.options.all|first %}
                                            <span class="op50">
                                                {% if first_option.units and first_option.units > 1 %}
                                                    {{ first_option.duration_min }} –º–∏–Ω √ó {{ first_option.units }} {{ first_option.get_unit_type_display }} ‚Äî –æ—Ç {{ first_option.price|floatformat:0 }} ‚ÇΩ
                                                {% else %}
                                                    {{ first_option.duration_min }} –º–∏–Ω ‚Äî –æ—Ç {{ first_option.price|floatformat:0 }} ‚ÇΩ
                                                {% endif %}
                                            </span>
                                        {% endwith %}
                                    {% elif s.price_from %}
                                        <span class="op50">–æ—Ç {{ s.price_from|floatformat:0 }} ‚ÇΩ</span>
                                    {% endif %}
                                </a>
                                
                                {% if s.options.all %}
                                    <div class="text-center mb-40" style="margin-top: -20px;">
                                        <a class="btn-black t-btn" 
                                           href="#" 
                                           onclick="openBookingModal({{ s.id }}, '{{ s.name|escapejs }}'); return false;"
                                           style="display: inline-block; width: 100%; text-align: center;">
                                            –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center op50">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% empty %}
        <section class="service serv1 mb-72">
            <div class="container"> 
                <h2 class="wow fadeInUp" data-wow-delay=".2s">–£—Å–ª—É–≥–∏ —Å–∞–ª–æ–Ω–∞</h2>
                <div class="row">
                    <div class="col-12">
                        <p class="text-center">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                </div>
            </div>
        </section>
    {% endfor %}

    <!-- ========================= –ú–æ–¥–∞–ª–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ========================= -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog" id="bookingModalDialog">
            <div class="modal-content" style="border: none; border-radius: 12px;">
                
                <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                <div id="booking-step-1">
                    <div class="modal-header" style="border-bottom: 1px solid #eee; padding: 20px 30px;">
                        <h5 class="modal-title semi" id="bookingModalLabel">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                    </div>
                    <div class="modal-body" style="padding: 30px;">
                        
                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ -->
                        <div class="mb-20" id="modal-service-title" style="font-size: 18px; font-weight: 600;"></div>
                        
                        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                        <div id="modal-loading" style="text-align: center; padding: 40px; display: none;">
                            <div class="spinner-border" role="status" style="color: #000;">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p style="margin-top: 10px; opacity: 0.5;">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤...</p>
                        </div>
                        
                        <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <form id="modal-booking-form" style="display: none;">
                            <div class="in-form">
                                
                                <!-- –í—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
                                <select id="m-duration-select" class="form-select" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                </select>
                                
                                <!-- –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–º–µ–Ω—ã) -->
                                <div id="m-quantity-container">
                                    <select id="m-quantity-select" class="form-select" required>
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                    </select>
                                </div>
                                
                                <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID –æ–ø—Ü–∏–∏ -->
                                <input type="hidden" id="m-option-select" value="">
                                
                                <!-- –í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞ -->
                                <select id="m-master-select" class="form-select" required>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>
                                </select>
                                
                                <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
                                <input 
                                    type="text" 
                                    id="m-date-disabled" 
                                    class="text-def" 
                                    value="–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞"
                                    disabled
                                    style="display: block;">
                                <div class="date-wrapper" id="m-date-wrapper" style="display: none;">
                                    <input 
                                        type="text" 
                                        id="m-date-zapis" 
                                        class="form-control" 
                                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"
                                        readonly
                                        required>
                                </div>
                                
                                <!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ -->
                                <select id="m-time-zapis" class="form-select" required disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>
                                </select>
                                
                                <!-- –°—Ç–æ–∏–º–æ—Å—Ç—å -->
                                <input 
                                    type="text" 
                                    id="m-price-display" 
                                    class="text-def semi" 
                                    value="–°—Ç–æ–∏–º–æ—Å—Ç—å: ‚Äî ‚ÇΩ" 
                                    disabled>
                            </div>
                            
                            <button 
                                type="submit" 
                                id="m-submit-booking" 
                                class="btn-black t-btn submit"
                                style="width: 100%; margin-top: 15px;">
                                –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 2: –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
                <div id="booking-step-2" style="display: none;">
                    <div class="modal-header" style="border-bottom: 1px solid #eee; padding: 20px 30px;">
                        <h5 class="modal-title semi">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                    </div>
                    <div class="modal-body" style="padding: 30px;">
                        
                        <!-- –°–≤–æ–¥–∫–∞ -->
                        <div class="booking-summary">
                            <div class="booking-summary-item">
                                <span>–£—Å–ª—É–≥–∞:</span>
                                <strong id="m-summary-service"></strong>
                            </div>
                            <div class="booking-summary-item">
                                <span>–ú–∞—Å—Ç–µ—Ä:</span>
                                <strong id="m-summary-master"></strong>
                            </div>
                            <div class="booking-summary-item">
                                <span>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</span>
                                <strong id="m-summary-datetime"></strong>
                            </div>
                            <div class="booking-summary-item">
                                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                <strong id="m-summary-price"></strong>
                            </div>
                        </div>
                        
                        <!-- –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
                        <form id="m-contact-form">
                            <div class="form-group">
                                <label for="m-client-name">–í–∞—à–µ –∏–º—è *</label>
                                <input type="text" id="m-client-name" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" required>
                            </div>
                            <div class="form-group">
                                <label for="m-client-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                                <input type="tel" id="m-client-phone" placeholder="+7 (900) 123-45-67" required>
                            </div>
                            <div class="form-group">
                                <label for="m-client-email">Email</label>
                                <input type="email" id="m-client-email" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label for="m-client-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                <textarea id="m-client-comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                            </div>
                            
                            <div id="m-modal-alert"></div>
                            
                            <button type="submit" id="m-confirm-booking" class="btn-black t-btn" style="width: 100%; margin-top: 10px;">
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 3: –£—Å–ø–µ—Ö -->
                <div id="booking-step-3" style="display: none;">
                    <div class="modal-body" style="padding: 50px 30px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                        <h4 class="semi" style="margin-bottom: 10px;">–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã!</h4>
                        <p id="m-success-message" style="opacity: 0.7;"></p>
                        <button type="button" class="btn-black t-btn" data-bs-dismiss="modal" style="margin-top: 20px;">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script>
(function() {
    'use strict';
    
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const API_BASE_URL = '{{ request.scheme }}://{{ request.get_host }}';
    const CSRF_TOKEN = '{{ csrf_token }}';
    
    // ========== –°–û–°–¢–û–Ø–ù–ò–ï ==========
    let currentServiceId = null;
    let currentServiceName = '';
    let serviceOptions = [];
    let optionsMap = {};
    let uniqueDurations = [];
    let bookingData = {};
    let availableDates = [];
    let datePicker = null;
    
    // –§–ª–∞–≥–∏
    let isLoadingDates = false;
    let isLoadingTimes = false;
    
    // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–∞–ª–∫—É Bootstrap
    let bsModal = null;
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', function() {
        const modalEl = document.getElementById('bookingModal');
        if (!modalEl) return;
        
        bsModal = new bootstrap.Modal(modalEl);
        
        // –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        modalEl.addEventListener('hidden.bs.modal', resetModal);
        
        // –ö–ª–∏–∫ –ø–æ –≤—Å–µ–º—É date-wrapper –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        document.getElementById('m-date-wrapper').addEventListener('click', function() {
            if (datePicker && typeof datePicker.open === 'function') {
                datePicker.open();
            }
        });
        
        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.getElementById('modal-booking-form').addEventListener('change', function(e) {
            if (e.target.id === 'm-duration-select') {
                onDurationChange(e.target.value);
            } else if (e.target.id === 'm-quantity-select') {
                onQuantityChange();
            } else if (e.target.id === 'm-master-select') {
                onMasterChange(e.target.value);
            } else if (e.target.id === 'm-time-zapis') {
                onTimeChange(e.target.value);
            }
        });
        
        // –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —à–∞–≥ 1
        document.getElementById('modal-booking-form').addEventListener('submit', function(e) {
            e.preventDefault();
            showContactStep();
        });
        
        // –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ‚Äî —à–∞–≥ 2
        document.getElementById('m-contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            submitBooking();
        });
    });
    
    // ========== –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ö–ò ==========
    window.openBookingModal = function(serviceId, serviceName) {
        currentServiceId = serviceId;
        currentServiceName = serviceName;
        
        document.getElementById('modal-service-title').textContent = serviceName;
        document.getElementById('bookingModalLabel').textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è';
        document.getElementById('modal-loading').style.display = 'block';
        document.getElementById('modal-booking-form').style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥ 1
        document.getElementById('booking-step-1').style.display = 'block';
        document.getElementById('booking-step-2').style.display = 'none';
        document.getElementById('booking-step-3').style.display = 'none';
        
        bsModal.show();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏
        loadServiceOptions(serviceId);
        
        console.log('=== –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ö–ò –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ===');
        console.log('   –£—Å–ª—É–≥–∞:', serviceName, '(ID:', serviceId, ')');
    };
    
    // ========== –ó–ê–ì–†–£–ó–ö–ê –û–ü–¶–ò–ô –£–°–õ–£–ì–ò ==========
    async function loadServiceOptions(serviceId) {
        try {
            const url = `${API_BASE_URL}/api/booking/service_options/?service_id=${serviceId}`;
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.data) {
                serviceOptions = data.data;
                console.log('‚úÖ –û–ø—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', serviceOptions.length);
                
                // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É –æ–ø—Ü–∏–π
                optionsMap = {};
                serviceOptions.forEach(opt => {
                    if (!optionsMap[opt.duration]) optionsMap[opt.duration] = {};
                    optionsMap[opt.duration][opt.quantity] = opt;
                });
                
                uniqueDurations = [...new Set(serviceOptions.map(o => o.duration))].sort((a, b) => a - b);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                initBookingForm();
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—Ü–∏–π:', data.error);
                document.getElementById('modal-loading').innerHTML = 
                    '<p style="color: red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —É—Å–ª—É–≥–∏</p>';
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            document.getElementById('modal-loading').innerHTML = 
                '<p style="color: red;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</p>';
        }
    }
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–û–†–ú–´ ==========
    function initBookingForm() {
        const durationSelect = document.getElementById('m-duration-select');
        const quantityContainer = document.getElementById('m-quantity-container');
        const priceDisplay = document.getElementById('m-price-display');
        const optionInput = document.getElementById('m-option-select');
        
        // === –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ===
        if (uniqueDurations.length === 1) {
            // –û–¥–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ disabled input + hidden
            const dur = uniqueDurations[0];
            durationSelect.style.display = 'none';
            
            const wrapper = durationSelect.parentElement;
            const disabledInput = document.createElement('input');
            disabledInput.type = 'text';
            disabledInput.className = 'text-def';
            disabledInput.value = dur + ' –º–∏–Ω—É—Ç';
            disabledInput.disabled = true;
            disabledInput.id = 'm-duration-display';
            wrapper.insertBefore(disabledInput, durationSelect);
            
            durationSelect.innerHTML = `<option value="${dur}" selected>${dur} –º–∏–Ω—É—Ç</option>`;
            durationSelect.value = dur;
            
            // –°—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            onDurationChange(dur);
        } else {
            // –ù–µ—Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
            durationSelect.style.display = '';
            durationSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>';
            uniqueDurations.forEach(dur => {
                const option = document.createElement('option');
                option.value = dur;
                option.textContent = dur + ' –º–∏–Ω—É—Ç';
                durationSelect.appendChild(option);
            });
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('modal-loading').style.display = 'none';
        document.getElementById('modal-booking-form').style.display = 'block';
        
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –æ–ø—Ü–∏—è ‚Äî —Å—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º
        if (serviceOptions.length === 1) {
            const opt = serviceOptions[0];
            optionInput.value = opt.id;
            priceDisplay.value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ' + formatPrice(opt.price) + ' ‚ÇΩ';
            loadMasters();
        }
    }
    
    // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ó–ú–ï–ù–ï–ù–ò–ô ==========
    function onDurationChange(duration) {
        if (!duration) return;
        
        const durationInt = parseInt(duration);
        const quantities = optionsMap[durationInt] 
            ? Object.keys(optionsMap[durationInt]).map(Number).sort((a, b) => a - b) 
            : [];
        
        const container = document.getElementById('m-quantity-container');
        
        if (quantities.length === 0) {
            container.innerHTML = '<input type="text" class="text-def" value="–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤" disabled>';
            return;
        }
        
        if (quantities.length === 1) {
            // –û–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî disabled input + hidden
            const opt = optionsMap[durationInt][quantities[0]];
            container.innerHTML = `
                <input type="text" class="text-def" value="${quantities[0]} ${opt.unit_type_display}" disabled>
                <input type="hidden" id="m-quantity-select" value="${quantities[0]}">
            `;
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –∏ –æ–ø—Ü–∏—é
            selectOption(durationInt, quantities[0]);
        } else {
            // –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤ ‚Äî select
            let html = '<select id="m-quantity-select" class="form-select" required>';
            html += '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>';
            quantities.forEach(qty => {
                const opt = optionsMap[durationInt][qty];
                html += `<option value="${qty}">${qty} ${opt.unit_type_display}</option>`;
            });
            html += '</select>';
            container.innerHTML = html;
        }
    }
    
    function onQuantityChange() {
        const durationSelect = document.getElementById('m-duration-select');
        const quantitySelect = document.getElementById('m-quantity-select');
        
        if (!durationSelect || !quantitySelect) return;
        
        const duration = parseInt(durationSelect.value);
        const quantity = parseInt(quantitySelect.value);
        
        if (duration && quantity) {
            selectOption(duration, quantity);
        }
    }
    
    function selectOption(duration, quantity) {
        const opt = optionsMap[duration] && optionsMap[duration][quantity];
        if (!opt) return;
        
        document.getElementById('m-option-select').value = opt.id;
        document.getElementById('m-price-display').value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ' + formatPrice(opt.price) + ' ‚ÇΩ';
        
        bookingData.price = opt.price;
        bookingData.optionId = opt.id;
        bookingData.yclientsId = opt.yclients_id;
        
        console.log('‚úÖ –í—ã–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è:', opt.id, '‚Äî —Ü–µ–Ω–∞:', opt.price);
        
        loadMasters();
    }
    
    function onMasterChange(staffId) {
        if (!staffId) return;
        
        const masterSelect = document.getElementById('m-master-select');
        const selectedOption = masterSelect.options[masterSelect.selectedIndex];
        bookingData.staffId = staffId;
        bookingData.masterName = selectedOption.textContent;
        
        console.log('üë§ –í—ã–±—Ä–∞–Ω –º–∞—Å—Ç–µ—Ä:', bookingData.masterName, '(ID:', staffId, ')');
        
        loadAvailableDates(staffId);
    }
    
    function onTimeChange(time) {
        if (!time) return;
        bookingData.time = time;
        console.log('üïê –í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è:', time);
    }
    
    // ========== –ó–ê–ì–†–£–ó–ö–ê –ú–ê–°–¢–ï–†–û–í ==========
    async function loadMasters() {
        const optionId = document.getElementById('m-option-select').value;
        if (!optionId) return;
        
        const select = document.getElementById('m-master-select');
        select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤...</option>';
        select.disabled = true;
        
        try {
            const url = `${API_BASE_URL}/api/booking/get_staff/?service_option_id=${optionId}`;
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.data) {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
                
                if (data.data.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
                    select.disabled = false;
                    return;
                }
                
                data.data.forEach(master => {
                    const option = document.createElement('option');
                    option.value = master.id;
                    let name = master.name || '';
                    if (master.specialization) name += ` (${master.specialization})`;
                    option.textContent = name;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ –ú–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', data.data.length);
                
                // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –µ—Å–ª–∏ –æ–¥–∏–Ω –º–∞—Å—Ç–µ—Ä
                if (data.data.length === 1) {
                    select.value = data.data[0].id;
                    onMasterChange(data.data[0].id);
                }
            } else {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
                console.error('‚ùå', data.error);
            }
            
            select.disabled = false;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤:', error);
            select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</option>';
            select.disabled = false;
        }
    }
    
    // ========== –ó–ê–ì–†–£–ó–ö–ê –î–û–°–¢–£–ü–ù–´–• –î–ê–¢ ==========
    async function loadAvailableDates(staffId) {
        if (!staffId || isLoadingDates) return;
        
        isLoadingDates = true;
        
        try {
            const url = `${API_BASE_URL}/api/booking/available_dates/?staff_id=${staffId}`;
            console.log('üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.data && data.data.dates) {
                availableDates = data.data.dates;
                console.log('‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç:', availableDates.length);
                
                if (availableDates.length > 0) {
                    initializeDatePicker(staffId);
                } else {
                    const dateDisabled = document.getElementById('m-date-disabled');
                    dateDisabled.value = '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –¥–∞—Ç';
                    dateDisabled.style.display = 'block';
                    document.getElementById('m-date-wrapper').style.display = 'none';
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç:', error);
        } finally {
            isLoadingDates = false;
        }
    }
    
    // ========== –ö–ê–õ–ï–ù–î–ê–†–¨ (Flatpickr) ==========
    function initializeDatePicker(staffId) {
        const dateInput = document.getElementById('m-date-zapis');
        const dateDisabled = document.getElementById('m-date-disabled');
        const dateWrapper = document.getElementById('m-date-wrapper');
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π
        if (datePicker && typeof datePicker.destroy === 'function') {
            try { datePicker.destroy(); } catch(e) {}
            datePicker = null;
        }
        
        dateDisabled.style.display = 'none';
        dateWrapper.style.display = 'block';
        
        const firstDate = availableDates[0];
        
        datePicker = flatpickr(dateInput, {
            locale: 'ru',
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'j F Y (D)',
            minDate: availableDates[0],
            maxDate: availableDates[availableDates.length - 1],
            enable: availableDates,
            defaultDate: firstDate,
            disableMobile: true,
            allowInput: false,
            clickOpens: true,
            
            onChange: function(selectedDates, dateStr) {
                if (!dateStr || !staffId) return;
                
                bookingData.date = dateStr;
                bookingData.dateFormatted = selectedDates[0].toLocaleDateString('ru-RU', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                
                const timeSelect = document.getElementById('m-time-zapis');
                if (timeSelect) timeSelect.disabled = false;
                
                loadAvailableTimes(staffId, dateStr);
            },
            
            onReady: function() {
                console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤');
                // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–≤–æ–π –¥–∞—Ç—ã
                bookingData.date = firstDate;
                const d = new Date(firstDate + 'T00:00:00');
                bookingData.dateFormatted = d.toLocaleDateString('ru-RU', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                loadAvailableTimes(staffId, firstDate);
            }
        });
    }
    
    // ========== –ó–ê–ì–†–£–ó–ö–ê –í–†–ï–ú–ï–ù–ò ==========
    const debouncedLoadTimes = debounce(loadAvailableTimes, 500);
    
    async function loadAvailableTimes(staffId, date) {
        if (isLoadingTimes) return;
        isLoadingTimes = true;
        
        const timeSelect = document.getElementById('m-time-zapis');
        timeSelect.disabled = true;
        timeSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
        
        try {
            const optionId = document.getElementById('m-option-select').value;
            let url = `${API_BASE_URL}/api/booking/available_times/?staff_id=${staffId}&date=${date}`;
            if (optionId) url += `&service_option_id=${optionId}`;
            
            console.log('üïê –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.data && data.data.times) {
                const times = data.data.times;
                
                if (times.length > 0) {
                    const grouped = groupTimesByPeriod(times);
                    timeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>';
                    
                    for (const [period, periodTimes] of Object.entries(grouped)) {
                        if (periodTimes.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = period;
                            periodTimes.forEach(time => {
                                const option = document.createElement('option');
                                option.value = time;
                                option.textContent = time;
                                optgroup.appendChild(option);
                            });
                            timeSelect.appendChild(optgroup);
                        }
                    }
                    
                    console.log('‚úÖ –°–ª–æ—Ç–æ–≤:', times.length);
                } else {
                    timeSelect.innerHTML = '<option value="">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</option>';
                }
            }
            
            timeSelect.disabled = false;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏:', error);
            timeSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            timeSelect.disabled = false;
        } finally {
            isLoadingTimes = false;
        }
    }
    
    // ========== –®–ê–ì 2: –ö–û–ù–¢–ê–ö–¢–´ ==========
    function showContactStep() {
        const time = document.getElementById('m-time-zapis').value;
        if (!time) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è');
            return;
        }
        
        bookingData.time = time;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–≤–æ–¥–∫—É
        document.getElementById('m-summary-service').textContent = currentServiceName;
        document.getElementById('m-summary-master').textContent = bookingData.masterName || '‚Äî';
        document.getElementById('m-summary-datetime').textContent = 
            (bookingData.dateFormatted || bookingData.date) + ', ' + bookingData.time;
        document.getElementById('m-summary-price').textContent = 
            formatPrice(bookingData.price) + ' ‚ÇΩ';
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —à–∞–≥–∏
        document.getElementById('booking-step-1').style.display = 'none';
        document.getElementById('booking-step-2').style.display = 'block';
    }
    
    // ========== –û–¢–ü–†–ê–í–ö–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ==========
    async function submitBooking() {
        const confirmBtn = document.getElementById('m-confirm-booking');
        const alertDiv = document.getElementById('m-modal-alert');
        
        confirmBtn.disabled = true;
        confirmBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        alertDiv.innerHTML = '';
        
        const name = document.getElementById('m-client-name').value.trim();
        const phone = document.getElementById('m-client-phone').value.trim();
        const email = document.getElementById('m-client-email').value.trim();
        const comment = document.getElementById('m-client-comment').value.trim();
        
        if (!name || !phone) {
            alertDiv.innerHTML = '<div class="alert alert-danger">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω</div>';
            confirmBtn.disabled = false;
            confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å';
            return;
        }
        
        try {
            const url = `${API_BASE_URL}/api/booking/create/`;
            const body = {
                staff_id: parseInt(bookingData.staffId),
                service_ids: [parseInt(bookingData.yclientsId)],
                date: bookingData.date,
                time: bookingData.time,
                client: {
                    name: name,
                    phone: phone,
                    email: email || undefined
                },
                comment: comment
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', body);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥ 3 ‚Äî —É—Å–ø–µ—Ö
                document.getElementById('booking-step-2').style.display = 'none';
                document.getElementById('booking-step-3').style.display = 'block';
                document.getElementById('m-success-message').textContent = 
                    `${currentServiceName}, ${bookingData.dateFormatted || bookingData.date} –≤ ${bookingData.time}`;
            } else {
                alertDiv.innerHTML = `<div class="alert alert-danger">${data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏'}</div>`;
                console.error('‚ùå –û—à–∏–±–∫–∞:', data.error);
            }
        } catch (error) {
            alertDiv.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';
            console.error('‚ùå', error);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å';
        }
    }
    
    // ========== –°–ë–†–û–° –ú–û–î–ê–õ–ö–ò ==========
    function resetModal() {
        currentServiceId = null;
        currentServiceName = '';
        serviceOptions = [];
        optionsMap = {};
        uniqueDurations = [];
        bookingData = {};
        availableDates = [];
        isLoadingDates = false;
        isLoadingTimes = false;
        
        if (datePicker && typeof datePicker.destroy === 'function') {
            try { datePicker.destroy(); } catch(e) {}
            datePicker = null;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–≥–∏
        document.getElementById('booking-step-1').style.display = 'block';
        document.getElementById('booking-step-2').style.display = 'none';
        document.getElementById('booking-step-3').style.display = 'none';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        const form = document.getElementById('modal-booking-form');
        form.style.display = 'none';
        document.getElementById('modal-loading').style.display = 'none';
        document.getElementById('modal-loading').innerHTML = `
            <div class="spinner-border" role="status" style="color: #000;">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p style="margin-top: 10px; opacity: 0.5;">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤...</p>
        `;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º duration select
        const durationSelect = document.getElementById('m-duration-select');
        durationSelect.style.display = '';
        durationSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>';
        const durationDisplay = document.getElementById('m-duration-display');
        if (durationDisplay) durationDisplay.remove();
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        document.getElementById('m-quantity-container').innerHTML = `
            <select id="m-quantity-select" class="form-select" required>
                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
            </select>
        `;
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        document.getElementById('m-option-select').value = '';
        document.getElementById('m-master-select').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —É—Å–ª—É–≥–∏</option>';
        document.getElementById('m-date-disabled').style.display = 'block';
        document.getElementById('m-date-disabled').value = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞';
        document.getElementById('m-date-wrapper').style.display = 'none';
        document.getElementById('m-time-zapis').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>';
        document.getElementById('m-time-zapis').disabled = true;
        document.getElementById('m-price-display').value = '–°—Ç–æ–∏–º–æ—Å—Ç—å: ‚Äî ‚ÇΩ';
        
        // –ö–æ–Ω—Ç–∞–∫—Ç—ã
        document.getElementById('m-client-name').value = '';
        document.getElementById('m-client-phone').value = '';
        document.getElementById('m-client-email').value = '';
        document.getElementById('m-client-comment').value = '';
        document.getElementById('m-modal-alert').innerHTML = '';
        
        console.log('üîÑ –ú–æ–¥–∞–ª–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
    }
    
    // ========== –£–¢–ò–õ–ò–¢–´ ==========
    function formatPrice(price) {
        return new Intl.NumberFormat('ru-RU').format(price);
    }
    
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }
    
    function groupTimesByPeriod(times) {
        const groups = {
            '–£—Ç—Ä–æ (–¥–æ 12:00)': [],
            '–î–µ–Ω—å (12:00‚Äì17:00)': [],
            '–í–µ—á–µ—Ä (–ø–æ—Å–ª–µ 17:00)': []
        };
        times.forEach(time => {
            const hour = parseInt(time.split(':')[0]);
            if (hour < 12) groups['–£—Ç—Ä–æ (–¥–æ 12:00)'].push(time);
            else if (hour < 17) groups['–î–µ–Ω—å (12:00‚Äì17:00)'].push(time);
            else groups['–í–µ—á–µ—Ä (–ø–æ—Å–ª–µ 17:00)'].push(time);
        });
        return groups;
    }
    
})();
</script>
{% endblock %}
