{% extends "website/base.html" %}
{% load static service_extras humanize %}
{% block title %}–£—Å–ª—É–≥–∏ ‚Äî {{ settings.salon_name|default:"–°—Ç—É–¥–∏—è —ç—Å—Ç–µ—Ç–∏–∫–∏ –§–æ—Ä–º—É–ª–∞ –¢–µ–ª–∞" }}{% endblock %}

{% block content %}
    <!-- ========================= –ë–∞–Ω–Ω–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º–æ) ========================= -->
    {% if promotions %}
    <section class="banner2">
        <div class="container"> 
            <div class="b2 d-flex flex-column" id="parallax">
                {% with promo=promotions.0 %}
                    <h2 class="wow fadeInUp" data-wow-delay=".2s">{{ promo.title|default:"–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ" }}</h2>
                    <p class="text-banner wow fadeInUp" data-wow-delay=".4s">
                        {{ promo.subtitle|default:"–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å"|safe }}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="#" class="btn-white t-btn wow fadeInUp" data-wow-delay=".6s" data-bs-toggle="modal" data-bs-target="#exampleModal">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</a>
                    </div>
                {% endwith %}
            </div>
        </div>
    </section>
    {% endif %}
    
    <!-- ========================= –£—Å–ª—É–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ========================= -->
    {% for cat in categories %}
        <section class="service serv1 mb-72" id="category-{{ cat.id }}">
            <div class="container"> 
                <h2 class="wow fadeInUp" data-wow-delay=".2s">{{ cat.name }}</h2>
                {% if cat.description %}
                    <p class="text-banner mb-4 wow fadeInUp" data-wow-delay=".3s">{{ cat.description }}</p>
                {% endif %}
                <div class="row">
                    {% for s in cat.services.all %}
                        {% if s.is_active %}
                            <div class="col-lg-4 col-md-6 col-sm-6 wow fadeInUp" data-wow-delay="{% if forloop.counter == 1 %}0.4{% elif forloop.counter == 2 %}0.6{% elif forloop.counter == 3 %}0.8{% elif forloop.counter == 4 %}1{% elif forloop.counter == 5 %}1.2{% else %}1.4{% endif %}s">
                                <a href="{% url 'website:service_detail' service_id=s.id %}" class="item">
                                    {% if s.image %}
                                        <img src="{{ s.image.url }}" class="responsive mn7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                        <img src="{{ s.image.url }}" class="responsive mobb7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% else %}
                                        <img src="{% static 'images/us1.jpg' %}" class="responsive mn7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                        <img src="{% static 'images/us1.jpg' %}" class="responsive mobb7" alt="{{ s.name }}" title="{{ s.name }}" loading="lazy">
                                    {% endif %}
                                </a>
                                
                                <div class="text-center mb-40">
                                    <a href="{% url 'website:service_detail' service_id=s.id %}" class="d-block">
                                        <span class="semi f20 mb-15 d-block">{{ s.name }}</span>
                                        {% if s.options.all %}
                                            {% with first_option=s.options.all|first %}
                                                <span class="op50">
                                                    {% if first_option.units and first_option.units > 1 %}
                                                        {{ first_option.duration_min }} –º–∏–Ω √ó {{ first_option.units }} {{ first_option.get_unit_type_display }} ‚Äî –æ—Ç {{ first_option.price|floatformat:0 }} ‚ÇΩ
                                                    {% else %}
                                                        {{ first_option.duration_min }} –º–∏–Ω ‚Äî –æ—Ç {{ first_option.price|floatformat:0 }} ‚ÇΩ
                                                    {% endif %}
                                                </span>
                                            {% endwith %}
                                        {% elif s.price_from %}
                                            <span class="op50">–æ—Ç {{ s.price_from|floatformat:0 }} ‚ÇΩ</span>
                                        {% endif %}
                                    </a>
                                    
                                    {% if s.options.all %}
                                        <form method="get" class="mt-3" onsubmit="event.preventDefault(); openYClientsModal('opt-{{ s.id }}'); return false;">
                                            <select id="opt-{{ s.id }}" class="form-select mb-2" style="width: 100%;">
                                                {% for opt in s.options.all %}
                                                    {% if opt.is_active %}
                                                        <option
                                                            value="{{ opt.id }}"
                                                            data-yclients-id="{{ opt.yclients_service_id }}"
                                                            data-duration="{{ opt.duration_min }}"
                                                            data-units="{{ opt.units }}"
                                                            data-unit-type="{{ opt.unit_type }}"
                                                            data-price="{{ opt.price }}"
                                                        >
                                                            {{ opt|option_label }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                            <a class="btn-black t-btn" 
                                               href="#" 
                                               onclick="openYClientsModal('opt-{{ s.id }}'); return false;"
                                               style="display: inline-block; width: 100%; text-align: center;">
                                                –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                                            </a>
                                        </form>
                                    {% else %}
                                        <a href="{% url 'website:service_detail' service_id=s.id %}" class="btn-black t-btn mt-3" style="display: inline-block; width: 100%; text-align: center;">
                                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center op50">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% empty %}
        <section class="service serv1 mb-72">
            <div class="container"> 
                <h2 class="wow fadeInUp" data-wow-delay=".2s">–£—Å–ª—É–≥–∏ —Å–∞–ª–æ–Ω–∞</h2>
                <div class="row">
                    <div class="col-12">
                        <p class="text-center">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                </div>
            </div>
        </section>
    {% endfor %}

    {# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å iframe YClients #}
    <div id="yclients-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; overflow:auto;">
        <div style="position:relative; width:95%; max-width:1100px; height:95%; margin:2.5% auto; background:white; border-radius:12px; overflow:hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            
            {# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å–ª—É–≥–µ #}
            <div id="modal-header" style="background:#2563eb; color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 id="modal-service-name" style="margin:0; font-size:20px; font-weight:600;"></h3>
                    <p id="modal-service-details" style="margin:5px 0 0 0; opacity:0.9; font-size:14px;"></p>
                </div>
                <button onclick="closeYClientsModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:8px; font-size:20px; font-weight:bold; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ‚úï –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
            
            {# iframe —Å —Ñ–æ—Ä–º–æ–π YClients #}
            <iframe id="yclients-iframe" src="" style="width:100%; height:calc(100% - 80px); border:none; display:block;"></iframe>
            
            {# –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤–Ω–∏–∑—É #}
            <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.05); padding:10px; text-align:center; font-size:12px; color:#666;">
                üí° –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É "<span id="modal-hint-service"></span>" –≤ —Ñ–æ—Ä–º–µ –∑–∞–ø–∏—Å–∏
            </div>
        </div>
    </div>

    <script>
    function openYClientsModal(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const selectedOption = select.options[select.selectedIndex];
        const serviceId = selectedOption.getAttribute('data-yclients-id');
        const price = selectedOption.getAttribute('data-price');
        const duration = selectedOption.getAttribute('data-duration');
        const units = selectedOption.getAttribute('data-units');
        const unitType = selectedOption.getAttribute('data-unit-type');
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
        const serviceName = select.closest('.col-lg-4, .col-md-6, .col-sm-6').querySelector('.semi.f20').textContent;
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏
        let details = duration + ' –º–∏–Ω';
        if (units && units > 1) {
            const unitLabels = {
                'session': '–ø—Ä–æ—Ü–µ–¥—É—Ä',
                'zone': '–∑–æ–Ω',
                'visit': '–≤–∏–∑–∏—Ç–æ–≤'
            };
            details += ' √ó ' + units + ' ' + (unitLabels[unitType] || '–µ–¥.');
        }
        details += ' ‚Äî ' + Math.round(price) + ' ‚ÇΩ';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('modal-service-name').textContent = serviceName;
        document.getElementById('modal-service-details').textContent = details;
        document.getElementById('modal-hint-service').textContent = serviceName;
        
        // –ë–∞–∑–æ–≤—ã–π URL –∫–æ–º–ø–∞–Ω–∏–∏
        const companyId = "{{ settings.yclients_company_id }}";
        
        // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –µ—Å—Ç—å service_id - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –°–†–ê–ó–£ –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
        // –ò–Ω–∞—á–µ - –æ–±—â—É—é —Ñ–æ—Ä–º—É
        let url;
        if (serviceId && serviceId !== 'None' && serviceId !== '' && serviceId !== 'null') {
            // –ü—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É –≤—Ä–µ–º–µ–Ω–∏
            url = `https://n951024.yclients.com/company/${companyId}/personal/select_time?o=s${serviceId}`;
            console.log("   ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –∫ –≤—ã–±–æ—Ä—É –≤—Ä–µ–º–µ–Ω–∏");
            console.log("   ‚úÖ Service ID:", serviceId);
        } else {
            // –û–±—â–∞—è —Ñ–æ—Ä–º–∞ (–µ—Å–ª–∏ service_id –Ω–µ —É–∫–∞–∑–∞–Ω)
            url = `https://n951024.yclients.com/company/${companyId}`;
            console.log("   ‚ÑπÔ∏è Service ID –Ω–µ —É–∫–∞–∑–∞–Ω - –æ–±—â–∞—è —Ñ–æ—Ä–º–∞");
        }
        
        // –õ–æ–≥–∏—Ä—É–µ–º
        console.log("=== –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ===");
        console.log("   –£—Å–ª—É–≥–∞:", serviceName);
        console.log("   –î–µ—Ç–∞–ª–∏:", details);
        console.log("   URL:", url);
        console.log("===================================");
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ iframe
        document.getElementById('yclients-iframe').src = url;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('yclients-modal').style.display = 'block';
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª body
        document.body.style.overflow = 'hidden';
    }

    function closeYClientsModal() {
        document.getElementById('yclients-modal').style.display = 'none';
        document.getElementById('yclients-iframe').src = '';
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
        document.body.style.overflow = '';
        
        console.log("‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ");
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
    document.getElementById('yclients-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeYClientsModal();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('yclients-modal');
            if (modal.style.display === 'block') {
                closeYClientsModal();
            }
        }
    });
    </script>
{% endblock %}
