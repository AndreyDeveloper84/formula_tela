{% extends "website/base.html" %}
{% load service_extras humanize %}
{% block title %}–£—Å–ª—É–≥–∏ ‚Äî {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1 class="text-3xl font-bold mb-6">–£—Å–ª—É–≥–∏</h1>

{% for cat in categories %}
  <h2 class="mb-4">{{ cat.name }}</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for s in cat.services.all %}
    {% if s.is_active %}
    <div class="p-5 rounded-2xl shadow bg-white">
      <h3 class="text-lg font-semibold mb-2">{{ s.name }}</h3>
      
      {% if s.options.all %}
        <div>
          <label class="block text-sm mb-1">–í–∞—Ä–∏–∞–Ω—Ç</label>
          <select name="service_option_id" id="opt-{{ s.id }}" class="w-full border rounded px-3 py-2 mb-3">
            {% for opt in s.options.all %}
              {% if opt.is_active %}
                <option
                  value="{{ opt.id }}"
                  data-duration="{{ opt.duration_min }}"
                  data-price="{{ opt.price }}"
                  data-yclients-id="{{ opt.yclients_service_id }}"
                >
                  {{ opt|option_label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          {# –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç YClients –Ω–∞–ø—Ä—è–º—É—é #}
          <a class="btn" 
             href="#"
             {% if s.preferred_master_id %}data-staff-id="{{ s.preferred_master_id }}"{% endif %}
             onclick="openYClientsBooking(event, 'opt-{{ s.id }}', this.getAttribute('data-staff-id')); return false;">
            –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
          </a>
        </div>
      {% else %}
        <p class="text-sm text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>
      {% endif %}
    </div>
    {% endif %}
  {% endfor %}
  </div>
{% endfor %}

<script>
function openYClientsBooking(event, selectId, staffId) {
  event.preventDefault();
  
  const select = document.getElementById(selectId);
  if (!select) {
    console.error("‚ùå –°–µ–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:", selectId);
    return;
  }
  
  const selectedOption = select.options[select.selectedIndex];
  const serviceId = selectedOption.getAttribute('data-yclients-id');
  
  console.log("=== –û–¢–ö–†–´–¢–ò–ï –ó–ê–ü–ò–°–ò YCLIENTS ===");
  console.log("   Company ID: {{ settings.yclients_company_id }}");
  console.log("   Service ID:", serviceId || "–Ω–µ —É–∫–∞–∑–∞–Ω");
  console.log("   Staff ID:", staffId || "–Ω–µ —É–∫–∞–∑–∞–Ω");
  
  // –ë–∞–∑–æ–≤—ã–π URL –∫–æ–º–ø–∞–Ω–∏–∏
  const companyId = "{{ settings.yclients_company_id }}";
  const baseUrl = `https://n951024.yclients.com/company/${companyId}`;
  
  // YClients –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º—É—é –ø–µ—Ä–µ–¥–∞—á—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ URL
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é —Ñ–æ—Ä–º—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥—É –≤—Ä—É—á–Ω—É—é
  let url = baseUrl;
  
  console.log("   ‚ÑπÔ∏è –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ–æ—Ä–º—É –∑–∞–ø–∏—Å–∏");
  console.log("   üí° –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–µ—Ä–µ—Ç —É—Å–ª—É–≥—É –≤—Ä—É—á–Ω—É—é");
  console.log("   üîó –§–∏–Ω–∞–ª—å–Ω—ã–π URL:", url);
  console.log("===================================");
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
  const windowFeatures = 'width=1000,height=850,scrollbars=yes,resizable=yes,location=yes,menubar=no,toolbar=no';
  const popup = window.open(url, 'yclients_booking', windowFeatures);
  
  if (!popup || popup.closed || typeof popup.closed === 'undefined') {
    console.error("‚ùå –ü–æ–ø–∞–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º");
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const message = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∑–∞–ø–∏—Å–∏.\n\n" +
                   "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞:\n" +
                   "1. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞\n" +
                   "2. –ò–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∑–∞–ø–∏—Å—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ";
    
    if (confirm(message + "\n\n–û—Ç–∫—Ä—ã—Ç—å –≤ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ?")) {
      window.location.href = url;
    } else {
      // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ —á–µ—Ä–µ–∑ _blank
      window.open(url, '_blank');
    }
  } else {
    console.log("‚úÖ –û–∫–Ω–æ –∑–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ");
    popup.focus();
  }
}
</script>

{% endblock %}