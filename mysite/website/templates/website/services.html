{% extends "website/base.html" %}
{% load service_extras humanize %}
{% block title %}–£—Å–ª—É–≥–∏ ‚Äî {{ settings.salon_name }}{% endblock %}
{% block content %}
  <h1 class="text-3xl font-bold mb-6">–£—Å–ª—É–≥–∏</h1>

{% for cat in categories %}
  <h2 class="mb-4">{{ cat.name }}</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for s in cat.services.all %}
    {% if s.is_active %}
    <div class="p-5 rounded-2xl shadow bg-white">
      <h3 class="text-lg font-semibold mb-2">{{ s.name }}</h3>
      {% if s.options.all %}
        <form method="get">
          <label class="block text-sm mb-1">–í–∞—Ä–∏–∞–Ω—Ç</label>
          <select id="opt-{{ s.id }}" class="w-full border rounded px-3 py-2 mb-3">
            {% for opt in s.options.all %}
              {% if opt.is_active %}
                <option
                  value="{{ opt.id }}"
                  data-yclients-id="{{ opt.yclients_service_id }}"
                  data-duration="{{ opt.duration_min }}"
                  data-units="{{ opt.units }}"
                  data-unit-type="{{ opt.unit_type }}"
                  data-price="{{ opt.price }}"
                >
                  {{ opt|option_label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          <a class="btn" 
             href="#" 
             onclick="openYClientsModal('opt-{{ s.id }}'); return false;">
            –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
          </a>
        </form>
      {% else %}
        <p class="text-sm text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>
      {% endif %}
    </div>
    {% endif %}
  {% endfor %}
  </div>
{% endfor %}

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å iframe #}
<div id="yclients-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; overflow:auto;">
  <div style="position:relative; width:95%; max-width:1100px; height:95%; margin:2.5% auto; background:white; border-radius:12px; overflow:hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    
    {# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å–ª—É–≥–µ #}
    <div id="modal-header" style="background:#2563eb; color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 id="modal-service-name" style="margin:0; font-size:20px; font-weight:600;"></h3>
        <p id="modal-service-details" style="margin:5px 0 0 0; opacity:0.9; font-size:14px;"></p>
      </div>
      <button onclick="closeYClientsModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:8px; font-size:20px; font-weight:bold; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
        ‚úï –ó–∞–∫—Ä—ã—Ç—å
      </button>
    </div>
    
    {# iframe —Å —Ñ–æ—Ä–º–æ–π YClients #}
    <iframe id="yclients-iframe" src="" style="width:100%; height:calc(100% - 80px); border:none; display:block;"></iframe>
    
    {# –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤–Ω–∏–∑—É #}
    <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.05); padding:10px; text-align:center; font-size:12px; color:#666;">
      üí° –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É "<span id="modal-hint-service"></span>" –≤ —Ñ–æ—Ä–º–µ –∑–∞–ø–∏—Å–∏
    </div>
  </div>
</div>

<script>
function openYClientsModal(selectId) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  const selectedOption = select.options[select.selectedIndex];
  const serviceId = selectedOption.getAttribute('data-yclients-id');
  const price = selectedOption.getAttribute('data-price');
  const duration = selectedOption.getAttribute('data-duration');
  const units = selectedOption.getAttribute('data-units');
  const unitType = selectedOption.getAttribute('data-unit-type');
  
  // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ option
  const serviceLabel = selectedOption.text;
  const serviceName = select.closest('.p-5').querySelector('h3').textContent;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏
  let details = duration + ' –º–∏–Ω';
  if (units && units > 1) {
    const unitLabels = {
      'session': '–ø—Ä–æ—Ü–µ–¥—É—Ä',
      'zone': '–∑–æ–Ω',
      'visit': '–≤–∏–∑–∏—Ç–æ–≤'
    };
    details += ' √ó ' + units + ' ' + (unitLabels[unitType] || '–µ–¥.');
  }
  details += ' ‚Äî ' + Math.round(price) + ' ‚ÇΩ';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  document.getElementById('modal-service-name').textContent = serviceName;
  document.getElementById('modal-service-details').textContent = details;
  document.getElementById('modal-hint-service').textContent = serviceName;
  
  // –ë–∞–∑–æ–≤—ã–π URL –∫–æ–º–ø–∞–Ω–∏–∏
  const companyId = "{{ settings.yclients_company_id }}";
  
  // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –µ—Å—Ç—å service_id - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –°–†–ê–ó–£ –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
  // –ò–Ω–∞—á–µ - –æ–±—â—É—é —Ñ–æ—Ä–º—É
  let url;
  if (serviceId && serviceId !== 'None' && serviceId !== '' && serviceId !== 'null') {
    // –ü—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É –≤—Ä–µ–º–µ–Ω–∏
    url = `https://n951024.yclients.com/company/${companyId}/personal/select_time?o=s${serviceId}`;
    console.log("   ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –∫ –≤—ã–±–æ—Ä—É –≤—Ä–µ–º–µ–Ω–∏");
    console.log("   ‚úÖ Service ID:", serviceId);
  } else {
    // –û–±—â–∞—è —Ñ–æ—Ä–º–∞ (–µ—Å–ª–∏ service_id –Ω–µ —É–∫–∞–∑–∞–Ω)
    url = `https://n951024.yclients.com/company/${companyId}`;
    console.log("   ‚ÑπÔ∏è Service ID –Ω–µ —É–∫–∞–∑–∞–Ω - –æ–±—â–∞—è —Ñ–æ—Ä–º–∞");
  }
  
  // –õ–æ–≥–∏—Ä—É–µ–º
  console.log("=== –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ===");
  console.log("   –£—Å–ª—É–≥–∞:", serviceName);
  console.log("   –î–µ—Ç–∞–ª–∏:", details);
  console.log("   URL:", url);
  console.log("===================================");
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ iframe
  document.getElementById('yclients-iframe').src = url;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  document.getElementById('yclients-modal').style.display = 'block';
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª body
  document.body.style.overflow = 'hidden';
}

function closeYClientsModal() {
  document.getElementById('yclients-modal').style.display = 'none';
  document.getElementById('yclients-iframe').src = '';
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
  document.body.style.overflow = '';
  
  console.log("‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ");
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
document.getElementById('yclients-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeYClientsModal();
  }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('yclients-modal');
    if (modal.style.display === 'block') {
      closeYClientsModal();
    }
  }
});
</script>

{% endblock %}