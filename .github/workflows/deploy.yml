name: CI/CD to VPS (SSH)  # имя pipeline — видно во вкладке Actions

on:
  push:
    branches: [ main ]    # запускать при пуше в main

jobs:
  test-and-deploy:         # имя job (набора шагов)
    runs-on: ubuntu-latest # где крутится job — GitHub runner Ubuntu

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # Скачивает код репозитория в раннер (временную машину GitHub)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
        # Ставит Python на раннере (для локальных тестов/линтов на CI)

      - name: Install deps (CI)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # Устанавливаем зависимости, чтобы (при желании) гонять тесты на CI

      - name: Run tests (optional)
        run: |
          python -m pip install pytest
          pytest -q
        continue-on-error: true
        # Тесты помечены как optional (не валят деплой, если упали).
        # Убери continue-on-error, если хочешь "жёсткую" проверку.

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}       # напр. formulatela58.ru
          username: ${{ secrets.SSH_USER }}   # taximeter
          port: ${{ secrets.SSH_PORT }}       # 22
          key: ${{ secrets.SSH_KEY }}         # приватный ключ из Secrets
          script: |
            set -euo pipefail
            REPO_DIR="${{ secrets.REPO_DIR }}"  # /home/taximeter/mysite/formula_tela
            APP_DIR="${{ secrets.APP_DIR }}"    # /home/taximeter/mysite/formula_tela/mysite
            VENV="${{ secrets.VENV }}"          # /home/taximeter/mysite/formula_tela/.venv312

            # 0) Убедимся, что git установлен
            command -v git || (sudo apt-get update && sudo apt-get install -y git)

            # 1) Обновляем код на сервере
            if [ -d "$REPO_DIR/.git" ]; then
              cd "$REPO_DIR"
              git fetch --all
              git reset --hard origin/main
            else
              mkdir -p "$REPO_DIR"
              git clone --depth 1 https://github.com/${{ github.repository }} "$REPO_DIR"
              cd "$REPO_DIR"
            fi
            # ВАЖНО: этот clone/fetch по HTTPS сработает, только если репо публичный.
            # Если приватный — переключим remote на SSH и используем Deploy Key (помогу настроить).

            # 2) Python-зависимости в твоём серверном venv
            source "$VENV/bin/activate"
            pip install -r "$REPO_DIR/requirements.txt"

            # 3) Django-команды (запускаем из папки, где лежит manage.py)
            export DJANGO_SETTINGS_MODULE=${{ secrets.DJANGO_SETTINGS_MODULE }}  # mysite.settings
            cd "$APP_DIR"
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput
            python manage.py check --deploy || true  # полезные предупреждения, но не валим деплой

            # 4) Перезапуск Gunicorn-сервиса
            sudo systemctl restart ${SERVICE_NAME:-formula_tela}

            # 5) (Опционально) Health-check (если добавишь /healthz)
            # curl -fsS https://formulatela58.ru/healthz || (journalctl -u ${SERVICE_NAME:-formula_tela} -n 200 --no-pager; exit 1)
